<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - Home</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <div class="logo">üèè</div>
    <h1>HandiCricket</h1>
    
    <div id="login-section">
      <div class="input-group">
        <label for="teamName">Your Team Name</label>
        <input type="text" id="teamName" placeholder="Enter your team name">
      </div>
      <button id="loginBtn" class="btn btn-create">Login</button>
    </div>
    
    <div id="main-menu" style="display: none;">
      <div class="tabs">
        <div class="tab active" data-tab="create">Create Game</div>
        <div class="tab" data-tab="join">Join Game</div>
        <div class="tab" data-tab="leaderboard">Leaderboard</div>
        <div class="tab" data-tab="squad">My Squad</div>
      </div>
      
      <div class="tab-content active" id="create-tab">
        <div class="input-group">
          <label>Match Format</label>
          <div class="format-options">
            <div class="format-card selected" data-format="5">
              <h3>T5 (5 Overs)</h3>
              <p>Quick 30-minute match</p>
            </div>
            <div class="format-card" data-format="10">
              <h3>T10 (10 Overs)</h3>
              <p>Standard 1-hour match</p>
            </div>
            <div class="format-card" data-format="20">
              <h3>T20 (20 Overs)</h3>
              <p>Classic 2-hour match</p>
            </div>
            <div class="format-card" data-format="50">
              <h3>ODI (50 Overs)</h3>
              <p>Full day challenge</p>
            </div>
          </div>
        </div>
        
        <button id="createGameBtn" class="btn btn-create">Create New Match</button>
        <div class="room-code-display" id="roomCodeDisplay" style="display: none;">
          Share this code to join: <span class="room-code" id="roomCodeSpan"></span>
        </div>
      </div>
      
      <div class="tab-content" id="join-tab">
        <div class="input-group">
          <label for="roomCode">Room Code</label>
          <input type="text" id="roomCode" placeholder="Enter 4-digit room code" maxlength="4">
        </div>
        <button id="joinGameBtn" class="btn btn-join">Join Match</button>
      </div>
      
      <div class="tab-content" id="leaderboard-tab">
        <div class="leaderboard-container">
          <h3>Top Teams</h3>
          <div id="teamsLeaderboard" class="leaderboard"></div>
          
          <h3>Top Batsmen</h3>
          <div id="batsmenLeaderboard" class="leaderboard"></div>
          
          <h3>Top Bowlers</h3>
          <div id="bowlersLeaderboard" class="leaderboard"></div>
        </div>
      </div>
      
      <div class="tab-content" id="squad-tab">
        <div class="squad-management">
          <h3>My Squad (30 Players)</h3>
          <div class="player-search">
            <input type="text" id="playerSearch" placeholder="Search players...">
            <button id="searchBtn">Search</button>
          </div>
          <div id="searchResults" class="player-list"></div>
          
          <h4>Current Squad</h4>
          <div id="currentSquad" class="player-list"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db, ref, set, update, get, remove, auth, signInAnonymously, onAuthStateChanged } from './firebase.js';

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
      });
    });
    
    // Format selection
    let selectedFormat = '5';
    document.querySelectorAll('.format-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('.format-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        selectedFormat = card.dataset.format;
      });
    });
    
    // User authentication and team setup
    let currentUser = null;
    let currentTeam = null;
    
    // Initialize auth state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        const teamSnap = await get(ref(db, `users/${user.uid}/team`));
        if (teamSnap.exists()) {
          currentTeam = teamSnap.val().name;
          document.getElementById('login-section').style.display = 'none';
          document.getElementById('main-menu').style.display = 'block';
          loadLeaderboards();
          loadSquad();
        }
      }
    });

    // Login button - Fixed version
    document.getElementById('loginBtn').addEventListener('click', async function() {
      const teamName = document.getElementById('teamName').value.trim();
      if (!teamName) {
        alert('Please enter your team name');
        return;
      }
      
      try {
        // First sign in anonymously
        const userCredential = await signInAnonymously(auth);
        const user = userCredential.user;
        
        // Check if team name already exists
        const teamSnap = await get(ref(db, `teams/${teamName}`));
        if (teamSnap.exists()) {
          alert('Team name already taken! Please choose another name.');
          return;
        }
        
        // Create team data
        const teamData = {
          name: teamName,
          createdAt: Date.now(),
          matchesPlayed: 0,
          matchesWon: 0
        };
        
        // Save all data in parallel
        await Promise.all([
          set(ref(db, `users/${user.uid}/team`), teamData),
          set(ref(db, `teams/${teamName}`), {
            ...teamData,
            owner: user.uid,
            totalRuns: 0,
            totalWickets: 0
          }),
          set(ref(db, `users/${user.uid}/squad`), {
            // Default squad players
            'player1': { id: 'player1', name: 'Player 1', role: 'batsman' },
            'player2': { id: 'player2', name: 'Player 2', role: 'bowler' }
          })
        ]);
        
        currentTeam = teamName;
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('main-menu').style.display = 'block';
        loadLeaderboards();
        loadSquad();
      } catch (error) {
        console.error("Login error:", error);
        alert("Failed to login. Please try again.");
      }
    });

    // Create game
    document.getElementById('createGameBtn').addEventListener('click', async function() {
      if (!currentTeam || !currentUser) {
        alert('Please login first');
        return;
      }
      
      // Generate a random 4-digit room code
      const roomCode = Math.floor(1000 + Math.random() * 9000).toString();
      
      // Show room code
      document.getElementById('roomCodeSpan').textContent = roomCode;
      document.getElementById('roomCodeDisplay').style.display = 'block';
      
      try {
        // Create room in Firebase
        await set(ref(db, `rooms/${roomCode}`), {
          player1: {
            name: currentTeam,
            connected: true,
            team: currentTeam,
            format: selectedFormat,
            userId: currentUser.uid
          },
          createdAt: Date.now(),
          status: 'waiting'
        });
        
        // Redirect to toss page after short delay
        setTimeout(() => {
          window.location.href = `toss.html?room=${roomCode}&player=player1&format=${selectedFormat}`;
        }, 1000);
      } catch (error) {
        console.error("Error creating room:", error);
        alert("Failed to create room. Please try again.");
      }
    });
    
    // Join game
    document.getElementById('joinGameBtn').addEventListener('click', async function() {
      if (!currentTeam || !currentUser) {
        alert('Please login first');
        return;
      }
      
      const roomCode = document.getElementById('roomCode').value.trim();
      
      if (!roomCode || roomCode.length !== 4 || isNaN(roomCode)) {
        alert('Please enter a valid 4-digit room code');
        return;
      }
      
      try {
        // Check if room exists
        const roomSnap = await get(ref(db, `rooms/${roomCode}`));
        if (!roomSnap.exists()) {
          alert('Room not found');
          return;
        }
        
        // Check if room already has two players
        if (roomSnap.val().player2) {
          alert('Room is full');
          return;
        }
        
        // Join room
        await update(ref(db, `rooms/${roomCode}`), {
          player2: {
            name: currentTeam,
            connected: true,
            team: currentTeam,
            userId: currentUser.uid
          },
          status: 'ready'
        });
        
        // Redirect to toss page
        window.location.href = `toss.html?room=${roomCode}&player=player2`;
      } catch (error) {
        console.error("Error joining room:", error);
        alert("Failed to join room. Please check the room code and try again.");
      }
    });
    
    // Load leaderboards
    async function loadLeaderboards() {
      try {
        // Load teams leaderboard
        const teamsSnap = await get(ref(db, 'teams'));
        if (teamsSnap.exists()) {
          const teams = Object.entries(teamsSnap.val())
            .sort((a, b) => b[1].matchesWon - a[1].matchesWon)
            .slice(0, 5);
          
          document.getElementById('teamsLeaderboard').innerHTML = teams
            .map(([id, team]) => `<div>${team.name}: ${team.matchesWon} wins</div>`)
            .join('');
        }
        
        // Load players leaderboard (simplified example)
        document.getElementById('batsmenLeaderboard').innerHTML = `
          <div>Virat Kohli: 1200 runs</div>
          <div>Joe Root: 1100 runs</div>
          <div>Kane Williamson: 1050 runs</div>
          <div>Steve Smith: 980 runs</div>
          <div>Babar Azam: 950 runs</div>
        `;
        
        document.getElementById('bowlersLeaderboard').innerHTML = `
          <div>Jasprit Bumrah: 50 wickets</div>
          <div>Pat Cummins: 45 wickets</div>
          <div>Kagiso Rabada: 42 wickets</div>
          <div>Trent Boult: 40 wickets</div>
          <div>Mitchell Starc: 38 wickets</div>
        `;
      } catch (error) {
        console.error("Error loading leaderboards:", error);
      }
    }
    
    // Squad management
    async function loadSquad() {
      try {
        const squadSnap = await get(ref(db, `users/${currentUser.uid}/squad`));
        if (squadSnap.exists()) {
          document.getElementById('currentSquad').innerHTML = Object.entries(squadSnap.val())
            .map(([id, player]) => `
              <div>
                ${player.name} (${player.role}) 
                <button onclick="removeFromSquad('${id}')">√ó</button>
              </div>
            `)
            .join('');
        }
      } catch (error) {
        console.error("Error loading squad:", error);
      }
    }
    
    // Search players
    document.getElementById('searchBtn').addEventListener('click', async function() {
      const query = document.getElementById('playerSearch').value.trim().toLowerCase();
      if (!query) return;
      
      try {
        const playersSnap = await get(ref(db, 'players'));
        if (playersSnap.exists()) {
          const results = Object.entries(playersSnap.val())
            .filter(([id, player]) => player.name.toLowerCase().includes(query))
            .slice(0, 10);
          
          document.getElementById('searchResults').innerHTML = results
            .map(([id, player]) => `
              <div>
                ${player.name} (${player.role}) 
                <button onclick="addToSquad('${id}', '${player.name}', '${player.role}')">+</button>
              </div>
            `)
            .join('');
        }
      } catch (error) {
        console.error("Error searching players:", error);
      }
    });
    
    // Make functions available globally
    window.addToSquad = async function(playerId, playerName, playerRole) {
      if (!currentUser) return;
      
      try {
        const squadRef = ref(db, `users/${currentUser.uid}/squad/${playerId}`);
        await set(squadRef, {
          id: playerId,
          name: playerName,
          role: playerRole,
          runs: 0,
          wickets: 0,
          matches: 0
        });
        
        loadSquad();
      } catch (error) {
        console.error("Error adding to squad:", error);
        alert("Failed to add player to squad");
      }
    };
    
    window.removeFromSquad = async function(playerId) {
      if (!currentUser) return;
      
      try {
        await remove(ref(db, `users/${currentUser.uid}/squad/${playerId}`));
        loadSquad();
      } catch (error) {
        console.error("Error removing from squad:", error);
        alert("Failed to remove player from squad");
      }
    };
  </script>
</body>
</html>
