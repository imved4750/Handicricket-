<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HandiCricket - First Innings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
      --primary-blue: #061e3e;
      --secondary-blue: #1e3d8b;
      --accent-yellow: #ffeb3b;
      --red: #e53935;
      --green: #4caf50;
      --orange: #ff9800;
      --purple: #9c27b0;
      --white: #ffffff;
      --black: #000000;
      --gray: #cccccc;
      --dark-gray: #333333;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body { 
      background: var(--primary-blue); 
      color: var(--white); 
      font-family: 'Roboto', sans-serif;
      text-align: center; 
      padding: 0;
      margin: 0;
      overflow-x: hidden;
      position: relative;
    }
    
    /* Stadium Background */
    .stadium-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), 
                  url('https://images.unsplash.com/photo-1540747913346-19e32dc3e97e') no-repeat center center;
      background-size: cover;
      z-index: -1;
      opacity: 0.8;
    }
    
    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: rgba(0,0,0,0.7);
      border-bottom: 1px solid var(--secondary-blue);
    }
    
    .header-title {
      font-size: 1.2rem;
      font-weight: 500;
      color: var(--accent-yellow);
    }
    
    .header-logo {
      font-weight: bold;
      color: var(--white);
      background: var(--secondary-blue);
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    /* Mini Floating Scorecard */
    .mini-scorecard {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      border-radius: 8px;
      padding: 8px 15px;
      border: 1px solid var(--secondary-blue);
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      z-index: 50;
      display: flex;
      gap: 15px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .mini-scorecard.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .mini-scorecard-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .mini-scorecard-runs {
      font-weight: bold;
      color: var(--accent-yellow);
    }
    
    .mini-scorecard-overs {
      color: var(--gray);
      font-size: 0.8rem;
    }
    
    /* Main Container */
    .container {
      max-width: 100%;
      width: 100%;
      margin: 0 auto;
      padding: 10px;
      position: relative;
    }
    
    /* Scoreboard */
    .scoreboard {
      background: rgba(0, 0, 0, 0.7);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid var(--secondary-blue);
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    .team-score {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    .team-name {
      font-weight: 500;
      font-size: 1rem;
    }
    
    .team-runs {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .score-details {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: var(--gray);
    }
    
    /* Match Info */
    .match-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      margin-bottom: 10px;
      color: var(--gray);
    }
    
    /* Over Progress */
    .over-progress {
      background: rgba(0,0,0,0.5);
      padding: 8px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .over-title {
      font-size: 0.8rem;
      color: var(--gray);
      margin-bottom: 5px;
      text-align: left;
    }
    
    .balls-container {
      display: flex;
      gap: 5px;
      justify-content: center;
    }
    
    .ball {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .ball.dot {
      background: var(--dark-gray);
      color: var(--white);
    }
    
    .ball.run {
      background: var(--green);
      color: var(--white);
    }
    
    .ball.wicket {
      background: var(--red);
      color: var(--white);
    }
    
    .ball.wide {
      background: var(--orange);
      color: var(--white);
    }
    
    .ball.noball {
      background: var(--purple);
      color: var(--white);
    }
    
    .ball.empty {
      background: rgba(255,255,255,0.1);
      border: 1px dashed rgba(255,255,255,0.3);
    }
    
    /* Card Buttons */
    .card-btns { 
      margin: 15px auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    
    .card-btns button { 
      width: 55px;
      height: 55px;
      font-size: 20px;
      border-radius: 10px;
      border: none;
      background: var(--secondary-blue);
      color: var(--white);
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: all 0.2s;
      font-weight: bold;
    }
    
    .card-btns button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0,0,0,0.4);
    }
    
    .card-btns button:active {
      transform: translateY(1px);
    }
    
    .card-btns button:disabled { 
      background: var(--dark-gray);
      color: var(--gray);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .card-btns button.selected {
      background: var(--green);
      border: 2px solid var(--accent-yellow);
      transform: scale(1.05);
    }
    
    /* Status Indicators */
    .status-indicators {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    
    .status-indicator {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    .free-hit {
      background: var(--green);
      color: var(--white);
    }
    
    .powerplay {
      background: var(--accent-yellow);
      color: var(--black);
    }
    
    .dead-over {
      background: var(--red);
      color: var(--white);
    }
    
    /* Result Display */
    .result-display {
      font-size: 1rem;
      margin: 10px 0;
      padding: 8px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
      border-left: 3px solid var(--secondary-blue);
    }
    
    .result-display.error {
      border-left-color: var(--red);
    }
    
    /* Controls */
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    
    .control-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
      font-weight: 500;
    }
    
    .save-btn { 
      background: var(--orange);
      color: var(--white);
    }
    
    .exit-btn { 
      background: var(--red);
      color: var(--white);
    }
    
    .reset-btn { 
      background: var(--purple);
      color: var(--white);
    }
    
    .teams-btn {
      background: var(--secondary-blue);
      color: var(--white);
    }
    
    /* Connection Status */
    .connection-status {
      padding: 8px;
      border-radius: 6px;
      text-align: center;
      margin: 10px auto;
      max-width: 250px;
      font-weight: bold;
      font-size: 0.8rem;
    }
    
    .online { 
      background: var(--green);
      color: var(--white);
    }
    
    .offline { 
      background: var(--red);
      color: var(--white);
    }
    
    /* Selection Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      background: var(--primary-blue);
      border-radius: 10px;
      padding: 15px;
      border: 1px solid var(--secondary-blue);
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--secondary-blue);
    }
    
    .modal-title {
      font-size: 1.2rem;
      color: var(--accent-yellow);
    }
    
    .close-modal {
      background: var(--red);
      color: var(--white);
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .player-list {
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .player-item {
      padding: 10px;
      margin: 5px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }
    
    .player-item:hover {
      background: rgba(30, 136, 229, 0.4);
    }
    
    .player-item.selected {
      background: rgba(13, 71, 161, 0.6);
      border-left: 3px solid var(--accent-yellow);
    }
    
    .player-name {
      font-weight: 500;
    }
    
    .player-stats {
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    .confirm-btn {
      width: 100%;
      padding: 10px;
      margin-top: 15px;
      background: var(--green);
      color: var(--white);
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .confirm-btn:hover {
      background: #388E3C;
    }
    
    /* Teams Modal */
    .teams-container {
      width: 100%;
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      gap: 0;
    }
    
    .team-slide {
      min-width: 100%;
      scroll-snap-align: start;
      padding: 10px;
    }
    
    .team-title {
      text-align: center;
      margin-bottom: 10px;
      color: var(--accent-yellow);
      font-size: 1.1rem;
      padding-bottom: 5px;
      border-bottom: 1px solid var(--secondary-blue);
    }
    
    .team-players {
      list-style: none;
    }
    
    .team-player {
      padding: 8px;
      margin: 5px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      border-left: 2px solid var(--secondary-blue);
    }
    
    /* Team Navigation */
    .team-nav {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }
    
    .nav-btn {
      padding: 5px 10px;
      background: var(--secondary-blue);
      color: var(--white);
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .nav-btn:disabled {
      background: var(--dark-gray);
      cursor: not-allowed;
    }
    
    .nav-dots {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
    }
    
    .nav-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--dark-gray);
      cursor: pointer;
    }
    
    .nav-dot.active {
      background: var(--secondary-blue);
    }
    
    /* Commentary */
    .commentary-container {
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
      margin: 10px 0;
      border: 1px solid var(--secondary-blue);
    }
    
    .commentary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: rgba(30, 136, 229, 0.3);
      border-bottom: 1px solid var(--secondary-blue);
    }
    
    .commentary-title {
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .commentary-controls {
      display: flex;
      gap: 5px;
    }
    
    .commentary-btn {
      padding: 3px 8px;
      background: rgba(255,255,255,0.1);
      border: none;
      color: var(--white);
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
    }
    
    .commentary-box {
      max-height: 150px;
      overflow-y: auto;
      padding: 8px;
      font-size: 0.85rem;
    }
    
    .commentary-item {
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      text-align: left;
      animation: fadeIn 0.3s ease-in;
    }
    
    .commentary-time {
      color: var(--gray);
      font-size: 0.7rem;
      margin-right: 5px;
    }
    
    .commentary-item.wicket {
      color: var(--red);
    }
    
    .commentary-item.boundary {
      color: var(--accent-yellow);
    }
    
    .commentary-item.milestone {
      color: var(--green);
    }
    
    /* Timeline */
    .timeline-container {
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid var(--secondary-blue);
    }
    
    .timeline-title {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 8px;
      text-align: left;
    }
    
    .timeline {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding-bottom: 5px;
    }
    
    .timeline-item {
      min-width: 80px;
      padding: 6px;
      border-radius: 4px;
      background: rgba(30, 136, 229, 0.2);
      font-size: 0.75rem;
      text-align: center;
      flex-shrink: 0;
    }
    
    .timeline-over {
      font-weight: bold;
      margin-bottom: 3px;
    }
    
    .timeline-event {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .timeline-item.wicket {
      background: rgba(244, 67, 54, 0.2);
      border-left: 2px solid var(--red);
    }
    
    .timeline-item.boundary {
      background: rgba(255, 193, 7, 0.2);
      border-left: 2px solid var(--accent-yellow);
    }
    
    .timeline-item.milestone {
      background: rgba(76, 175, 80, 0.2);
      border-left: 2px solid var(--green);
    }
    
    /* Player Comparison */
    .comparison-container {
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid var(--secondary-blue);
    }
    
    .comparison-title {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 8px;
      text-align: left;
    }
    
    .comparison-box {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    
    .player-comparison {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      text-align: center;
    }
    
    .batter-comparison {
      background: rgba(76, 175, 80, 0.1);
      border-left: 3px solid var(--green);
    }
    
    .bowler-comparison {
      background: rgba(244, 67, 54, 0.1);
      border-left: 3px solid var(--red);
    }
    
    .comparison-header {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--gray);
      margin-bottom: 5px;
    }
    
    .comparison-name {
      font-weight: bold;
      margin: 5px 0;
      font-size: 0.9rem;
    }
    
    .comparison-stats {
      font-size: 0.8rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    
    .comparison-stats div {
      flex: 1;
      min-width: 50%;
      margin: 3px 0;
    }
    
    .vs-circle {
      width: 35px;
      height: 35px;
      background: var(--secondary-blue);
      color: var(--white);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.8rem;
    }
    
    /* Over Summary */
    .over-summary {
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
      margin: 10px 0;
      padding: 10px;
      max-height: 120px;
      overflow-y: auto;
      border: 1px solid var(--secondary-blue);
    }
    
    .over-summary-title {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 8px;
      text-align: left;
    }
    
    .over-summary-item {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 0.8rem;
      text-align: left;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes scoreIncrease {
      0% { transform: scale(1); color: var(--white); }
      50% { transform: scale(1.3); color: var(--green); }
      100% { transform: scale(1); color: var(--white); }
    }
    
    @keyframes wicketFlash {
      0% { background-color: rgba(244, 67, 54, 0); }
      50% { background-color: rgba(244, 67, 54, 0.3); }
      100% { background-color: rgba(244, 67, 54, 0); }
    }
    
    @keyframes boundary {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); color: var(--accent-yellow); }
      100% { transform: scale(1); }
    }
    
    .score-change {
      animation: scoreIncrease 0.8s ease-in-out;
    }
    
    .wicket-flash {
      animation: wicketFlash 1.5s ease-in-out;
    }
    
    .boundary-flash {
      animation: boundary 1s ease-in-out;
    }
    
    /* Loading Spinner */
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid var(--secondary-blue);
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Summary Popup */
    .summary-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 500px;
      background: var(--primary-blue);
      border-radius: 10px;
      padding: 15px;
      z-index: 1001;
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
      border: 1px solid var(--secondary-blue);
      display: none;
    }
    
    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--secondary-blue);
    }
    
    .summary-title {
      font-size: 1.2rem;
      color: var(--accent-yellow);
      font-weight: 500;
    }
    
    .close-summary {
      background: var(--red);
      color: var(--white);
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .summary-content {
      text-align: left;
      margin-bottom: 15px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    
    .summary-label {
      color: var(--gray);
    }
    
    .summary-value {
      font-weight: 500;
    }
    
    .summary-highlight {
      background: rgba(255, 235, 59, 0.2);
      padding: 10px;
      border-radius: 6px;
      margin: 15px 0;
      font-weight: bold;
      text-align: center;
    }
    
    .summary-btn {
      width: 100%;
      padding: 10px;
      background: var(--green);
      color: var(--white);
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .summary-btn:hover {
      background: #388E3C;
    }
    
    /* Match Summary Screen (ICC Style) */
    .match-summary {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--primary-blue);
      z-index: 1002;
      overflow-y: auto;
      padding: 20px;
      display: none;
    }
    
    .match-summary-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--secondary-blue);
    }
    
    .match-summary-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent-yellow);
      margin-bottom: 5px;
    }
    
    .match-summary-subtitle {
      font-size: 1rem;
      color: var(--gray);
    }
    
    .match-summary-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    @media (min-width: 600px) {
      .match-summary-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    .match-summary-panel {
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
      padding: 15px;
      border: 1px solid var(--secondary-blue);
    }
    
    .match-summary-panel-title {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--accent-yellow);
      border-bottom: 1px solid var(--secondary-blue);
      padding-bottom: 5px;
    }
    
    .player-of-match {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .player-of-match-name {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .player-of-match-stats {
      font-size: 1rem;
      color: var(--gray);
    }
    
    .scorecard {
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    .scorecard-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    .scorecard-player {
      flex: 2;
      text-align: left;
    }
    
    .scorecard-stats {
      flex: 1;
      text-align: right;
    }
    
    .scorecard-wicket {
      color: var(--red);
      font-style: italic;
    }
    
    .match-result {
      text-align: center;
      font-weight: bold;
      font-size: 1.3rem;
      margin: 20px 0;
      color: var(--accent-yellow);
    }
    
    .close-summary-btn {
      width: 100%;
      padding: 10px;
      background: var(--red);
      color: var(--white);
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    /* Innings Summary Slider */
    .innings-slider {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--primary-blue);
      z-index: 1003;
      overflow: hidden;
      display: none;
    }
    
    .innings-slider-container {
      width: 100%;
      height: 100%;
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
    
    .innings-slide {
      min-width: 100%;
      height: 100%;
      scroll-snap-align: start;
      padding: 20px;
      overflow-y: auto;
    }
    
    .innings-slide-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--secondary-blue);
    }
    
    .innings-slide-title {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--accent-yellow);
    }
    
    .innings-slide-subtitle {
      font-size: 1rem;
      color: var(--gray);
    }
    
    .innings-batters, .innings-bowlers {
      margin-bottom: 20px;
    }
    
    .innings-section-title {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--accent-yellow);
      border-bottom: 1px solid var(--secondary-blue);
      padding-bottom: 5px;
    }
    
    .innings-player {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .innings-player-name {
      font-weight: 500;
    }
    
    .innings-player-stats {
      color: var(--gray);
    }
    
    .innings-nav {
      position: fixed;
      bottom: 20px;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 15px;
      z-index: 1004;
    }
    
    .innings-nav-btn {
      padding: 8px 15px;
      background: var(--secondary-blue);
      color: var(--white);
      border: none;
      border-radius: 20px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .innings-nav-btn:disabled {
      background: var(--dark-gray);
      cursor: not-allowed;
    }
    
    /* Confetti */
    .confetti {
      position: fixed;
      width: 8px;
      height: 8px;
      background-color: #f00;
      animation: confetti-fall 5s linear forwards;
      z-index: 1000;
    }
    
    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }
    
    /* Notification */
    .notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      color: var(--white);
      padding: 15px 25px;
      border-radius: 8px;
      z-index: 1001;
      font-size: 1rem;
      text-align: center;
      animation: fadeInOut 3s forwards;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }
    
    .notification.batting {
      border-left: 4px solid var(--green);
    }
    
    .notification.error {
      border-left: 4px solid var(--red);
    }
    
    .notification.info {
      border-left: 4px solid var(--accent-yellow);
    }
    
    /* Timeout Button */
    .timeout-btn {
      width: 100%;
      padding: 10px;
      background: var(--orange);
      color: var(--white);
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      margin: 10px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    .timeout-btn:disabled {
      background: var(--dark-gray);
      cursor: not-allowed;
    }
    
    /* Social Features */
    .social-container {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .social-button {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--secondary-blue);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3);
      transition: all 0.3s;
    }
    
    .social-button:hover {
      transform: scale(1.1);
    }
    
    .chat-container {
      position: fixed;
      bottom: 80px;
      left: 20px;
      width: 300px;
      max-height: 400px;
      background: rgba(0,0,0,0.8);
      border-radius: 10px;
      padding: 10px;
      z-index: 101;
      display: none;
      flex-direction: column;
      border: 1px solid var(--secondary-blue);
    }

    /* Chat Header */
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid var(--secondary-blue);
    }
    
    .chat-title {
      font-weight: bold;
    }
    
    .close-chat {
      background: var(--red);
      color: white;
      border: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      cursor: pointer;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 10px;
      font-size: 0.9rem;
    }
    
    .chat-message {
      margin-bottom: 8px;
      padding: 5px;
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
    }
    
    .chat-input {
      display: flex;
      gap: 5px;
    }
    
    .chat-input-field {
      flex: 1;
      padding: 8px;
      border-radius: 5px;
      border: none;
      background: rgba(255,255,255,0.2);
      color: white;
    }
    
    .chat-send-btn {
      padding: 0 10px;
      background: var(--green);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    /* Emoji Picker */
    .emoji-picker {
      position: absolute;
      bottom: 50px;
      left: 0;
      background: rgba(0,0,0,0.9);
      padding: 10px;
      border-radius: 10px;
      display: none;
      flex-wrap: wrap;
      gap: 5px;
      width: 200px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 102;
    }
    
    .emoji-btn {
      font-size: 1.2rem;
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
    }
    
    .emoji-btn:hover {
      transform: scale(1.2);
    }
    
    /* Poll Container */
    .poll-container {
      position: fixed;
      bottom: 80px;
      left: 20px;
      width: 300px;
      background: rgba(0,0,0,0.8);
      border-radius: 10px;
      padding: 10px;
      z-index: 101;
      display: none;
      flex-direction: column;
      border: 1px solid var(--secondary-blue);
    }
    
    .poll-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid var(--secondary-blue);
    }
    
    .poll-title {
      font-weight: bold;
    }
    
    .close-poll {
      background: var(--red);
      color: white;
      border: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      cursor: pointer;
    }
    
    .poll-question {
      margin-bottom: 10px;
    }
    
    .poll-options {
      margin-bottom: 10px;
    }
    
    .poll-option {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    
    .poll-option input {
      margin-right: 8px;
    }
    
    .poll-submit {
      padding: 8px;
      background: var(--green);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    /* Stats Graphs */
    .stats-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 600px;
      background: rgba(0,0,0,0.9);
      border-radius: 10px;
      padding: 15px;
      z-index: 1001;
      display: none;
      flex-direction: column;
      border: 2px solid var(--secondary-blue);
    }
    
    .stats-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--secondary-blue);
    }
    
    .stats-title {
      font-size: 1.2rem;
      color: var(--accent-yellow);
    }
    
    .close-stats {
      background: var(--red);
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
    }
    
    .stats-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
    }
    
    .stats-tab {
      padding: 5px 10px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }
    
    .stats-tab.active {
      background: var(--secondary-blue);
    }
    
    .stats-content {
      height: 300px;
      position: relative;
    }
    
    .stats-graph {
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.05);
      border-radius: 5px;
      display: none;
    }
    
    .stats-graph.active {
      display: block;
    }
    
    /* Spectator Mode */
    .spectator-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--primary-blue);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }
    
    .spectator-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--secondary-blue);
    }
    
    .spectator-title {
      font-size: 1.5rem;
      color: var(--accent-yellow);
      margin-bottom: 5px;
    }
    
    .spectator-subtitle {
      font-size: 1rem;
      color: var(--gray);
    }
    
    .spectator-scoreboard {
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--secondary-blue);
    }
    
    .spectator-teams {
      display: flex;
      justify-content: space-around;
      margin-bottom: 15px;
    }
    
    .spectator-team {
      text-align: center;
      padding: 10px;
    }
    
    .spectator-team-name {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .spectator-team-score {
      font-size: 1.5rem;
    }
    
    .spectator-match-info {
      display: flex;
      justify-content: space-around;
      font-size: 0.9rem;
      color: var(--gray);
    }
    
    .spectator-commentary {
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--secondary-blue);
      max-height: 200px;
      overflow-y: auto;
    }
    
    .spectator-commentary-title {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--accent-yellow);
    }
    
    .spectator-timeline {
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--secondary-blue);
    }
    
    .spectator-timeline-title {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--accent-yellow);
    }
    
    .spectator-poll {
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--secondary-blue);
    }
    
    .spectator-poll-title {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--accent-yellow);
    }
    
    .spectator-poll-options {
      margin: 15px 0;
    }
    
    .spectator-poll-option {
      margin-bottom: 10px;
    }
    
    .spectator-poll-bar {
      height: 20px;
      background: var(--secondary-blue);
      border-radius: 4px;
      margin-top: 5px;
      transition: width 0.5s;
    }
    
    /* Mini Floating Scorecard */
    .mini-scorecard {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      border-radius: 8px;
      padding: 8px 15px;
      border: 1px solid var(--secondary-blue);
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      z-index: 50;
      display: flex;
      gap: 15px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .mini-scorecard.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .mini-scorecard-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .mini-scorecard-runs {
      font-weight: bold;
      color: var(--accent-yellow);
    }
    
    .mini-scorecard-overs {
      color: var(--gray);
      font-size: 0.8rem;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 480px) {
      .card-btns button {
        width: 50px;
        height: 50px;
        font-size: 18px;
      }
      
      .team-runs {
        font-size: 1.3rem;
      }
      
      .ball {
        width: 20px;
        height: 20px;
        font-size: 0.7rem;
      }
      
      .social-container {
        bottom: 10px;
        left: 10px;
      }
      
      .chat-container, .poll-container {
        width: 280px;
        left: 10px;
      }
      
      .spectator-teams {
        flex-direction: column;
      }
      
      .mini-scorecard {
        padding: 6px 10px;
        font-size: 0.8rem;
        gap: 8px;
      }
    }
</style>
</head>
<body>
  <!-- Stadium Background -->
  <div class="stadium-background"></div>
  
  <!-- Mini Floating Scorecard -->
  <div class="mini-scorecard" id="miniScorecard">
    <div class="mini-scorecard-item">
      <span id="miniScoreRuns">0</span>
      <span id="miniScoreWickets">/0</span>
    </div>
    <div class="mini-scorecard-item">
      <span class="mini-scorecard-overs" id="miniScoreOvers">(0.0)</span>
    </div>
    <div class="mini-scorecard-item">
      <span class="mini-scorecard-runs" id="miniScoreRR">RR: 0.00</span>
    </div>
  </div>
  
  <!-- Main Game Container (hidden for spectators) -->
  <div id="gameContainer" class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-title">HandiCricket</div>
      <div class="header-logo">IHCC</div>
    </div>
    
    <!-- Timeout Button -->
    <button id="timeoutBtn" class="timeout-btn" disabled>
      ⏱️ Timeout (1 left)
    </button>
    
    <!-- Scoreboard -->
    <div class="scoreboard">
      <div class="team-score">
        <div class="team-name" id="battingTeamName">Team A</div>
        <div class="team-runs">
          <span id="runs">0</span>/<span id="wickets">0</span>
        </div>
      </div>
      <div class="score-details">
        <div>Overs: <span id="overs">0.0</span></div>
        <div>RR: <span id="runRate">0.00</span></div>
      </div>
    </div>
    
    <!-- Match Info -->
    <div class="match-info">
      <div id="formatDisplay">5 Overs</div>
      <div id="inningsNumber">1st Innings</div>
      <div id="currentTime">14:30</div>
    </div>
    
    <!-- Over Progress -->
    <div class="over-progress">
      <div class="over-title">Current Over</div>
      <div class="balls-container" id="ballsContainer">
        <!-- Balls will be added dynamically -->
      </div>
    </div>
    
    <!-- Status Indicators -->
    <div class="status-indicators">
      <span id="powerplayIndicator" class="status-indicator powerplay" style="display: none;">Powerplay</span>
      <span id="deadOverIndicator" class="status-indicator dead-over" style="display: none;">Dead Over</span>
      <span id="freeHitIndicator" class="status-indicator free-hit" style="display: none;">Free Hit</span>
    </div>
    
    <!-- Role Indicator -->
    <div id="roleText" class="status-indicator" style="background: var(--secondary-blue);">You are Batting</div>
    
    <!-- Result Display -->
    <div id="result" class="result-display">Initializing game...</div>
    
    <!-- Card Buttons -->
    <div class="card-btns" id="cardButtons">
      <button class="btn" data-value="0">0</button>
      <button class="btn" data-value="1">1</button>
      <button class="btn" data-value="2">2</button>
      <button class="btn" data-value="3">3</button>
      <button class="btn" data-value="4">4</button>
      <button class="btn" data-value="5">5</button>
      <button class="btn" data-value="6">6</button>
    </div>
    
    <!-- Player Comparison -->
    <div class="comparison-container">
      <div class="comparison-title">Current Battle</div>
      <div class="comparison-box">
        <div class="player-comparison batter-comparison">
          <div class="comparison-header">Batter</div>
          <div class="comparison-name" id="comparisonBatterName">-</div>
          <div class="comparison-stats">
            <div>Runs: <span id="comparisonBatterRuns">0</span></div>
            <div>Balls: <span id="comparisonBatterBalls">0</span></div>
            <div>SR: <span id="comparisonBatterSR">0.00</span></div>
            <div>4s/6s: <span id="comparisonBatterBoundaries">0/0</span></div>
          </div>
        </div>
        <div class="vs-circle">VS</div>
        <div class="player-comparison bowler-comparison">
          <div class="comparison-header">Bowler</div>
          <div class="comparison-name" id="comparisonBowlerName">-</div>
          <div class="comparison-stats">
            <div>Overs: <span id="comparisonBowlerOvers">0.0</span></div>
            <div>Wkts: <span id="comparisonBowlerWickets">0</span></div>
            <div>ER: <span id="comparisonBowlerER">0.00</span></div>
            <div>Runs: <span id="comparisonBowlerRuns">0</span></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Commentary -->
    <div class="commentary-container">
      <div class="commentary-header">
        <div class="commentary-title">Match Commentary</div>
        <div class="commentary-controls">
          <button id="pauseCommentary">Pause</button>
          <button id="clearCommentary">Clear</button>
        </div>
      </div>
      <div class="commentary-box" id="commentaryBox">
        <!-- Commentary will be added here -->
      </div>
    </div>
    
    <!-- Timeline -->
    <div class="timeline-container">
      <div class="timeline-title">Match Timeline</div>
      <div class="timeline" id="matchTimeline">
        <!-- Timeline items will be added here -->
      </div>
    </div>
    
    <!-- Over Summary -->
    <div class="over-summary">
      <div class="over-summary-title">Over Summary</div>
      <div id="overSummaryList"></div>
    </div>
    
    <!-- Controls -->
    <div class="controls">
      <button id="saveBtn" class="control-btn save-btn">💾 Save</button>
      <button id="exitBtn" class="control-btn exit-btn">🚪 Exit</button>
      <button id="resetPlaysBtn" class="control-btn reset-btn">🔄 Reset</button>
      <button id="showTeamsBtn" class="control-btn teams-btn">👥 Teams</button>
      <button id="showStatsBtn" class="control-btn" style="background: var(--purple);">📊 Stats</button>
    </div>
    
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status online">
      Opponent: Online
    </div>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner"></div>
  </div>
  
  <!-- Spectator Container (hidden for players) -->
  <div id="spectatorContainer" class="spectator-container" style="display: none;">
    <div class="spectator-header">
      <div class="spectator-title">LIVE MATCH VIEWER</div>
      <div class="spectator-subtitle">IHCC HandiCricket</div>
    </div>
    
    <div class="spectator-scoreboard">
      <div class="spectator-teams">
        <div class="spectator-team">
          <div class="spectator-team-name" id="specTeam1Name">Team 1</div>
          <div class="spectator-team-score" id="specTeam1Score">0/0 (0.0)</div>
        </div>
        <div class="spectator-team">
          <div class="spectator-team-name" id="specTeam2Name">Team 2</div>
          <div class="spectator-team-score" id="specTeam2Score">0/0 (0.0)</div>
        </div>
      </div>
      <div class="spectator-match-info">
        <div id="specFormat">5 Overs Match</div>
        <div id="specInnings">1st Innings</div>
        <div id="specTime">14:30</div>
      </div>
    </div>
    
    <div class="spectator-commentary">
      <div class="spectator-commentary-title">LIVE COMMENTARY</div>
      <div id="specCommentary"></div>
    </div>
    
    <div class="spectator-timeline">
      <div class="spectator-timeline-title">MATCH TIMELINE</div>
      <div id="specTimeline"></div>
    </div>
    
    <div class="spectator-poll">
      <div class="spectator-poll-title">FAN POLL</div>
      <div id="specPollQuestion">Who will win this match?</div>
      <div class="spectator-poll-options" id="specPollOptions">
        <!-- Poll options will be added here -->
      </div>
    </div>
  </div>
  
  <!-- Selection Modal -->
  <div id="selectionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="selectionTitle">Select Player</div>
        <button class="close-modal" id="closeSelectionModal">×</button>
      </div>
      <div class="player-list" id="selectionList"></div>
      <button class="confirm-btn" id="confirmSelection">Confirm</button>
    </div>
  </div>
  
  <!-- Teams Modal -->
  <div id="teamsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Teams</div>
        <button class="close-modal" id="closeTeamsModal">×</button>
      </div>
      <div class="teams-container" id="teamsSlider">
        <div class="team-slide">
          <div class="team-title" id="modalTeam1Name">Team 1</div>
          <ul class="team-players" id="modalTeam1Players"></ul>
        </div>
        <div class="team-slide">
          <div class="team-title" id="modalTeam2Name">Team 2</div>
          <ul class="team-players" id="modalTeam2Players"></ul>
        </div>
      </div>
      <div class="team-nav">
        <button class="nav-btn" id="prevTeamBtn" disabled>Previous</button>
        <button class="nav-btn" id="nextTeamBtn">Next</button>
      </div>
      <div class="nav-dots">
        <div class="nav-dot active" data-index="0"></div>
        <div class="nav-dot" data-index="1"></div>
      </div>
    </div>
  </div>
  
  <!-- Summary Popup -->
  <div id="summaryPopup" class="summary-popup">
    <div class="summary-header">
      <div class="summary-title" id="summaryTitle">First Innings Summary</div>
      <button class="close-summary" id="closeSummaryPopup">×</button>
    </div>
    <div class="summary-content">
      <div class="summary-row">
        <span class="summary-label">Total Runs:</span>
        <span class="summary-value" id="summaryTotalRuns">0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Wickets:</span>
        <span class="summary-value" id="summaryWickets">0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Overs:</span>
        <span class="summary-value" id="summaryOvers">0.0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Run Rate:</span>
        <span class="summary-value" id="summaryRunRate">0.00</span>
      </div>
      <div class="summary-highlight" id="summaryHighlight"></div>
      <div class="summary-row" id="targetDisplay" style="display: none;">
        <span class="summary-label">Target:</span>
        <span class="summary-value" id="targetValue">0</span>
      </div>
    </div>
    <button class="summary-btn" id="startSecondInningsBtn">🏏 Start Second Innings</button>
  </div>
  
  <!-- Match Summary Screen -->
  <div id="matchSummary" class="match-summary">
    <div class="match-summary-header">
      <div class="match-summary-title">MATCH SUMMARY</div>
      <div class="match-summary-subtitle">IHCC HandiCricket</div>
    </div>
    
    <div class="player-of-match">
      <div class="player-of-match-name" id="potmName">-</div>
      <div class="player-of-match-stats" id="potmStats">-</div>
    </div>
    
    <div class="match-summary-grid">
      <div class="match-summary-panel">
        <div class="match-summary-panel-title">BATTING CARD</div>
        <div class="scorecard" id="battingCard"></div>
      </div>
      <div class="match-summary-panel">
        <div class="match-summary-panel-title">BOWLING CARD</div>
        <div class="scorecard" id="bowlingCard"></div>
      </div>
    </div>
    
    <div class="match-result" id="matchResult"></div>
    
    <button class="close-summary-btn" id="closeMatchSummary">Close</button>
  </div>
  
  <!-- Innings Summary Slider -->
  <div id="inningsSlider" class="innings-slider">
    <div class="innings-slider-container" id="inningsSliderContainer">
      <!-- Slides will be added dynamically -->
    </div>
    
    <div class="innings-nav">
      <button class="innings-nav-btn" id="prevInningsSlide">Previous</button>
      <button class="innings-nav-btn" id="nextInningsSlide">Next</button>
    </div>
  </div>
  
  <!-- Social Features -->
  <div class="social-container">
    <button class="social-button" id="chatButton">
      <i class="fas fa-comment"></i>
    </button>
    <button class="social-button" id="pollButton">
      <i class="fas fa-poll"></i>
    </button>
    <button class="social-button" id="emojiButton">
      <i class="far fa-smile"></i>
    </button>
  </div>
  
  <!-- Chat Container -->
  <div class="chat-container" id="chatContainer">
    <div class="chat-header">
      <div class="chat-title">Live Chat</div>
      <button class="close-chat" id="closeChat">×</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" class="chat-input-field" id="chatInput" placeholder="Type your message...">
      <button class="chat-send-btn" id="chatSend">Send</button>
    </div>
  </div>
  
  <!-- Emoji Picker -->
  <div class="emoji-picker" id="emojiPicker">
    <!-- Emojis will be added dynamically -->
  </div>
  
  <!-- Poll Container -->
  <div class="poll-container" id="pollContainer">
    <div class="poll-header">
      <div class="poll-title">Match Poll</div>
      <button class="close-poll" id="closePoll">×</button>
    </div>
    <div class="poll-question" id="pollQuestion">Who will win this match?</div>
    <div class="poll-options" id="pollOptions">
      <div class="poll-option">
        <input type="radio" name="pollOption" id="pollOption1" value="Team 1">
        <label for="pollOption1">Team 1</label>
      </div>
      <div class="poll-option">
        <input type="radio" name="pollOption" id="pollOption2" value="Team 2">
        <label for="pollOption2">Team 2</label>
      </div>
    </div>
    <button class="poll-submit" id="pollSubmit">Vote</button>
  </div>
  
  <!-- Stats Graphs -->
  <div class="stats-container" id="statsContainer">
    <div class="stats-header">
      <div class="stats-title">Match Statistics</div>
      <button class="close-stats" id="closeStats">×</button>
    </div>
    <div class="stats-tabs">
      <button class="stats-tab active" data-tab="runs">Runs</button>
      <button class="stats-tab" data-tab="wickets">Wickets</button>
      <button class="stats-tab" data-tab="runrate">Run Rate</button>
    </div>
    <div class="stats-content">
      <div class="stats-graph active" id="runsGraph"></div>
      <div class="stats-graph" id="wicketsGraph"></div>
      <div class="stats-graph" id="runrateGraph"></div>
    </div>
  </div>
  
  <!-- Audio Elements -->
  <audio id="boundarySound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>
  <audio id="wicketSound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-retro-game-over-213.mp3"></audio>
  <audio id="crowdSound" src="https://assets.mixkit.co/sfx/preview/mixkit-crowd-cheering-loop-2293.mp3" loop></audio>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, get, update, push, remove, child } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const room = params.get('room');
    const player = params.get('player');
    
    if (!room || !player) {
      document.getElementById("result").innerHTML = `
        Missing required parameters in URL.<br>
        Please return to the main page and join the game again.
      `;
      document.getElementById("result").className = "error";
      throw new Error("Missing room or player parameters");
    }

    const opponent = player === "player1" ? "player2" : "player1";

    // Firebase references
    const roomRef = ref(db, `rooms/${room}`);
    const playerRef = ref(db, `rooms/${room}/${player}`);
    const opponentRef = ref(db, `rooms/${room}/${opponent}`);
    const playsRef = ref(db, `rooms/${room}/currentPlays`);
    const batterRef = ref(db, `rooms/${room}/currentBatter`);
    const bowlerRef = ref(db, `rooms/${room}/currentBowler`);
    const teamsRef = ref(db, `rooms/${room}/teams`);
    const matchStatsRef = ref(db, `rooms/${room}/matchStats`);
    const firstInningsRef = ref(db, `rooms/${room}/firstInnings`);
    const firstInningsCompletedRef = ref(db, `rooms/${room}/firstInningsCompleted`);
    const secondInningsStartedRef = ref(db, `rooms/${room}/secondInningsStarted`);
    const timeoutRef = ref(db, `rooms/${room}/timeout`);
    const resetRequestRef = ref(db, `rooms/${room}/resetRequest`);
    const chatRef = ref(db, `rooms/${room}/chat`);
    const pollRef = ref(db, `rooms/${room}/poll`);
    const resultRef = ref(db, `rooms/${room}/result`);
    
    // Format rules
    const formatRules = {
      "5": { 
        name: "5 Overs", 
        totalOvers: 5, 
        totalWickets: 10,
        powerplayOvers: 2, 
        powerplayWicketValue: 0.5,
        regularWicketValue: 1.0,
        deadOvers: []
      },
      "10": { 
        name: "10 Overs", 
        totalOvers: 10, 
        totalWickets: 10,
        powerplayOvers: 3, 
        powerplayWicketValue: 0.5,
        regularWicketValue: 1.0,
        deadOvers: []
      },
      "20": { 
        name: "T20", 
        totalOvers: 20, 
        totalWickets: 10,
        powerplayOvers: 6, 
        powerplayWicketValue: 0.5,
        regularWicketValue: 1.0,
        deadOvers: []
      },
      "50": { 
        name: "ODI", 
        totalOvers: 50, 
        totalWickets: 10,
        powerplayOvers: [1,10, 21,30, 41,42], 
        powerplayWicketValue: 0.25,
        regularWicketValue: 0.5,
        deadOvers: [11,20, 31,40]
      }
    };

    // Game state variables
let runs = 0, wickets = 0;
let legalBalls = 0;
let freeHit = false;
let freeHitNextBall = false;
let currentBatter = null;
let currentBowler = null;
let battersUsed = [];
let bowlersUsed = [];
let bowlerOvers = {};
let isBatting = false;
let currentFormat = {};
let isPowerplay = false;
let isDeadOver = false;
let batterWickets = {};
let zerosThisOver = { player1: 0, player2: 0 };
let bowlerRuns = {};
let gameInProgress = true;
let lastOverRuns = 0;
let lastOverWickets = 0;
let lastWicketScore = 0;
let ballByBall = {};
let fallOfWickets = [];
let batterStats = {};
let bowlerStats = {};
let tossWinner = null;
let battingFirst = null;
let batterSelected = false;
let bowlerSelected = false;
let team1Players = [];
let team2Players = [];
let team1Name = "Team 1";
let team2Name = "Team 2";
let batterPenalties = {};
let lastBatterRuns = {};
let resetRequested = false;
let resetRequestedBy = null;
let isResetting = false;
let resetCount = 0;
const MAX_RESETS = 3;
let selectedCardValue = null;
let isProcessingSelection = false;
let overSummaries = [];
let isSpectator = false;
let commentaryPaused = false;
let firstInningsCompleted = false;
let firstInningsData = null;
let target = 0;
let chasingTeam = null;
let secondInningsStarted = false;
let timeoutAvailable = true;
let timeoutActive = false;
let timeoutTimer = null;
let chatMessages = [];
let pollData = null;
let votedInPoll = false;
let emojis = ["😀", "😂", "😍", "😎", "👍", "👎", "🎉", "😢", "🤔", "🔥"];

// DOM elements
const resultEl = document.getElementById("result");
const buttons = document.querySelectorAll(".btn");
const roleText = document.getElementById("roleText");
const selectionModal = document.getElementById("selectionModal");
const selectionTitle = document.getElementById("selectionTitle");
const selectionList = document.getElementById("selectionList");
const confirmSelection = document.getElementById("confirmSelection");
const closeSelectionModal = document.getElementById("closeSelectionModal");
const team1NameEl = document.getElementById("modalTeam1Name");
const team2NameEl = document.getElementById("modalTeam2Name");
const team1PlayersEl = document.getElementById("modalTeam1Players");
const team2PlayersEl = document.getElementById("modalTeam2Players");
const formatDisplay = document.getElementById("formatDisplay");
const saveBtn = document.getElementById("saveBtn");
const exitBtn = document.getElementById("exitBtn");
const resetPlaysBtn = document.getElementById("resetPlaysBtn");
const showTeamsBtn = document.getElementById("showTeamsBtn");
const showStatsBtn = document.getElementById("showStatsBtn");
const teamsModal = document.getElementById("teamsModal");
const closeTeamsModal = document.getElementById("closeTeamsModal");
const teamsSlider = document.getElementById("teamsSlider");
const prevTeamBtn = document.getElementById("prevTeamBtn");
const nextTeamBtn = document.getElementById("nextTeamBtn");
const overSummaryList = document.getElementById("overSummaryList");
const battingTeamName = document.getElementById("battingTeamName");
const commentaryBox = document.getElementById("commentaryBox");
const pauseCommentaryBtn = document.getElementById("pauseCommentary");
const clearCommentaryBtn = document.getElementById("clearCommentary");
const summaryPopup = document.getElementById("summaryPopup");
const closeSummaryPopup = document.getElementById("closeSummaryPopup");
const startSecondInningsBtn = document.getElementById("startSecondInningsBtn");
const summaryTotalRuns = document.getElementById("summaryTotalRuns");
const summaryWickets = document.getElementById("summaryWickets");
const summaryOvers = document.getElementById("summaryOvers");
const summaryRunRate = document.getElementById("summaryRunRate");
const summaryHighlight = document.getElementById("summaryHighlight");
const targetDisplay = document.getElementById("targetDisplay");
const targetValue = document.getElementById("targetValue");
const matchSummary = document.getElementById("matchSummary");
const potmName = document.getElementById("potmName");
const potmStats = document.getElementById("potmStats");
const battingCard = document.getElementById("battingCard");
const bowlingCard = document.getElementById("bowlingCard");
const matchResult = document.getElementById("matchResult");
const closeMatchSummary = document.getElementById("closeMatchSummary");
const inningsSlider = document.getElementById("inningsSlider");
const inningsSliderContainer = document.getElementById("inningsSliderContainer");
const prevInningsSlide = document.getElementById("prevInningsSlide");
const nextInningsSlide = document.getElementById("nextInningsSlide");
const timeoutBtn = document.getElementById("timeoutBtn");
const connectionStatus = document.getElementById("connectionStatus");
const loadingSpinner = document.getElementById("loadingSpinner");
const powerplayIndicator = document.getElementById("powerplayIndicator");
const deadOverIndicator = document.getElementById("deadOverIndicator");
const freeHitIndicator = document.getElementById("freeHitIndicator");
const chatButton = document.getElementById("chatButton");
const pollButton = document.getElementById("pollButton");
const emojiButton = document.getElementById("emojiButton");
const chatContainer = document.getElementById("chatContainer");
const closeChat = document.getElementById("closeChat");
const chatMessagesEl = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatInput");
const chatSend = document.getElementById("chatSend");
const emojiPicker = document.getElementById("emojiPicker");
const pollContainer = document.getElementById("pollContainer");
const closePoll = document.getElementById("closePoll");
const pollQuestion = document.getElementById("pollQuestion");
const pollOptions = document.getElementById("pollOptions");
const pollSubmit = document.getElementById("pollSubmit");
const statsContainer = document.getElementById("statsContainer");
const closeStats = document.getElementById("closeStats");
const statsTabs = document.querySelectorAll(".stats-tab");
const statsGraphs = document.querySelectorAll(".stats-graph");
const boundarySound = document.getElementById("boundarySound");
const wicketSound = document.getElementById("wicketSound");
const crowdSound = document.getElementById("crowdSound");
const gameContainer = document.getElementById("gameContainer");
const spectatorContainer = document.getElementById("spectatorContainer");
const specTeam1Name = document.getElementById("specTeam1Name");
const specTeam2Name = document.getElementById("specTeam2Name");
const specTeam1Score = document.getElementById("specTeam1Score");
const specTeam2Score = document.getElementById("specTeam2Score");
const specFormat = document.getElementById("specFormat");
const specInnings = document.getElementById("specInnings");
const specTime = document.getElementById("specTime");
const specCommentary = document.getElementById("specCommentary");
const specTimeline = document.getElementById("specTimeline");
const specPollQuestion = document.getElementById("specPollQuestion");
const specPollOptions = document.getElementById("specPollOptions");
const miniScorecard = document.getElementById("miniScorecard");
const miniScoreRuns = document.getElementById("miniScoreRuns");
const miniScoreWickets = document.getElementById("miniScoreWickets");
const miniScoreOvers = document.getElementById("miniScoreOvers");
const miniScoreRR = document.getElementById("miniScoreRR");

// Helper functions
function showNotification(message, type = 'info') {
  const notif = document.createElement('div');
  notif.className = `notification ${type}`;
  notif.textContent = message;
  document.body.appendChild(notif);
  
  setTimeout(() => {
    notif.style.opacity = '0';
    setTimeout(() => notif.remove(), 500);
  }, 2500);
}

function playSound(sound) {
  try {
    sound.currentTime = 0;
    sound.play();
  } catch (e) {
    console.log("Audio error:", e);
  }
}

function createConfetti() {
  const colors = ['#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff'];
  for (let i = 0; i < 150; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = `${Math.random() * 100}%`;
    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.width = `${Math.random() * 10 + 5}px`;
    confetti.style.height = `${Math.random() * 10 + 5}px`;
    confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
    confetti.style.animationDelay = `${Math.random() * 0.5}s`;
    document.body.appendChild(confetti);
    setTimeout(() => confetti.remove(), 5000);
  }
}

function disableButtons() {
  buttons.forEach(btn => {
    btn.disabled = true;
  });
  timeoutBtn.disabled = true;
}

function enableButtons() {
  if (isResetting) return;
  
  const canPlay = (isBatting && batterSelected) || (!isBatting && bowlerSelected);
  buttons.forEach(btn => {
    btn.disabled = !canPlay;
  });
  
  timeoutBtn.disabled = !(timeoutAvailable && !timeoutActive && canPlay);
  
  if (canPlay) {
    resultEl.innerText = isBatting ? "Select your shot" : "Select your delivery";
  }
}

function clearCardSelection() {
  buttons.forEach(btn => {
    btn.classList.remove("selected");
  });
  selectedCardValue = null;
  isProcessingSelection = false;
}

function highlightSelectedCard(value) {
  buttons.forEach(btn => {
    const val = parseInt(btn.dataset.value);
    btn.classList.toggle("selected", val === value);
  });
}

function formatWickets(value) {
  const maxWickets = currentFormat.totalWickets;
  const formattedValue = Math.min(value, maxWickets)
    .toFixed(2)
    .replace(/\.00$/, '');
  
  return formattedValue.includes('.') ? formattedValue : parseInt(formattedValue);
}

function getWicketValue() {
  const over = Math.floor(legalBalls / 6);
  
  if (currentFormat.name === "ODI") {
    return isPowerplay ? 0.25 : 0.5;
  }
  
  return isPowerplay ? 0.5 : 1.0;
}

function checkPowerplay() {
  const currentOver = Math.floor(legalBalls / 6);
  
  if (Array.isArray(currentFormat.powerplayOvers)) {
    isPowerplay = currentFormat.powerplayOvers.some(pp => {
      if (Array.isArray(pp)) {
        return currentOver >= pp[0] && currentOver <= pp[1];
      }
      return currentOver === pp;
    });
  } else {
    isPowerplay = currentOver < currentFormat.powerplayOvers;
  }

  powerplayIndicator.style.display = isPowerplay ? "inline-block" : "none";
}

function checkDeadOver() {
  if (!currentFormat.deadOvers || currentFormat.deadOvers.length === 0) {
    isDeadOver = false;
    deadOverIndicator.style.display = "none";
    return;
  }

  const currentOver = Math.floor(legalBalls / 6);
  isDeadOver = currentFormat.deadOvers.some(dead => {
    if (Array.isArray(dead)) {
      return currentOver >= dead[0] && currentOver <= dead[1];
    }
    return currentOver === dead;
  });

  deadOverIndicator.style.display = isDeadOver ? "inline-block" : "none";
}

function updateFreeHitDisplay() {
  freeHitIndicator.style.display = freeHit ? "inline-block" : "none";
}

function updateScoreboard() {
  const wicketsDisplay = formatWickets(wickets);
  
  document.getElementById("runs").textContent = runs;
  document.getElementById("wickets").textContent = wicketsDisplay;
  document.getElementById("overs").textContent = 
    `${Math.floor(legalBalls/6)}.${legalBalls%6}`;
  
  // Update mini scorecard
  miniScoreRuns.textContent = runs;
  miniScoreWickets.textContent = `/${wicketsDisplay}`;
  miniScoreOvers.textContent = `(${Math.floor(legalBalls/6)}.${legalBalls%6})`;
  
  const completedOvers = Math.floor(legalBalls / 6) + (legalBalls % 6) / 10;
  const rr = completedOvers > 0 ? (runs / completedOvers).toFixed(2) : '0.00';
  document.getElementById('runRate').textContent = rr;
  miniScoreRR.textContent = `RR: ${rr}`;
}

function updatePlayerStats() {
  const completedOvers = Math.floor(legalBalls / 6) + (legalBalls % 6) / 10;
  const rr = completedOvers > 0 ? (runs / completedOvers).toFixed(2) : '0.00';
  document.getElementById('runRate').textContent = rr;
  miniScoreRR.textContent = `RR: ${rr}`;
}

function updateOverProgress() {
  const ballsContainer = document.getElementById('ballsContainer');
  ballsContainer.innerHTML = '';
  
  const ballsThisOver = legalBalls % 6;
  for (let i = 0; i < 6; i++) {
    const ballEl = document.createElement('div');
    ballEl.className = 'ball';
    
    if (i < ballsThisOver) {
      const ballData = ballByBall[legalBalls - ballsThisOver + i];
      if (ballData) {
        if (ballData.wicket) {
          ballEl.className += ' wicket';
          ballEl.textContent = 'W';
        } else if (ballData.runs > 0) {
          ballEl.className += ' run';
          ballEl.textContent = ballData.runs;
        } else {
          ballEl.className += ' dot';
          ballEl.textContent = '•';
        }
      }
    } else {
      ballEl.className += ' empty';
    }
    
    ballsContainer.appendChild(ballEl);
  }
}

function updatePartnership() {
  let partnershipRuns = runs - lastWicketScore;
  let partnershipBalls = 0;
  
  for (let i = legalBalls - 1; i >= 0; i--) {
    if (ballByBall[i]?.wicket) break;
    partnershipBalls++;
  }
}

function updateLast5Overs() {
  let last5Runs = 0;
  let last5Wickets = 0;
  let last5Balls = 0;
  
  const startBall = Math.max(0, legalBalls - 30);
  for (let i = startBall; i < legalBalls; i++) {
    if (ballByBall[i]) {
      last5Runs += ballByBall[i].runs;
      if (ballByBall[i].wicket) last5Wickets++;
      last5Balls++;
    }
  }
}

function updateCurrentTime() {
  const now = new Date();
  document.getElementById('currentTime').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function updatePlayerComparison() {
  if (currentBatter) {
    const batter = batterStats[currentBatter] || { runs: 0, balls: 0, fours: 0, sixes: 0 };
    const sr = batter.balls > 0 ? ((batter.runs / batter.balls) * 100).toFixed(2) : '0.00';
    
    document.getElementById('comparisonBatterName').textContent = currentBatter;
    document.getElementById('comparisonBatterRuns').textContent = batter.runs;
    document.getElementById('comparisonBatterBalls').textContent = batter.balls;
    document.getElementById('comparisonBatterSR').textContent = sr;
    document.getElementById('comparisonBatterBoundaries').textContent = `${batter.fours}/${batter.sixes}`;
  }
  
  if (currentBowler) {
    const bowler = bowlerStats[currentBowler] || { wickets: 0, runs: 0, overs: 0 };
    const er = bowler.overs > 0 ? (bowler.runs / bowler.overs).toFixed(2) : '0.00';
    
    document.getElementById('comparisonBowlerName').textContent = currentBowler;
    document.getElementById('comparisonBowlerWickets').textContent = bowler.wickets;
    document.getElementById('comparisonBowlerOvers').textContent = bowler.overs.toFixed(1);
    document.getElementById('comparisonBowlerER').textContent = er;
    document.getElementById('comparisonBowlerRuns').textContent = bowler.runs;
  }
}

function updateAllDisplays() {
  updateScoreboard();
  updatePlayerStats();
  updateOverProgress();
  updatePartnership();
  updateLast5Overs();
  updateCurrentTime();
  updatePlayerComparison();
  
  // Update spectator view
  if (isSpectator) {
    updateSpectatorView();
  }
}

function addCommentary(message, type = '') {
  if (commentaryPaused) return;
  
  const now = new Date();
  const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  
  const commentaryItem = document.createElement('div');
  commentaryItem.className = `commentary-item ${type}`;
  commentaryItem.innerHTML = `<span class="commentary-time">${timeString}</span>${message}`;
  
  commentaryBox.insertBefore(commentaryItem, commentaryBox.firstChild);
  
  if (commentaryBox.children.length > 50) {
    commentaryBox.removeChild(commentaryBox.lastChild);
  }
  
  // Update spectator commentary
  if (isSpectator) {
    const specCommentaryItem = document.createElement('div');
    specCommentaryItem.className = `commentary-item ${type}`;
    specCommentaryItem.innerHTML = `<span class="commentary-time">${timeString}</span>${message}`;
    
    specCommentary.insertBefore(specCommentaryItem, specCommentary.firstChild);
    
    if (specCommentary.children.length > 50) {
      specCommentary.removeChild(specCommentary.lastChild);
    }
  }
}

function addToTimeline(event, type = '') {
  const timeline = document.getElementById('matchTimeline');
  const currentOver = Math.floor(legalBalls / 6);
  const currentBall = (legalBalls % 6) + 1;
  
  const timelineItem = document.createElement('div');
  timelineItem.className = `timeline-item ${type}`;
  timelineItem.innerHTML = `
    <div class="timeline-over">${currentOver}.${currentBall}</div>
    <div class="timeline-event">${event}</div>
  `;
  
  timeline.insertBefore(timelineItem, timeline.firstChild);
  
  if (timeline.children.length > 20) {
    timeline.removeChild(timeline.lastChild);
  }
  
  // Update spectator timeline
  if (isSpectator) {
    const specTimelineItem = document.createElement('div');
    specTimelineItem.className = `timeline-item ${type}`;
    specTimelineItem.innerHTML = `
      <div class="timeline-over">${currentOver}.${currentBall}</div>
      <div class="timeline-event">${event}</div>
    `;
    
    specTimeline.insertBefore(specTimelineItem, specTimeline.firstChild);
    
    if (specTimeline.children.length > 20) {
      specTimeline.removeChild(specTimeline.lastChild);
    }
  }
}

function updateOverSummary() {
  const currentOver = Math.floor(legalBalls / 6);
  if (currentOver > 0 && currentOver > overSummaries.length) {
    const runsThisOver = runs - lastOverRuns;
    const wicketsThisOver = wickets - lastOverWickets;
    const summary = `Over ${currentOver}: ${runsThisOver} runs, ${wicketsThisOver} wickets`;
    overSummaries.push(summary);
    
    const summaryItem = document.createElement("div");
    summaryItem.className = "over-summary-item";
    summaryItem.textContent = summary;
    overSummaryList.appendChild(summaryItem);
    
    overSummaryList.scrollTop = overSummaryList.scrollHeight;
    
    lastOverRuns = runs;
    lastOverWickets = wickets;
  }
}

function showSummaryPopup() {
  summaryPopup.style.display = 'block';
  
  summaryTotalRuns.textContent = runs;
  summaryWickets.textContent = wickets;
  summaryOvers.textContent = `${Math.floor(legalBalls/6)}.${legalBalls%6}`;
  
  const completedOvers = Math.floor(legalBalls / 6) + (legalBalls % 6) / 10;
  const rr = completedOvers > 0 ? (runs / completedOvers).toFixed(2) : '0.00';
  summaryRunRate.textContent = rr;
  
  if (runs >= 200) {
    summaryHighlight.textContent = "Excellent Batting Performance!";
  } else if (runs >= 150) {
    summaryHighlight.textContent = "Good Total Posted!";
  } else if (runs <= 100) {
    summaryHighlight.textContent = "Bowlers Dominated This Innings";
  } else {
    summaryHighlight.textContent = "Competitive Total";
  }
}

function showMatchSummary() {
  // Set player of the match
  const allPlayers = [...team1Players, ...team2Players];
  const potm = allPlayers.reduce((best, player) => {
    const batRuns = batterStats[player]?.runs || 0;
    const bowlWkts = bowlerStats[player]?.wickets || 0;
    const score = batRuns + (bowlWkts * 25);
    return score > best.score ? { player, score } : best;
  }, { player: null, score: 0 });
  
  if (potm.player) {
    potmName.textContent = `${potm.player}`;
    const stats = [];
    if (batterStats[potm.player]?.runs) {
      stats.push(`${batterStats[potm.player].runs} runs`);
    }
    if (bowlerStats[potm.player]?.wickets) {
      stats.push(`${bowlerStats[potm.player].wickets} wickets`);
    }
    potmStats.textContent = stats.join(', ');
  }
  
  // Set batting card
  let battingHTML = '';
  const battingTeam = battingFirst === "player1" ? team1Players : team2Players;
  battingTeam.forEach(player => {
    const stats = batterStats[player] || { runs: 0, balls: 0 };
    const outText = batterWickets[player] >= 1 ? 'out' : 'not out';
    battingHTML += `
      <div class="scorecard-row">
        <div class="scorecard-player">${player}</div>
        <div class="scorecard-stats">${stats.runs} (${stats.balls}) ${outText}</div>
      </div>
    `;
  });
  battingCard.innerHTML = battingHTML;
  
  // Set bowling card
  let bowlingHTML = '';
  const bowlingTeam = battingFirst === "player1" ? team2Players : team1Players;
  bowlingTeam.forEach(player => {
    const stats = bowlerStats[player] || { wickets: 0, runs: 0, overs: 0 };
    bowlingHTML += `
      <div class="scorecard-row">
        <div class="scorecard-player">${player}</div>
        <div class="scorecard-stats">${stats.wickets}/${stats.runs} (${stats.overs.toFixed(1)})</div>
      </div>
    `;
  });
  bowlingCard.innerHTML = bowlingHTML;
  
  // Set match result
  const winner = runs >= target ? battingFirst : (battingFirst === "player1" ? "player2" : "player1");
  const winnerName = winner === "player1" ? team1Name : team2Name;
  const margin = runs >= target ? `${currentFormat.totalWickets - wickets} wickets` : `${target - runs - 1} runs`;
  matchResult.textContent = `${winnerName} WON BY ${margin.toUpperCase()}`;
  
  matchSummary.style.display = 'block';
}

function createInningsSlides() {
  inningsSliderContainer.innerHTML = '';
  
  // First innings slide
  const firstInningsSlide = document.createElement('div');
  firstInningsSlide.className = 'innings-slide';
  firstInningsSlide.innerHTML = `
    <div class="innings-slide-header">
      <div class="innings-slide-title">FIRST INNINGS</div>
      <div class="innings-slide-subtitle">${team1Name} vs ${team2Name}</div>
    </div>
    
    <div class="innings-batters">
      <div class="innings-section-title">BATTING</div>
      ${team1Players.map(player => {
        const stats = batterStats[player] || { runs: 0, balls: 0 };
        const outText = batterWickets[player] >= 1 ? 'out' : 'not out';
        return `
          <div class="innings-player">
            <div class="innings-player-name">${player}</div>
            <div class="innings-player-stats">${stats.runs} (${stats.balls}) ${outText}</div>
          </div>
        `;
      }).join('')}
    </div>
    
    <div class="innings-bowlers">
      <div class="innings-section-title">BOWLING</div>
      ${team2Players.map(player => {
        const stats = bowlerStats[player] || { wickets: 0, runs: 0, overs: 0 };
        return `
          <div class="innings-player">
            <div class="innings-player-name">${player}</div>
            <div class="innings-player-stats">${stats.wickets}/${stats.runs} (${stats.overs.toFixed(1)})</div>
          </div>
        `;
      }).join('')}
    </div>
  `;
  inningsSliderContainer.appendChild(firstInningsSlide);
  
  // Second innings slide
  const secondInningsSlide = document.createElement('div');
  secondInningsSlide.className = 'innings-slide';
  secondInningsSlide.innerHTML = `
    <div class="innings-slide-header">
      <div class="innings-slide-title">SECOND INNINGS</div>
      <div class="innings-slide-subtitle">Target: ${target}</div>
    </div>
    
    <div class="innings-batters">
      <div class="innings-section-title">BATTING</div>
      ${team2Players.map(player => {
        const stats = batterStats[player] || { runs: 0, balls: 0 };
        const outText = batterWickets[player] >= 1 ? 'out' : 'not out';
        return `
          <div class="innings-player">
            <div class="innings-player-name">${player}</div>
            <div class="innings-player-stats">${stats.runs} (${stats.balls}) ${outText}</div>
          </div>
        `;
      }).join('')}
    </div>
    
    <div class="innings-bowlers">
      <div class="innings-section-title">BOWLING</div>
      ${team1Players.map(player => {
        const stats = bowlerStats[player] || { wickets: 0, runs: 0, overs: 0 };
        return `
          <div class="innings-player">
            <div class="innings-player-name">${player}</div>
            <div class="innings-player-stats">${stats.wickets}/${stats.runs} (${stats.overs.toFixed(1)})</div>
          </div>
        `;
      }).join('')}
    </div>
  `;
  inningsSliderContainer.appendChild(secondInningsSlide);
  
  // Match summary slide
  const summarySlide = document.createElement('div');
  summarySlide.className = 'innings-slide';
  summarySlide.innerHTML = `
    <div class="innings-slide-header">
      <div class="innings-slide-title">MATCH SUMMARY</div>
      <div class="innings-slide-subtitle">IHCC HandiCricket</div>
    </div>
    
    <div class="player-of-match">
      <div class="player-of-match-name" id="slidePotmName">-</div>
      <div class="player-of-match-stats" id="slidePotmStats">-</div>
    </div>
    
    <div class="match-result">
      ${matchResult.textContent}
    </div>
    
    <div class="innings-section-title">FIRST INNINGS</div>
    <div class="innings-player">
      <div class="innings-player-name">${team1Name}</div>
      <div class="innings-player-stats">${firstInningsData.totalRuns}/${firstInningsData.totalWickets} (${Math.floor(firstInningsData.balls/6)}.${firstInningsData.balls%6})</div>
    </div>
    
    <div class="innings-section-title">SECOND INNINGS</div>
    <div class="innings-player">
      <div class="innings-player-name">${team2Name}</div>
      <div class="innings-player-stats">${runs}/${wickets} (${Math.floor(legalBalls/6)}.${legalBalls%6})</div>
    </div>
  `;
  
  // Set player of the match in slide
  const potm = [...team1Players, ...team2Players].reduce((best, player) => {
    const batRuns = batterStats[player]?.runs || 0;
    const bowlWkts = bowlerStats[player]?.wickets || 0;
    const score = batRuns + (bowlWkts * 25);
    return score > best.score ? { player, score } : best;
  }, { player: null, score: 0 });
  
  if (potm.player) {
    summarySlide.querySelector('#slidePotmName').textContent = potm.player;
    const stats = [];
    if (batterStats[potm.player]?.runs) {
      stats.push(`${batterStats[potm.player].runs} runs`);
    }
    if (bowlerStats[potm.player]?.wickets) {
      stats.push(`${bowlerStats[potm.player].wickets} wickets`);
    }
    summarySlide.querySelector('#slidePotmStats').textContent = stats.join(', ');
  }
  
  inningsSliderContainer.appendChild(summarySlide);
  
  // Show slider
  inningsSlider.style.display = 'block';
  
  // Setup navigation
  let currentSlide = 0;
  const slides = document.querySelectorAll('.innings-slide');
  
  function updateSlider() {
    inningsSliderContainer.scrollTo({
      left: currentSlide * window.innerWidth,
      behavior: 'smooth'
    });
    
    prevInningsSlide.disabled = currentSlide === 0;
    nextInningsSlide.disabled = currentSlide === slides.length - 1;
  }
  
  prevInningsSlide.addEventListener('click', () => {
    if (currentSlide > 0) {
      currentSlide--;
      updateSlider();
    }
  });
  
  nextInningsSlide.addEventListener('click', () => {
    if (currentSlide < slides.length - 1) {
      currentSlide++;
      updateSlider();
    }
  });
  
  // Touch/swipe support
  let touchStartX = 0;
  let touchEndX = 0;
  
  inningsSliderContainer.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
  });
  
  inningsSliderContainer.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  });
  
  function handleSwipe() {
    const threshold = 50;
    if (touchEndX < touchStartX - threshold) {
      // Swipe left
      if (currentSlide < slides.length - 1) {
        currentSlide++;
        updateSlider();
      }
    } else if (touchEndX > touchStartX + threshold) {
      // Swipe right
      if (currentSlide > 0) {
        currentSlide--;
        updateSlider();
      }
    }
  }
}

async function loadPlaying11() {
  try {
    resultEl.innerText = "Loading teams...";
    
    const roomSnap = await get(roomRef);
    if (!roomSnap.exists()) throw new Error("Room not found");

    const teams = roomSnap.val().teams;
    if (!teams?.player1 || !teams?.player2) {
      throw new Error("Both teams must be submitted before starting");
    }

    team1Players = [];
    team2Players = [];
    team1PlayersEl.innerHTML = '';
    team2PlayersEl.innerHTML = '';

    if (teams.player1?.players) {
      team1Name = teams.player1.name || "Team 1";
      team1NameEl.textContent = team1Name;
      battingTeamName.textContent = team1Name;
      team1Players = teams.player1.players;
      team1PlayersEl.innerHTML = team1Players.map(p => `<li class="team-player">${p}</li>`).join('');
    }

    if (teams.player2?.players) {
      team2Name = teams.player2.name || "Team 2";
      team2NameEl.textContent = team2Name;
      team2Players = teams.player2.players;
      team2PlayersEl.innerHTML = team2Players.map(p => `<li class="team-player">${p}</li>`).join('');
    }

    if (team1Players.length === 0 || team2Players.length === 0) {
      throw new Error("Both teams must have at least 1 player");
    }

    return true;
  } catch (error) {
    console.error("Error loading teams:", error);
    showNotification(error.message, 'error');
    throw error;
  }
}

function initializeBatterStats() {
  team1Players.forEach(player => {
    batterStats[player] = batterStats[player] || { 
      runs: 0, balls: 0, fours: 0, sixes: 0,
      centuryNotified: false, fiftyNotified: false
    };
    batterWickets[player] = batterWickets[player] || 0;
    batterPenalties[player] = batterPenalties[player] || 0;
    lastBatterRuns[player] = 0;
  });
  
  team2Players.forEach(player => {
    batterStats[player] = batterStats[player] || { 
      runs: 0, balls: 0, fours: 0, sixes: 0,
      centuryNotified: false, fiftyNotified: false
    };
    batterWickets[player] = batterWickets[player] || 0;
    batterPenalties[player] = batterPenalties[player] || 0;
    lastBatterRuns[player] = 0;
  });
}

function initializeBowlerStats() {
  team1Players.forEach(player => {
    bowlerStats[player] = bowlerStats[player] || { wickets: 0, runs: 0, overs: 0 };
  });
  
  team2Players.forEach(player => {
    bowlerStats[player] = bowlerStats[player] || { wickets: 0, runs: 0, overs: 0 };
  });
}

    async function showBatterSelection() {
      disableButtons();
      
      resetSelectionModal();
      
      try {
          resultEl.innerText = "Loading batters...";
          
          const currentPlayers = player === "player1" ? team1Players : team2Players;
          const availableBatters = currentPlayers.filter(p => {
              const wicketsUsed = Math.min(1.0, batterWickets[p] || 0);
              return wicketsUsed < 1.0;
          });

          if (availableBatters.length === 0) {
              showNotification("All batters are out!", 'error');
              enableButtons();
              return;
          }

          selectionTitle.textContent = "Select Next Batter";
          selectionList.innerHTML = "";
          
          availableBatters.forEach(player => {
              const stats = batterStats[player] || { runs: 0, balls: 0, fours: 0, sixes: 0 };
              const wicketsUsed = Math.min(1.0, batterWickets[player] || 0).toFixed(1);
              
              const batterEl = document.createElement("div");
              batterEl.className = "player-item";
              batterEl.dataset.name = player;
              batterEl.innerHTML = `
                  <div class="player-name">${player}</div>
                  <div class="player-stats">${stats.runs} runs (${wicketsUsed} wickets used)</div>
              `;
              
              batterEl.addEventListener("click", function() {
                  document.querySelectorAll(".player-item").forEach(el => el.classList.remove("selected"));
                  this.classList.add("selected");
              });
              
              selectionList.appendChild(batterEl);
          });

          selectionModal.classList.add('active');
          resultEl.innerText = "Select your next batter...";
      } catch (error) {
          console.error("Batter selection error:", error);
          showNotification("Error loading batters", 'error');
          enableButtons();
      }
    }

    async function showBowlerSelection() {
      disableButtons();
      
      resetSelectionModal();

      try {
          resultEl.innerText = "Loading bowlers...";
          
          const currentPlayers = player === "player1" ? team2Players : team1Players;
          
          if (!currentPlayers || currentPlayers.length === 0) {
              showNotification("No bowlers available", 'error');
              enableButtons();
              return;
          }
          
          const maxOversPerBowler = Math.ceil(currentFormat.totalOvers / 5);
          const availableBowlers = currentPlayers.filter(p => (bowlerOvers[p] || 0) < maxOversPerBowler);
          
          if (availableBowlers.length === 0) {
              showNotification("All bowlers have bowled their maximum overs!", 'error');
              enableButtons();
              return;
          }

          selectionTitle.textContent = "Select Next Bowler";
          selectionList.innerHTML = "";
          
          availableBowlers.forEach(player => {
              const oversBowled = bowlerOvers[player] || 0;
              const stats = bowlerStats[player] || { wickets: 0, runs: 0, overs: 0 };
              
              const playerEl = document.createElement("div");
              playerEl.className = "player-item";
              playerEl.dataset.name = player;
              playerEl.innerHTML = `
                  <div class="player-name">${player}</div>
                  <div class="player-stats">${oversBowled.toFixed(1)} overs, ${stats.wickets} wickets</div>
              `;
              
              playerEl.addEventListener("click", function() {
                  document.querySelectorAll(".player-item").forEach(el => el.classList.remove("selected"));
                  this.classList.add("selected");
              });
              
              selectionList.appendChild(playerEl);
          });

          selectionModal.classList.add('active');
          resultEl.innerText = "Select your next bowler...";
      } catch (error) {
          console.error("Bowler selection error:", error);
          showNotification("Error loading bowlers", 'error');
          enableButtons();
      }
    }

    function resetSelectionModal() {
        selectionModal.classList.remove('active');
        selectionList.innerHTML = '';
    }

    async function setupRole() {
        batterSelected = false;
        bowlerSelected = false;
        currentBatter = null;
        currentBowler = null;
        resetSelectionModal();

        isBatting = (player === battingFirst);
        roleText.textContent = isBatting ? "You are Batting" : "You are Bowling";
        
        // Update batting team name display
        const battingTeamNameText = isBatting ? 
            (player === "player1" ? team1NameEl.textContent : team2NameEl.textContent) :
            (battingFirst === "player1" ? team1NameEl.textContent : team2NameEl.textContent);
        battingTeamName.textContent = battingTeamNameText;
        
        await Promise.all([
            set(batterRef, null),
            set(bowlerRef, null),
            update(playsRef, { player1: null, player2: null })
        ]);
        
        await new Promise(resolve => setTimeout(resolve, 50));
        
        if (isBatting) {
            await showBatterSelection();
        } else {
            await showBowlerSelection();
        }
    }

    function updateButtonStates() {
        if (isSpectator) {
            disableButtons();
            return;
        }

        const canPlay = (isBatting && batterSelected) || (!isBatting && bowlerSelected);
        buttons.forEach(btn => {
            btn.disabled = !canPlay;
        });
        
        timeoutBtn.disabled = !(timeoutAvailable && !timeoutActive && canPlay);
        
        if (canPlay) {
            resultEl.innerText = isBatting ? "Select your shot" : "Select your delivery";
        }
    }

    function setupConnectionMonitoring() {
      // Monitor opponent connection status
      onValue(opponentRef, (snap) => {
        const isOnline = snap.exists() && snap.val();
        connectionStatus.textContent = `Opponent: ${isOnline ? 'Online' : 'Offline'}`;
        connectionStatus.className = `connection-status ${isOnline ? 'online' : 'offline'}`;
        
        if (!isOnline) {
          showNotification("Opponent disconnected", 'error');
        } else {
          showNotification("Opponent reconnected", 'info');
        }
      });

      // Set up heartbeat to show we're online
      const heartbeatInterval = setInterval(() => {
        set(playerRef, true).catch(e => {
          console.error("Heartbeat failed:", e);
          clearInterval(heartbeatInterval);
        });
      }, 30000);

      // Clean up on page unload
      window.addEventListener('beforeunload', () => {
        clearInterval(heartbeatInterval);
        set(playerRef, false);
      });
    }

    function setupSpectatorMode() {
      // Disable all interactive elements
      disableButtons();
      document.querySelectorAll('button').forEach(btn => btn.disabled = true);
      document.getElementById('cardButtons').style.display = 'none';
      document.getElementById('timeoutBtn').style.display = 'none';
      document.getElementById('controls').style.display = 'none';
      
      // Update role text
      roleText.textContent = "SPECTATOR MODE";
      roleText.style.background = "var(--purple)";
      
      // Show connection status for both players
      const connectionContainer = document.createElement('div');
      connectionContainer.className = 'connection-status-container';
      connectionContainer.innerHTML = `
          <div class="connection-status" id="player1Status">Player 1: Offline</div>
          <div class="connection-status" id="player2Status">Player 2: Offline</div>
      `;
      document.querySelector('.container').insertBefore(connectionContainer, document.querySelector('.scoreboard'));
      
      // Listen for player connections
      onValue(ref(db, `rooms/${room}/player1`), (snap) => {
          const status = snap.exists() && snap.val() ? 'online' : 'offline';
          document.getElementById('player1Status').textContent = `Player 1: ${status === 'online' ? 'Online' : 'Offline'}`;
          document.getElementById('player1Status').className = `connection-status ${status}`;
      });
      
      onValue(ref(db, `rooms/${room}/player2`), (snap) => {
          const status = snap.exists() && snap.val() ? 'online' : 'offline';
          document.getElementById('player2Status').textContent = `Player 2: ${status === 'online' ? 'Online' : 'Offline'}`;
          document.getElementById('player2Status').className = `connection-status ${status}`;
      });
      
      // Enhanced spectator UI
      const spectatorControls = document.createElement('div');
      spectatorControls.className = 'spectator-controls';
      spectatorControls.innerHTML = `
          <button id="refreshStatsBtn" class="control-btn">🔄 Refresh</button>
          <button id="fullSummaryBtn" class="control-btn">📊 Full Summary</button>
          <button id="viewPollBtn" class="control-btn">📊 View Poll</button>
      `;
      document.querySelector('.container').appendChild(spectatorControls);
      
      // Setup spectator controls
      document.getElementById('refreshStatsBtn').addEventListener('click', () => {
          updateAllDisplays();
          showNotification("Stats refreshed", 'info');
      });
      
      document.getElementById('fullSummaryBtn').addEventListener('click', () => {
          showMatchSummary();
      });
      
      document.getElementById('viewPollBtn').addEventListener('click', () => {
          pollContainer.style.display = 'flex';
      });
      
      // Setup poll for spectators
      setupSpectatorPoll();
    }

    function setupSpectatorPoll() {
      // Create a more detailed poll for spectators
      pollQuestion.textContent = "Who will win this match?";
      pollOptions.innerHTML = `
          <div class="poll-option">
              <input type="radio" name="pollOption" id="pollOption1" value="${team1NameEl.textContent}">
              <label for="pollOption1">${team1NameEl.textContent}</label>
          </div>
          <div class="poll-option">
              <input type="radio" name="pollOption" id="pollOption2" value="${team2NameEl.textContent}">
              <label for="pollOption2">${team2NameEl.textContent}</label>
          </div>
          <div class="poll-option">
              <input type="radio" name="pollOption" id="pollOption3" value="Tie">
              <label for="pollOption3">Tie</label>
          </div>
      `;
      
      // Listen for poll updates
      onValue(pollRef, (snap) => {
          if (snap.exists()) {
              const pollData = snap.val();
              const votes = Object.values(pollData);
              const voteCount = {
                  [team1NameEl.textContent]: 0,
                  [team2NameEl.textContent]: 0,
                  'Tie': 0
              };
              
              votes.forEach(vote => {
                  if (voteCount.hasOwnProperty(vote.option)) {
                      voteCount[vote.option]++;
                  }
              });
              
              // Update poll display with percentages
              const totalVotes = votes.length;
              document.querySelectorAll('#pollOptions .poll-option').forEach(option => {
                  const optionValue = option.querySelector('input').value;
                  const count = voteCount[optionValue] || 0;
                  const percentage = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
                  option.querySelector('label').textContent = 
                      `${optionValue}: ${count} votes (${percentage}%)`;
                  
                  // Add visual bar
                  if (!option.querySelector('.poll-bar')) {
                      const bar = document.createElement('div');
                      bar.className = 'poll-bar';
                      bar.style.width = `${percentage}%`;
                      option.appendChild(bar);
                  } else {
                      option.querySelector('.poll-bar').style.width = `${percentage}%`;
                  }
              });
          }
      });
      
      // Submit vote handler
      pollSubmit.addEventListener('click', () => {
          const selectedOption = document.querySelector('input[name="pollOption"]:checked');
          if (!selectedOption) {
              showNotification("Please select an option", 'error');
              return;
          }
          
          if (votedInPoll) {
              showNotification("You've already voted", 'error');
              return;
          }
          
          const vote = {
              voter: `spectator-${Math.random().toString(36).substr(2, 8)}`,
              option: selectedOption.value,
              timestamp: Date.now()
          };
          
          push(pollRef, vote);
          votedInPoll = true;
          pollSubmit.disabled = true;
          showNotification("Vote submitted!", 'info');
      });
    }

    // Initialize the game
    async function initGame() {
        try {
            console.log("Starting game initialization...");
            resultEl.innerText = "Initializing game...";
            loadingSpinner.style.display = "block";

            // Verify URL parameters
            if (!room || !player) {
                throw new Error("Missing room or player parameters in URL");
            }

            // Check if spectator mode
            isSpectator = player === "spectator";
            if (isSpectator) {
                setupSpectatorMode();
                return;
            }

            // Set player online status
            await set(playerRef, true);

            // Load room data
            const roomSnap = await get(roomRef);
            if (!roomSnap.exists()) throw new Error("Room not found");

            const roomData = roomSnap.val();
            console.log("Room data loaded:", roomData);

            // Verify game setup
            if (!roomData.toss?.winner && !roomData.tossWinner) {
                throw new Error("Toss not completed");
            }
            
            if (!roomData.teams?.player1 || !roomData.teams?.player2) {
                throw new Error("Teams not set up");
            }

            // Get toss and batting first info
            tossWinner = roomData.toss?.winner || roomData.tossWinner;
            battingFirst = roomData.toss?.battingFirst || roomData.battingFirst;
            
            // Update team names display
            team1NameEl.textContent = roomData.teams.player1.name || "Team 1";
            team2NameEl.textContent = roomData.teams.player2.name || "Team 2";
            battingTeamName.textContent = roomData.teams.player1.name || "Team 1";

            // Mark game as started if not already
            if (!roomData.gameStarted) {
                await update(roomRef, {
                    gameStarted: true
                });
            }

            // Load teams
            await loadPlaying11();

            // Set game format
            const format = roomData.player1?.format || "5";
            currentFormat = formatRules[format];
            
            formatDisplay.innerText = `${currentFormat.name}`;
            
            // Initialize stats
            initializeBatterStats();
            initializeBowlerStats();

            // Set up game components
            setupConnectionMonitoring();
            await setupRole();
            setupSelectionModal();
            setupCardButtons();
            setupFirebaseListeners();
            setupTeamsModal();
            setupTimeoutSystem();
            setupSocialFeatures();
            
            // Set up control buttons
            saveBtn.addEventListener("click", saveGameState);
            exitBtn.addEventListener("click", async () => {
                if (confirm("Exit without saving?")) {
                    await resetGame();
                    window.location.href = "index.html";
                }
            });
            
            resetPlaysBtn.addEventListener("click", async () => {
                if (confirm("Request to reset the current plays? This will notify your opponent.")) {
                    await requestReset();
                }
            });

            // Setup commentary controls
            pauseCommentaryBtn.addEventListener('click', function() {
                commentaryPaused = !commentaryPaused;
                this.textContent = commentaryPaused ? 'Resume' : 'Pause';
            });

            clearCommentaryBtn.addEventListener('click', function() {
                commentaryBox.innerHTML = '';
            });

            // Setup second innings button
            startSecondInningsBtn.addEventListener('click', startSecondInnings);

            // Initial UI update
            updateAllDisplays();
            resultEl.innerText = "Game ready!";
            loadingSpinner.style.display = "none";
            
            // Start ambient crowd noise
            crowdSound.volume = 0.3;
            playSound(crowdSound);
        } catch (error) {
            console.error("Initialization failed:", error);
            resultEl.innerHTML = `Initialization failed: ${error.message}<br>
                               <button onclick="initGame()" style="margin-top:10px; padding: 8px 15px; background: #1e88e5; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                 Retry Initialization
                               </button>`;
            resultEl.className = "error";
            loadingSpinner.style.display = "none";
        }
    }

    // Start the game
    initGame().catch(error => {
        console.error("Uncaught initialization error:", error);
        document.getElementById("result").innerHTML = `
            Fatal error: ${error.message}<br>
            Please refresh or check console for details.
        `;
        document.getElementById("result").className = "error";
    });
  </script>
</body>
</html>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, get, update, push, remove, child } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const room = params.get('room');
    const player = params.get('player');
    
    if (!room || !player) {
      document.getElementById("result").innerHTML = `
        Missing required parameters in URL.<br>
        Please return to the main page and join the game again.
      `;
      document.getElementById("result").className = "error";
      throw new Error("Missing room or player parameters");
    }

    const opponent = player === "player1" ? "player2" : "player1";

    // Firebase references
    const roomRef = ref(db, `rooms/${room}`);
    const playerRef = ref(db, `rooms/${room}/${player}`);
    const opponentRef = ref(db, `rooms/${room}/${opponent}`);
    const playsRef = ref(db, `rooms/${room}/currentPlays`);
    const batterRef = ref(db, `rooms/${room}/currentBatter`);
    const bowlerRef = ref(db, `rooms/${room}/currentBowler`);
    const teamsRef = ref(db, `rooms/${room}/teams`);
    const matchStatsRef = ref(db, `rooms/${room}/matchStats`);
    const firstInningsRef = ref(db, `rooms/${room}/firstInnings`);
    const firstInningsCompletedRef = ref(db, `rooms/${room}/firstInningsCompleted`);
    const secondInningsStartedRef = ref(db, `rooms/${room}/secondInningsStarted`);
    const timeoutRef = ref(db, `rooms/${room}/timeout`);
    const resetRequestRef = ref(db, `rooms/${room}/resetRequest`);
    const drsRef = ref(db, `rooms/${room}/drs`);
    const chatRef = ref(db, `rooms/${room}/chat`);
    const pollRef = ref(db, `rooms/${room}/poll`);
    const resultRef = ref(db, `rooms/${room}/result`);
    
    // Format rules
    const formatRules = {
      "5": { 
        name: "5 Overs", 
        totalOvers: 5, 
        totalWickets: 10,
        powerplayOvers: 2, 
        powerplayWicketValue: 0.5,
        regularWicketValue: 1.0,
        deadOvers: []
      },
      "10": { 
        name: "10 Overs", 
        totalOvers: 10, 
        totalWickets: 10,
        powerplayOvers: 3, 
        powerplayWicketValue: 0.5,
        regularWicketValue: 1.0,
        deadOvers: []
      },
      "20": { 
        name: "T20", 
        totalOvers: 20, 
        totalWickets: 10,
        powerplayOvers: 6, 
        powerplayWicketValue: 0.5,
        regularWicketValue: 1.0,
        deadOvers: []
      },
      "50": { 
        name: "ODI", 
        totalOvers: 50, 
        totalWickets: 10,
        powerplayOvers: [1,10, 21,30, 41,42], 
        powerplayWicketValue: 0.25,
        regularWicketValue: 0.5,
        deadOvers: [11,20, 31,40]
      }
    };

    // Game state variables
    let runs = 0, wickets = 0;
    let legalBalls = 0;
    let freeHit = false;
    let freeHitNextBall = false;
    let currentBatter = null;
    let currentBowler = null;
    let battersUsed = [];
    let bowlersUsed = [];
    let bowlerOvers = {};
    let isBatting = false;
    let currentFormat = {};
    let isPowerplay = false;
    let isDeadOver = false;
    let batterWickets = {};
    let zerosThisOver = { player1: 0, player2: 0 };
    let bowlerRuns = {};
    let gameInProgress = true;
    let lastOverRuns = 0;
    let lastOverWickets = 0;
    let lastWicketScore = 0;
    let ballByBall = {};
    let fallOfWickets = [];
    let batterStats = {};
    let bowlerStats = {};
    let tossWinner = null;
    let battingFirst = null;
    let batterSelected = false;
    let bowlerSelected = false;
    let team1Players = [];
    let team2Players = [];
    let team1Name = "Team 1";
    let team2Name = "Team 2";
    let batterPenalties = {};
    let lastBatterRuns = {};
    let resetRequested = false;
    let resetRequestedBy = null;
    let isResetting = false;
    let resetCount = 0;
    const MAX_RESETS = 3;
    let selectedCardValue = null;
    let isProcessingSelection = false;
    let overSummaries = [];
    let isSpectator = false;
    let commentaryPaused = false;
    let firstInningsCompleted = false;
    let firstInningsData = null;
    let target = 0;
    let chasingTeam = null;
    let secondInningsStarted = false;
    let timeoutAvailable = true;
    let timeoutActive = false;
    let timeoutTimer = null;
    let drsReviewsAvailable = 2;
    let drsActive = false;
    let chatMessages = [];
    let pollData = null;
    let votedInPoll = false;
    let emojis = ["😀", "😂", "😍", "😎", "👍", "👎", "🎉", "😢", "🤔", "🔥"];

    // DOM elements
    const resultEl = document.getElementById("result");
    const buttons = document.querySelectorAll(".btn");
    const roleText = document.getElementById("roleText");
    const selectionModal = document.getElementById("selectionModal");
    const selectionTitle = document.getElementById("selectionTitle");
    const selectionList = document.getElementById("selectionList");
    const confirmSelection = document.getElementById("confirmSelection");
    const closeSelectionModal = document.getElementById("closeSelectionModal");
    const team1NameEl = document.getElementById("modalTeam1Name");
    const team2NameEl = document.getElementById("modalTeam2Name");
    const team1PlayersEl = document.getElementById("modalTeam1Players");
    const team2PlayersEl = document.getElementById("modalTeam2Players");
    const formatDisplay = document.getElementById("formatDisplay");
    const saveBtn = document.getElementById("saveBtn");
    const exitBtn = document.getElementById("exitBtn");
    const resetPlaysBtn = document.getElementById("resetPlaysBtn");
    const showTeamsBtn = document.getElementById("showTeamsBtn");
    const showStatsBtn = document.getElementById("showStatsBtn");
    const teamsModal = document.getElementById("teamsModal");
    const closeTeamsModal = document.getElementById("closeTeamsModal");
    const teamsSlider = document.getElementById("teamsSlider");
    const prevTeamBtn = document.getElementById("prevTeamBtn");
    const nextTeamBtn = document.getElementById("nextTeamBtn");
    const overSummaryList = document.getElementById("overSummaryList");
    const battingTeamName = document.getElementById("battingTeamName");
    const commentaryBox = document.getElementById("commentaryBox");
    const pauseCommentaryBtn = document.getElementById("pauseCommentary");
    const clearCommentaryBtn = document.getElementById("clearCommentary");
    const summaryPopup = document.getElementById("summaryPopup");
    const closeSummaryPopup = document.getElementById("closeSummaryPopup");
    const startSecondInningsBtn = document.getElementById("startSecondInningsBtn");
    const summaryTotalRuns = document.getElementById("summaryTotalRuns");
    const summaryWickets = document.getElementById("summaryWickets");
    const summaryOvers = document.getElementById("summaryOvers");
    const summaryRunRate = document.getElementById("summaryRunRate");
    const summaryHighlight = document.getElementById("summaryHighlight");
    const targetDisplay = document.getElementById("targetDisplay");
    const targetValue = document.getElementById("targetValue");
    const matchSummary = document.getElementById("matchSummary");
    const potmName = document.getElementById("potmName");
    const potmStats = document.getElementById("potmStats");
    const battingCard = document.getElementById("battingCard");
    const bowlingCard = document.getElementById("bowlingCard");
    const matchResult = document.getElementById("matchResult");
    const closeMatchSummary = document.getElementById("closeMatchSummary");
    const inningsSlider = document.getElementById("inningsSlider");
    const inningsSliderContainer = document.getElementById("inningsSliderContainer");
    const prevInningsSlide = document.getElementById("prevInningsSlide");
    const nextInningsSlide = document.getElementById("nextInningsSlide");
    const drsContainer = document.getElementById("drsContainer");
    const drsButton = document.getElementById("drsButton");
    const drsReviews = document.getElementById("drsReviews");
    const drsReview = document.getElementById("drsReview");
    const drsReviewMessage = document.getElementById("drsReviewMessage");
    const drsReviewButtons = document.getElementById("drsReviewButtons");
    const drsConfirm = document.getElementById("drsConfirm");
    const drsCancel = document.getElementById("drsCancel");
    const timeoutBtn = document.getElementById("timeoutBtn");
    const connectionStatus = document.getElementById("connectionStatus");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const powerplayIndicator = document.getElementById("powerplayIndicator");
    const deadOverIndicator = document.getElementById("deadOverIndicator");
    const freeHitIndicator = document.getElementById("freeHitIndicator");
    const chatButton = document.getElementById("chatButton");
    const pollButton = document.getElementById("pollButton");
    const emojiButton = document.getElementById("emojiButton");
    const chatContainer = document.getElementById("chatContainer");
    const closeChat = document.getElementById("closeChat");
    const chatMessagesEl = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");
    const emojiPicker = document.getElementById("emojiPicker");
    const pollContainer = document.getElementById("pollContainer");
    const closePoll = document.getElementById("closePoll");
    const pollQuestion = document.getElementById("pollQuestion");
    const pollOptions = document.getElementById("pollOptions");
    const pollSubmit = document.getElementById("pollSubmit");
    const statsContainer = document.getElementById("statsContainer");
    const closeStats = document.getElementById("closeStats");
    const statsTabs = document.querySelectorAll(".stats-tab");
    const statsGraphs = document.querySelectorAll(".stats-graph");
    const boundarySound = document.getElementById("boundarySound");
    const wicketSound = document.getElementById("wicketSound");
    const crowdSound = document.getElementById("crowdSound");
    const drsSound = document.getElementById("drsSound");
    const gameContainer = document.getElementById("gameContainer");
    const spectatorContainer = document.getElementById("spectatorContainer");
    const specTeam1Name = document.getElementById("specTeam1Name");
    const specTeam2Name = document.getElementById("specTeam2Name");
    const specTeam1Score = document.getElementById("specTeam1Score");
    const specTeam2Score = document.getElementById("specTeam2Score");
    const specFormat = document.getElementById("specFormat");
    const specInnings = document.getElementById("specInnings");
    const specTime = document.getElementById("specTime");
    const specCommentary = document.getElementById("specCommentary");
    const specTimeline = document.getElementById("specTimeline");
    const specPollQuestion = document.getElementById("specPollQuestion");
    const specPollOptions = document.getElementById("specPollOptions");

    // Helper functions
    function showNotification(message, type = 'info') {
      const notif = document.createElement('div');
      notif.className = `notification ${type}`;
      notif.textContent = message;
      document.body.appendChild(notif);
      
      setTimeout(() => {
        notif.style.opacity = '0';
        setTimeout(() => notif.remove(), 500);
      }, 2500);
    }

    function playSound(sound) {
      try {
        sound.currentTime = 0;
        sound.play();
      } catch (e) {
        console.log("Audio error:", e);
      }
    }

    function createConfetti() {
      const colors = ['#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff'];
      for (let i = 0; i < 150; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${Math.random() * 100}%`;
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.width = `${Math.random() * 10 + 5}px`;
        confetti.style.height = `${Math.random() * 10 + 5}px`;
        confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
        confetti.style.animationDelay = `${Math.random() * 0.5}s`;
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 5000);
      }
    }

    function disableButtons() {
      buttons.forEach(btn => {
        btn.disabled = true;
      });
      timeoutBtn.disabled = true;
      drsButton.disabled = true;
    }

    function enableButtons() {
      if (isResetting) return;
      
      const canPlay = (isBatting && batterSelected) || (!isBatting && bowlerSelected);
      buttons.forEach(btn => {
        btn.disabled = !canPlay;
      });
      
      timeoutBtn.disabled = !(timeoutAvailable && !timeoutActive && canPlay);
      
      // Enable DRS only when eligible
      const showDRS = isBatting && drsReviewsAvailable > 0 && 
                     ballByBall[legalBalls-1]?.wicket && 
                     ballByBall[legalBalls-1]?.batter === currentBatter &&
                     ballByBall[legalBalls-1]?.cardValue <= 3;
      
      drsContainer.style.display = showDRS ? 'block' : 'none';
      drsButton.disabled = !showDRS;
      
      if (canPlay) {
        resultEl.innerText = isBatting ? "Select your shot" : "Select your delivery";
      }
    }

    function clearCardSelection() {
      buttons.forEach(btn => {
        btn.classList.remove("selected");
      });
      selectedCardValue = null;
      isProcessingSelection = false;
    }

    function highlightSelectedCard(value) {
      buttons.forEach(btn => {
        const val = parseInt(btn.dataset.value);
        btn.classList.toggle("selected", val === value);
      });
    }

    function formatWickets(value) {
      const maxWickets = currentFormat.totalWickets;
      const formattedValue = Math.min(value, maxWickets)
        .toFixed(2)
        .replace(/\.00$/, '');
      
      return formattedValue.includes('.') ? formattedValue : parseInt(formattedValue);
    }

    function getWicketValue() {
      const over = Math.floor(legalBalls / 6);
      
      if (currentFormat.name === "ODI") {
        return isPowerplay ? 0.25 : 0.5;
      }
      
      return isPowerplay ? 0.5 : 1.0;
    }

    function checkPowerplay() {
      const currentOver = Math.floor(legalBalls / 6);
      
      if (Array.isArray(currentFormat.powerplayOvers)) {
        isPowerplay = currentFormat.powerplayOvers.some(pp => {
          if (Array.isArray(pp)) {
            return currentOver >= pp[0] && currentOver <= pp[1];
          }
          return currentOver === pp;
        });
      } else {
        isPowerplay = currentOver < currentFormat.powerplayOvers;
      }

      powerplayIndicator.style.display = isPowerplay ? "inline-block" : "none";
    }

    function checkDeadOver() {
      if (!currentFormat.deadOvers || currentFormat.deadOvers.length === 0) {
        isDeadOver = false;
        deadOverIndicator.style.display = "none";
        return;
      }

      const currentOver = Math.floor(legalBalls / 6);
      isDeadOver = currentFormat.deadOvers.some(dead => {
        if (Array.isArray(dead)) {
          return currentOver >= dead[0] && currentOver <= dead[1];
        }
        return currentOver === dead;
      });

      deadOverIndicator.style.display = isDeadOver ? "inline-block" : "none";
    }

    function updateFreeHitDisplay() {
      freeHitIndicator.style.display = freeHit ? "inline-block" : "none";
    }

    function updateScoreboard() {
      const wicketsDisplay = formatWickets(wickets);
      
      document.getElementById("runs").textContent = runs;
      document.getElementById("wickets").textContent = wicketsDisplay;
      document.getElementById("overs").textContent = 
        `${Math.floor(legalBalls/6)}.${legalBalls%6}`;
    }

    function updatePlayerStats() {
      const completedOvers = Math.floor(legalBalls / 6) + (legalBalls % 6) / 10;
      const rr = completedOvers > 0 ? (runs / completedOvers).toFixed(2) : '0.00';
      document.getElementById('runRate').textContent = rr;
    }

    function updateOverProgress() {
      const ballsContainer = document.getElementById('ballsContainer');
      ballsContainer.innerHTML = '';
      
      const ballsThisOver = legalBalls % 6;
      for (let i = 0; i < 6; i++) {
        const ballEl = document.createElement('div');
        ballEl.className = 'ball';
        
        if (i < ballsThisOver) {
          const ballData = ballByBall[legalBalls - ballsThisOver + i];
          if (ballData) {
            if (ballData.wicket) {
              ballEl.className += ' wicket';
              ballEl.textContent = 'W';
            } else if (ballData.runs > 0) {
              ballEl.className += ' run';
              ballEl.textContent = ballData.runs;
            } else {
              ballEl.className += ' dot';
              ballEl.textContent = '•';
            }
          }
        } else {
          ballEl.className += ' empty';
        }
        
        ballsContainer.appendChild(ballEl);
      }
    }

    function updatePartnership() {
      let partnershipRuns = runs - lastWicketScore;
      let partnershipBalls = 0;
      
      for (let i = legalBalls - 1; i >= 0; i--) {
        if (ballByBall[i]?.wicket) break;
        partnershipBalls++;
      }
    }

    function updateLast5Overs() {
      let last5Runs = 0;
      let last5Wickets = 0;
      let last5Balls = 0;
      
      const startBall = Math.max(0, legalBalls - 30);
      for (let i = startBall; i < legalBalls; i++) {
        if (ballByBall[i]) {
          last5Runs += ballByBall[i].runs;
          if (ballByBall[i].wicket) last5Wickets++;
          last5Balls++;
        }
      }
    }

    function updateCurrentTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function updatePlayerComparison() {
      if (currentBatter) {
        const batter = batterStats[currentBatter] || { runs: 0, balls: 0, fours: 0, sixes: 0 };
        const sr = batter.balls > 0 ? ((batter.runs / batter.balls) * 100).toFixed(2) : '0.00';
        
        document.getElementById('comparisonBatterName').textContent = currentBatter;
        document.getElementById('comparisonBatterRuns').textContent = batter.runs;
        document.getElementById('comparisonBatterBalls').textContent = batter.balls;
        document.getElementById('comparisonBatterSR').textContent = sr;
        document.getElementById('comparisonBatterBoundaries').textContent = `${batter.fours}/${batter.sixes}`;
      }
      
      if (currentBowler) {
        const bowler = bowlerStats[currentBowler] || { wickets: 0, runs: 0, overs: 0 };
        const er = bowler.overs > 0 ? (bowler.runs / bowler.overs).toFixed(2) : '0.00';
        
        document.getElementById('comparisonBowlerName').textContent = currentBowler;
        document.getElementById('comparisonBowlerWickets').textContent = bowler.wickets;
        document.getElementById('comparisonBowlerOvers').textContent = bowler.overs.toFixed(1);
        document.getElementById('comparisonBowlerER').textContent = er;
        document.getElementById('comparisonBowlerRuns').textContent = bowler.runs;
      }
    }

    function updateAllDisplays() {
      updateScoreboard();
      updatePlayerStats();
      updateOverProgress();
      updatePartnership();
      updateLast5Overs();
      updateCurrentTime();
      updatePlayerComparison();
      
      // Update spectator view
      if (isSpectator) {
        updateSpectatorView();
      }
    }

    function addCommentary(message, type = '') {
      if (commentaryPaused) return;
      
      const now = new Date();
      const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      const commentaryItem = document.createElement('div');
      commentaryItem.className = `commentary-item ${type}`;
      commentaryItem.innerHTML = `<span class="commentary-time">${timeString}</span>${message}`;
      
      commentaryBox.insertBefore(commentaryItem, commentaryBox.firstChild);
      
      if (commentaryBox.children.length > 50) {
        commentaryBox.removeChild(commentaryBox.lastChild);
      }
      
      // Update spectator commentary
      if (isSpectator) {
        const specCommentaryItem = document.createElement('div');
        specCommentaryItem.className = `commentary-item ${type}`;
        specCommentaryItem.innerHTML = `<span class="commentary-time">${timeString}</span>${message}`;
        
        specCommentary.insertBefore(specCommentaryItem, specCommentary.firstChild);
        
        if (specCommentary.children.length > 50) {
          specCommentary.removeChild(specCommentary.lastChild);
        }
      }
    }

    function addToTimeline(event, type = '') {
      const timeline = document.getElementById('matchTimeline');
      const currentOver = Math.floor(legalBalls / 6);
      const currentBall = (legalBalls % 6) + 1;
      
      const timelineItem = document.createElement('div');
      timelineItem.className = `timeline-item ${type}`;
      timelineItem.innerHTML = `
        <div class="timeline-over">${currentOver}.${currentBall}</div>
        <div class="timeline-event">${event}</div>
      `;
      
      timeline.insertBefore(timelineItem, timeline.firstChild);
      
      if (timeline.children.length > 20) {
        timeline.removeChild(timeline.lastChild);
      }
      
      // Update spectator timeline
      if (isSpectator) {
        const specTimelineItem = document.createElement('div');
        specTimelineItem.className = `timeline-item ${type}`;
        specTimelineItem.innerHTML = `
          <div class="timeline-over">${currentOver}.${currentBall}</div>
          <div class="timeline-event">${event}</div>
        `;
        
        specTimeline.insertBefore(specTimelineItem, specTimeline.firstChild);
        
        if (specTimeline.children.length > 20) {
          specTimeline.removeChild(specTimeline.lastChild);
        }
      }
    }

    function updateOverSummary() {
      const currentOver = Math.floor(legalBalls / 6);
      if (currentOver > 0 && currentOver > overSummaries.length) {
        const runsThisOver = runs - lastOverRuns;
        const wicketsThisOver = wickets - lastOverWickets;
        const summary = `Over ${currentOver}: ${runsThisOver} runs, ${wicketsThisOver} wickets`;
        overSummaries.push(summary);
        
        const summaryItem = document.createElement("div");
        summaryItem.className = "over-summary-item";
        summaryItem.textContent = summary;
        overSummaryList.appendChild(summaryItem);
        
        overSummaryList.scrollTop = overSummaryList.scrollHeight;
        
        lastOverRuns = runs;
        lastOverWickets = wickets;
      }
    }

    function showSummaryPopup() {
      summaryPopup.style.display = 'block';
      
      summaryTotalRuns.textContent = runs;
      summaryWickets.textContent = wickets;
      summaryOvers.textContent = `${Math.floor(legalBalls/6)}.${legalBalls%6}`;
      
      const completedOvers = Math.floor(legalBalls / 6) + (legalBalls % 6) / 10;
      const rr = completedOvers > 0 ? (runs / completedOvers).toFixed(2) : '0.00';
      summaryRunRate.textContent = rr;
      
      if (runs >= 200) {
        summaryHighlight.textContent = "Excellent Batting Performance!";
      } else if (runs >= 150) {
        summaryHighlight.textContent = "Good Total Posted!";
      } else if (runs <= 100) {
        summaryHighlight.textContent = "Bowlers Dominated This Innings";
      } else {
        summaryHighlight.textContent = "Competitive Total";
      }
    }

    function showMatchSummary() {
      // Set player of the match
      const allPlayers = [...team1Players, ...team2Players];
      const potm = allPlayers.reduce((best, player) => {
        const batRuns = batterStats[player]?.runs || 0;
        const bowlWkts = bowlerStats[player]?.wickets || 0;
        const score = batRuns + (bowlWkts * 25);
        return score > best.score ? { player, score } : best;
      }, { player: null, score: 0 });
      
      if (potm.player) {
        potmName.textContent = `${potm.player}`;
        const stats = [];
        if (batterStats[potm.player]?.runs) {
          stats.push(`${batterStats[potm.player].runs} runs`);
        }
        if (bowlerStats[potm.player]?.wickets) {
          stats.push(`${bowlerStats[potm.player].wickets} wickets`);
        }
        potmStats.textContent = stats.join(', ');
      }
      
      // Set batting card
      let battingHTML = '';
      const battingTeam = battingFirst === "player1" ? team1Players : team2Players;
      battingTeam.forEach(player => {
        const stats = batterStats[player] || { runs: 0, balls: 0 };
        const outText = batterWickets[player] >= 1 ? 'out' : 'not out';
        battingHTML += `
          <div class="scorecard-row">
            <div class="scorecard-player">${player}</div>
            <div class="scorecard-stats">${stats.runs} (${stats.balls}) ${outText}</div>
          </div>
        `;
      });
      battingCard.innerHTML = battingHTML;
      
      // Set bowling card
      let bowlingHTML = '';
      const bowlingTeam = battingFirst === "player1" ? team2Players : team1Players;
      bowlingTeam.forEach(player => {
        const stats = bowlerStats[player] || { wickets: 0, runs: 0, overs: 0 };
        bowlingHTML += `
          <div class="scorecard-row">
            <div class="scorecard-player">${player}</div>
            <div class="scorecard-stats">${stats.wickets}/${stats.runs} (${stats.overs.toFixed(1)})</div>
          </div>
        `;
      });
      bowlingCard.innerHTML = bowlingHTML;
      
      // Set match result
      const winner = runs >= target ? battingFirst : (battingFirst === "player1" ? "player2" : "player1");
      const winnerName = winner === "player1" ? team1Name : team2Name;
      const margin = runs >= target ? `${currentFormat.totalWickets - wickets} wickets` : `${target - runs - 1} runs`;
      matchResult.textContent = `${winnerName} WON BY ${margin.toUpperCase()}`;
      
      matchSummary.style.display = 'block';
    }

    function createInningsSlides() {
      inningsSliderContainer.innerHTML = '';
      
      // First innings slide
      const firstInningsSlide = document.createElement('div');
      firstInningsSlide.className = 'innings-slide';
      firstInningsSlide.innerHTML = `
        <div class="innings-slide-header">
          <div class="innings-slide-title">FIRST INNINGS</div>
          <div class="innings-slide-subtitle">${team1Name} vs ${team2Name}</div>
        </div>
        
        <div class="innings-batters">
          <div class="innings-section-title">BATTING</div>
          ${team1Players.map(player => {
            const stats = batterStats[player] || { runs: 0, balls: 0 };
            const outText = batterWickets[player] >= 1 ? 'out' : 'not out';
            return `
              <div class="innings-player">
                <div class="innings-player-name">${player}</div>
                <div class="innings-player-stats">${stats.runs} (${stats.balls}) ${outText}</div>
              </div>
            `;
          }).join('')}
        </div>
        
        <div class="innings-bowlers">
          <div class="innings-section-title">BOWLING</div>
          ${team2Players.map(player => {
            const stats = bowlerStats[player] || { wickets: 0, runs: 0, overs: 0 };
            return `
              <div class="innings-player">
                <div class="innings-player-name">${player}</div>
                <div class="innings-player-stats">${stats.wickets}/${stats.runs} (${stats.overs.toFixed(1)})</div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      inningsSliderContainer.appendChild(firstInningsSlide);
      
      // Second innings slide
      const secondInningsSlide = document.createElement('div');
      secondInningsSlide.className = 'innings-slide';
      secondInningsSlide.innerHTML = `
        <div class="innings-slide-header">
          <div class="innings-slide-title">SECOND INNINGS</div>
          <div class="innings-slide-subtitle">Target: ${target}</div>
        </div>
        
        <div class="innings-batters">
          <div class="innings-section-title">BATTING</div>
          ${team2Players.map(player => {
            const stats = batterStats[player] || { runs: 0, balls: 0 };
            const outText = batterWickets[player] >= 1 ? 'out' : 'not out';
            return `
              <div class="innings-player">
                <div class="innings-player-name">${player}</div>
                <div class="innings-player-stats">${stats.runs} (${stats.balls}) ${outText}</div>
              </div>
            `;
          }).join('')}
        </div>
        
        <div class="innings-bowlers">
          <div class="innings-section-title">BOWLING</div>
          ${team1Players.map(player => {
            const stats = bowlerStats[player] || { wickets: 0, runs: 0, overs: 0 };
            return `
              <div class="innings-player">
                <div class="innings-player-name">${player}</div>
                <div class="innings-player-stats">${stats.wickets}/${stats.runs} (${stats.overs.toFixed(1)})</div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      inningsSliderContainer.appendChild(secondInningsSlide);
      
      // Match summary slide
      const summarySlide = document.createElement('div');
      summarySlide.className = 'innings-slide';
      summarySlide.innerHTML = `
        <div class="innings-slide-header">
          <div class="innings-slide-title">MATCH SUMMARY</div>
          <div class="innings-slide-subtitle">IHCC HandiCricket</div>
        </div>
        
        <div class="player-of-match">
          <div class="player-of-match-name" id="slidePotmName">-</div>
          <div class="player-of-match-stats" id="slidePotmStats">-</div>
        </div>
        
        <div class="match-result">
          ${matchResult.textContent}
        </div>
        
        <div class="innings-section-title">FIRST INNINGS</div>
        <div class="innings-player">
          <div class="innings-player-name">${team1Name}</div>
          <div class="innings-player-stats">${firstInningsData.totalRuns}/${firstInningsData.totalWickets} (${Math.floor(firstInningsData.balls/6)}.${firstInningsData.balls%6})</div>
        </div>
        
        <div class="innings-section-title">SECOND INNINGS</div>
        <div class="innings-player">
          <div class="innings-player-name">${team2Name}</div>
          <div class="innings-player-stats">${runs}/${wickets} (${Math.floor(legalBalls/6)}.${legalBalls%6})</div>
        </div>
      `;
      
      // Set player of the match in slide
      const potm = [...team1Players, ...team2Players].reduce((best, player) => {
        const batRuns = batterStats[player]?.runs || 0;
        const bowlWkts = bowlerStats[player]?.wickets || 0;
        const score = batRuns + (bowlWkts * 25);
        return score > best.score ? { player, score } : best;
      }, { player: null, score: 0 });
      
      if (potm.player) {
        summarySlide.querySelector('#slidePotmName').textContent = potm.player;
        const stats = [];
        if (batterStats[potm.player]?.runs) {
          stats.push(`${batterStats[potm.player].runs} runs`);
        }
        if (bowlerStats[potm.player]?.wickets) {
          stats.push(`${bowlerStats[potm.player].wickets} wickets`);
        }
        summarySlide.querySelector('#slidePotmStats').textContent = stats.join(', ');
      }
      
      inningsSliderContainer.appendChild(summarySlide);
      
      // Show slider
      inningsSlider.style.display = 'block';
      
      // Setup navigation
      let currentSlide = 0;
      const slides = document.querySelectorAll('.innings-slide');
      
      function updateSlider() {
        inningsSliderContainer.scrollTo({
          left: currentSlide * window.innerWidth,
          behavior: 'smooth'
        });
        
        prevInningsSlide.disabled = currentSlide === 0;
        nextInningsSlide.disabled = currentSlide === slides.length - 1;
      }
      
      prevInningsSlide.addEventListener('click', () => {
        if (currentSlide > 0) {
          currentSlide--;
          updateSlider();
        }
      });
      
      nextInningsSlide.addEventListener('click', () => {
        if (currentSlide < slides.length - 1) {
          currentSlide++;
          updateSlider();
        }
      });
      
      // Touch/swipe support
      let touchStartX = 0;
      let touchEndX = 0;
      
      inningsSliderContainer.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
      });
      
      inningsSliderContainer.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      });
      
      function handleSwipe() {
        const threshold = 50;
        if (touchEndX < touchStartX - threshold) {
          // Swipe left
          if (currentSlide < slides.length - 1) {
            currentSlide++;
            updateSlider();
          }
        } else if (touchEndX > touchStartX + threshold) {
          // Swipe right
          if (currentSlide > 0) {
            currentSlide--;
            updateSlider();
          }
        }
      }
    }

    async function loadPlaying11() {
      try {
        resultEl.innerText = "Loading teams...";
        
        const roomSnap = await get(roomRef);
        if (!roomSnap.exists()) throw new Error("Room not found");

        const teams = roomSnap.val().teams;
        if (!teams?.player1 || !teams?.player2) {
          throw new Error("Both teams must be submitted before starting");
        }

        team1Players = [];
        team2Players = [];
        team1PlayersEl.innerHTML = '';
        team2PlayersEl.innerHTML = '';

        if (teams.player1?.players) {
          team1Name = teams.player1.name || "Team 1";
          team1NameEl.textContent = team1Name;
          battingTeamName.textContent = team1Name;
          team1Players = teams.player1.players;
          team1PlayersEl.innerHTML = team1Players.map(p => `<li class="team-player">${p}</li>`).join('');
        }

        if (teams.player2?.players) {
          team2Name = teams.player2.name || "Team 2";
          team2NameEl.textContent = team2Name;
          team2Players = teams.player2.players;
          team2PlayersEl.innerHTML = team2Players.map(p => `<li class="team-player">${p}</li>`).join('');
        }

        if (team1Players.length === 0 || team2Players.length === 0) {
          throw new Error("Both teams must have at least 1 player");
        }

        return true;
      } catch (error) {
        console.error("Error loading teams:", error);
        showNotification(error.message, 'error');
        throw error;
      }
    }

    function initializeBatterStats() {
      team1Players.forEach(player => {
        batterStats[player] = batterStats[player] || { 
          runs: 0, balls: 0, fours: 0, sixes: 0,
          centuryNotified: false, fiftyNotified: false
        };
        batterWickets[player] = batterWickets[player] || 0;
        batterPenalties[player] = batterPenalties[player] || 0;
        lastBatterRuns[player] = 0;
      });
      
      team2Players.forEach(player => {
        batterStats[player] = batterStats[player] || { 
          runs: 0, balls: 0, fours: 0, sixes: 0,
          centuryNotified: false, fiftyNotified: false
        };
        batterWickets[player] = batterWickets[player] || 0;
        batterPenalties[player] = batterPenalties[player] || 0;
        lastBatterRuns[player] = 0;
      });
    }

    function initializeBowlerStats() {
      team1Players.forEach(player => {
        bowlerStats[player] = bowlerStats[player] || { wickets: 0, runs: 0, overs: 0 };
      });
      
      team2Players.forEach(player => {
        bowlerStats[player] = bowlerStats[player] || { wickets: 0, runs: 0, overs: 0 };
      });
    }

    async function showBatterSelection() {
    disableButtons();
    
    resetSelectionModal();
    
    try {
        resultEl.innerText = "Loading batters...";
        
        const currentPlayers = player === "player1" ? team1Players : team2Players;
        const availableBatters = currentPlayers.filter(p => {
            const wicketsUsed = Math.min(1.0, batterWickets[p] || 0);
            return wicketsUsed < 1.0;
        });

        if (availableBatters.length === 0) {
            showNotification("All batters are out!", 'error');
            enableButtons();
            return;
        }

        selectionTitle.textContent = "Select Next Batter";
        selectionList.innerHTML = "";
        
        availableBatters.forEach(player => {
            const stats = batterStats[player] || { runs: 0, balls: 0, fours: 0, sixes: 0 };
            const wicketsUsed = Math.min(1.0, batterWickets[player] || 0).toFixed(1);
            
            const batterEl = document.createElement("div");
            batterEl.className = "player-item";
            batterEl.dataset.name = player;
            batterEl.innerHTML = `
                <div class="player-name">${player}</div>
                <div class="player-stats">${stats.runs} runs (${wicketsUsed} wickets used)</div>
            `;
            
            batterEl.addEventListener("click", function() {
                document.querySelectorAll(".player-item").forEach(el => el.classList.remove("selected"));
                this.classList.add("selected");
            });
            
            selectionList.appendChild(batterEl);
        });

        selectionModal.classList.add('active');
        resultEl.innerText = "Select your next batter...";
    } catch (error) {
        console.error("Batter selection error:", error);
        showNotification("Error loading batters", 'error');
        enableButtons();
    }
}

async function showBowlerSelection() {
    disableButtons();
    
    resetSelectionModal();

    try {
        resultEl.innerText = "Loading bowlers...";
        
        const currentPlayers = player === "player1" ? team2Players : team1Players;
        
        if (!currentPlayers || currentPlayers.length === 0) {
            showNotification("No bowlers available", 'error');
            enableButtons();
            return;
        }
        
        const maxOversPerBowler = Math.ceil(currentFormat.totalOvers / 5);
        const availableBowlers = currentPlayers.filter(p => (bowlerOvers[p] || 0) < maxOversPerBowler);
        
        if (availableBowlers.length === 0) {
            showNotification("All bowlers have bowled their maximum overs!", 'error');
            enableButtons();
            return;
        }

        selectionTitle.textContent = "Select Next Bowler";
        selectionList.innerHTML = "";
        
        availableBowlers.forEach(player => {
            const oversBowled = bowlerOvers[player] || 0;
            const stats = bowlerStats[player] || { wickets: 0, runs: 0, overs: 0 };
            
            const playerEl = document.createElement("div");
            playerEl.className = "player-item";
            playerEl.dataset.name = player;
            playerEl.innerHTML = `
                <div class="player-name">${player}</div>
                <div class="player-stats">${oversBowled.toFixed(1)} overs, ${stats.wickets} wickets</div>
            `;
            
            playerEl.addEventListener("click", function() {
                document.querySelectorAll(".player-item").forEach(el => el.classList.remove("selected"));
                this.classList.add("selected");
            });
            
            selectionList.appendChild(playerEl);
        });

        selectionModal.classList.add('active');
        resultEl.innerText = "Select your next bowler...";
    } catch (error) {
        console.error("Bowler selection error:", error);
        showNotification("Error loading bowlers", 'error');
        enableButtons();
    }
}

function resetSelectionModal() {
    selectionModal.classList.remove('active');
    selectionList.innerHTML = '';
}

async function setupRole() {
    batterSelected = false;
    bowlerSelected = false;
    currentBatter = null;
    currentBowler = null;
    resetSelectionModal();

    isBatting = (player === battingFirst);
    roleText.textContent = isBatting ? "You are Batting" : "You are Bowling";
    
    // Update batting team name display
    const battingTeamNameText = isBatting ? 
        (player === "player1" ? team1NameEl.textContent : team2NameEl.textContent) :
        (battingFirst === "player1" ? team1NameEl.textContent : team2NameEl.textContent);
    battingTeamName.textContent = battingTeamNameText;
    
    await Promise.all([
        set(batterRef, null),
        set(bowlerRef, null),
        update(playsRef, { player1: null, player2: null })
    ]);
    
    await new Promise(resolve => setTimeout(resolve, 50));
    
    if (isBatting) {
        await showBatterSelection();
    } else {
        await showBowlerSelection();
    }
}

function updateButtonStates() {
    if (isSpectator) {
        disableButtons();
        return;
    }

    const canPlay = (isBatting && batterSelected) || (!isBatting && bowlerSelected);
    buttons.forEach(btn => {
        btn.disabled = !canPlay;
    });
    
    timeoutBtn.disabled = !(timeoutAvailable && !timeoutActive && canPlay);
    
    // Enable DRS only when eligible
    const showDRS = isBatting && drsReviewsAvailable > 0 && 
                   ballByBall[legalBalls-1]?.wicket && 
                   ballByBall[legalBalls-1]?.batter === currentBatter &&
                   ballByBall[legalBalls-1]?.cardValue <= 3;
    
    drsContainer.style.display = showDRS ? 'block' : 'none';
    drsButton.disabled = !showDRS;
    
    if (canPlay) {
        resultEl.innerText = isBatting ? "Select your shot" : "Select your delivery";
    }
}

function setupSpectatorMode() {
    // Disable all interactive elements
    disableButtons();
    document.querySelectorAll('button').forEach(btn => btn.disabled = true);
    document.getElementById('cardButtons').style.display = 'none';
    document.getElementById('drsContainer').style.display = 'none';
    document.getElementById('timeoutBtn').style.display = 'none';
    document.getElementById('controls').style.display = 'none';
    
    // Update role text
    roleText.textContent = "SPECTATOR MODE";
    roleText.style.background = "var(--purple)";
    
    // Show connection status for both players
    const connectionContainer = document.createElement('div');
    connectionContainer.className = 'connection-status-container';
    connectionContainer.innerHTML = `
        <div class="connection-status" id="player1Status">Player 1: Offline</div>
        <div class="connection-status" id="player2Status">Player 2: Offline</div>
    `;
    document.querySelector('.container').insertBefore(connectionContainer, document.querySelector('.scoreboard'));
    
    // Listen for player connections
    onValue(ref(db, `rooms/${room}/player1`), (snap) => {
        const status = snap.exists() && snap.val() ? 'online' : 'offline';
        document.getElementById('player1Status').textContent = `Player 1: ${status === 'online' ? 'Online' : 'Offline'}`;
        document.getElementById('player1Status').className = `connection-status ${status}`;
    });
    
    onValue(ref(db, `rooms/${room}/player2`), (snap) => {
        const status = snap.exists() && snap.val() ? 'online' : 'offline';
        document.getElementById('player2Status').textContent = `Player 2: ${status === 'online' ? 'Online' : 'Offline'}`;
        document.getElementById('player2Status').className = `connection-status ${status}`;
    });
    
    // Enhanced spectator UI
    const spectatorControls = document.createElement('div');
    spectatorControls.className = 'spectator-controls';
    spectatorControls.innerHTML = `
        <button id="refreshStatsBtn" class="control-btn">🔄 Refresh</button>
        <button id="fullSummaryBtn" class="control-btn">📊 Full Summary</button>
        <button id="viewPollBtn" class="control-btn">📊 View Poll</button>
    `;
    document.querySelector('.container').appendChild(spectatorControls);
    
    // Setup spectator controls
    document.getElementById('refreshStatsBtn').addEventListener('click', () => {
        updateAllDisplays();
        showNotification("Stats refreshed", 'info');
    });
    
    document.getElementById('fullSummaryBtn').addEventListener('click', () => {
        showMatchSummary();
    });
    
    document.getElementById('viewPollBtn').addEventListener('click', () => {
        pollContainer.style.display = 'flex';
    });
    
    // Setup poll for spectators
    setupSpectatorPoll();
}

function setupSpectatorPoll() {
    // Create a more detailed poll for spectators
    pollQuestion.textContent = "Who will win this match?";
    pollOptions.innerHTML = `
        <div class="poll-option">
            <input type="radio" name="pollOption" id="pollOption1" value="${team1NameEl.textContent}">
            <label for="pollOption1">${team1NameEl.textContent}</label>
        </div>
        <div class="poll-option">
            <input type="radio" name="pollOption" id="pollOption2" value="${team2NameEl.textContent}">
            <label for="pollOption2">${team2NameEl.textContent}</label>
        </div>
        <div class="poll-option">
            <input type="radio" name="pollOption" id="pollOption3" value="Tie">
            <label for="pollOption3">Tie</label>
        </div>
    `;
    
    // Listen for poll updates
    onValue(pollRef, (snap) => {
        if (snap.exists()) {
            const pollData = snap.val();
            const votes = Object.values(pollData);
            const voteCount = {
                [team1NameEl.textContent]: 0,
                [team2NameEl.textContent]: 0,
                'Tie': 0
            };
            
            votes.forEach(vote => {
                if (voteCount.hasOwnProperty(vote.option)) {
                    voteCount[vote.option]++;
                }
            });
            
            // Update poll display with percentages
            const totalVotes = votes.length;
            document.querySelectorAll('#pollOptions .poll-option').forEach(option => {
                const optionValue = option.querySelector('input').value;
                const count = voteCount[optionValue] || 0;
                const percentage = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
                option.querySelector('label').textContent = 
                    `${optionValue}: ${count} votes (${percentage}%)`;
                
                // Add visual bar
                if (!option.querySelector('.poll-bar')) {
                    const bar = document.createElement('div');
                    bar.className = 'poll-bar';
                    bar.style.width = `${percentage}%`;
                    option.appendChild(bar);
                } else {
                    option.querySelector('.poll-bar').style.width = `${percentage}%`;
                }
            });
        }
    });
    
    // Submit vote handler
    pollSubmit.addEventListener('click', () => {
        const selectedOption = document.querySelector('input[name="pollOption"]:checked');
        if (!selectedOption) {
            showNotification("Please select an option", 'error');
            return;
        }
        
        if (votedInPoll) {
            showNotification("You've already voted", 'error');
            return;
        }
        
        const vote = {
            voter: `spectator-${Math.random().toString(36).substr(2, 8)}`,
            option: selectedOption.value,
            timestamp: Date.now()
        };
        
        push(pollRef, vote);
        votedInPoll = true;
        pollSubmit.disabled = true;
        showNotification("Vote submitted!", 'info');
    });
}

// Initialize the game
async function initGame() {
    try {
        console.log("Starting game initialization...");
        resultEl.innerText = "Initializing game...";
        loadingSpinner.style.display = "block";

        // Verify URL parameters
        if (!room || !player) {
            throw new Error("Missing room or player parameters in URL");
        }

        // Check if spectator mode
        isSpectator = player === "spectator";
        if (isSpectator) {
            setupSpectatorMode();
            return;
        }

        // Set player online status
        await set(playerRef, true);

        // Load room data
        const roomSnap = await get(roomRef);
        if (!roomSnap.exists()) throw new Error("Room not found");

        const roomData = roomSnap.val();
        console.log("Room data loaded:", roomData);

        // Verify game setup
        if (!roomData.toss?.winner && !roomData.tossWinner) {
            throw new Error("Toss not completed");
        }
        
        if (!roomData.teams?.player1 || !roomData.teams?.player2) {
            throw new Error("Teams not set up");
        }

        // Get toss and batting first info
        tossWinner = roomData.toss?.winner || roomData.tossWinner;
        battingFirst = roomData.toss?.battingFirst || roomData.battingFirst;
        
        // Update team names display
        team1NameEl.textContent = roomData.teams.player1.name || "Team 1";
        team2NameEl.textContent = roomData.teams.player2.name || "Team 2";
        battingTeamName.textContent = roomData.teams.player1.name || "Team 1";

        // Mark game as started if not already
        if (!roomData.gameStarted) {
            await update(roomRef, {
                gameStarted: true
            });
        }

        // Load teams
        await loadPlaying11();

        // Set game format
        const format = roomData.player1?.format || "5";
        currentFormat = formatRules[format];
        
        formatDisplay.innerText = `${currentFormat.name}`;
        
        // Initialize stats
        initializeBatterStats();
        initializeBowlerStats();

        // Set up game components
        setupConnectionMonitoring();
        await setupRole();
        setupSelectionModal();
        setupCardButtons();
        setupFirebaseListeners();
        setupTeamsModal();
        setupDRS();
        setupTimeoutSystem();
        setupSocialFeatures();
        
        // Set up control buttons
        saveBtn.addEventListener("click", saveGameState);
        exitBtn.addEventListener("click", async () => {
            if (confirm("Exit without saving?")) {
                await resetGame();
                window.location.href = "index.html";
            }
        });
        
        resetPlaysBtn.addEventListener("click", async () => {
            if (confirm("Request to reset the current plays? This will notify your opponent.")) {
                await requestReset();
            }
        });

        // Setup commentary controls
        pauseCommentaryBtn.addEventListener('click', function() {
            commentaryPaused = !commentaryPaused;
            this.textContent = commentaryPaused ? 'Resume' : 'Pause';
        });

        clearCommentaryBtn.addEventListener('click', function() {
            commentaryBox.innerHTML = '';
        });

        // Setup second innings button
        startSecondInningsBtn.addEventListener('click', startSecondInnings);

        // Initial UI update
        updateAllDisplays();
        resultEl.innerText = "Game ready!";
        loadingSpinner.style.display = "none";
        
        // Start ambient crowd noise
        crowdSound.volume = 0.3;
        playSound(crowdSound);
    } catch (error) {
        console.error("Initialization failed:", error);
        resultEl.innerHTML = `Initialization failed: ${error.message}<br>
                           <button onclick="initGame()" style="margin-top:10px; padding: 8px 15px; background: #1e88e5; color: white; border: none; border-radius: 5px; cursor: pointer;">
                             Retry Initialization
                           </button>`;
        resultEl.className = "error";
        loadingSpinner.style.display = "none";
    }
}

// Start the game
initGame().catch(error => {
    console.error("Uncaught initialization error:", error);
    document.getElementById("result").innerHTML = `
        Fatal error: ${error.message}<br>
        Please refresh or check console for details.
    `;
    document.getElementById("result").className = "error";
});
</script>
</html>