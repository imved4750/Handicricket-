<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HandiCricket - First Innings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* Base Styles */
    body { 
      background: #061e3e url('stadium-bg.jpg') no-repeat center center fixed; 
      background-size: cover;
      color: white; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      text-align: center; 
      padding: 8px;
      margin: 0;
      overflow-x: hidden;
      position: relative;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: -1;
    }
    
    h1 { 
      margin: 8px 0 12px;
      color: #ffeb3b;
      text-shadow: 0 0 5px rgba(255, 235, 59, 0.5);
      font-size: 1.5rem;
    }
    
    .container {
      max-width: 100%;
      width: 100%;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 8px;
      box-sizing: border-box;
      position: relative;
      backdrop-filter: blur(5px);
    }
    
    /* Pitch Design */
    .pitch {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 500px;
      height: 150px;
      background: linear-gradient(to bottom, #4a7c3a, #3a6a2a);
      border-radius: 50% 50% 0 0;
      z-index: -1;
      box-shadow: 0 -10px 20px rgba(0,0,0,0.5);
    }
    
    .pitch::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 60px;
      background: linear-gradient(to bottom, #4a7c3a, #3a6a2a);
      border: 2px solid #fff;
      border-radius: 5px;
    }
    
    /* Scoreboard Styles */
    .scorebox-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px;
      background: rgba(13, 42, 82, 0.8);
      border-radius: 8px;
      border: 2px solid #1e88e5;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
    }

    .scorebox-main::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #1e88e5, #4CAF50, #FFC107, #F44336);
    }

    .team-score {
      display: flex;
      flex-direction: column;
    }

    .score-large {
      font-size: 1.8rem;
      font-weight: bold;
      color: #ffeb3b;
      text-shadow: 0 0 8px rgba(255, 235, 59, 0.7);
    }

    .score-details {
      text-align: right;
      font-size: 0.85rem;
    }
    
    /* Mini Scorecard */
    .mini-scorecard {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 100;
      border: 1px solid #1e88e5;
      display: none;
    }
    
    /* Live Score Ticker */
    .score-ticker {
      position: fixed;
      bottom: 160px;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.8);
      color: #FFC107;
      padding: 6px;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      z-index: 90;
    }
    
    .ticker-content {
      display: inline-block;
      padding-left: 100%;
      animation: ticker 20s linear infinite;
    }
    
    @keyframes ticker {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    
    /* Match Info Bar */
    .match-info-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(13, 42, 82, 0.5);
      padding: 6px 8px;
      border-radius: 6px;
      margin: 4px 0 8px 0;
      font-size: 0.75rem;
      gap: 6px;
      flex-wrap: wrap;
    }

    .match-info-item {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 45%;
    }

    .divider {
      color: #666;
      flex-shrink: 0;
    }
    
    /* Player Spotlight */
    .player-spotlight {
      position: relative;
      padding: 8px;
      margin: 8px 0;
      border-radius: 8px;
      background: rgba(30, 136, 229, 0.2);
      animation: glow 2s infinite alternate;
    }
    
    @keyframes glow {
      from { box-shadow: 0 0 5px rgba(30, 136, 229, 0.5); }
      to { box-shadow: 0 0 15px rgba(30, 136, 229, 0.8); }
    }
    
    /* Over Progress */
    .over-progress {
      background: rgba(13, 42, 82, 0.5);
      padding: 6px;
      border-radius: 6px;
      margin: 6px 0;
    }

    .over-title {
      font-size: 0.75rem;
      color: #aaa;
      margin-bottom: 4px;
    }

    .balls-container {
      display: flex;
      gap: 4px;
      justify-content: center;
    }

    .ball {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
      transition: transform 0.3s;
    }
    
    .ball:hover {
      transform: scale(1.2);
    }

    .ball.dot {
      background: #333;
      color: white;
    }

    .ball.run {
      background: #4CAF50;
      color: white;
    }

    .ball.wicket {
      background: #F44336;
      color: white;
    }

    .ball.wide {
      background: #FF9800;
      color: white;
    }

    .ball.noball {
      background: #9C27B0;
      color: white;
    }

    .ball.empty {
      background: rgba(255,255,255,0.1);
    }

    .over-number {
      text-align: right;
      font-size: 0.75rem;
      margin-top: 4px;
      color: #aaa;
    }

    /* Commentary Box Styles */
    .commentary-container {
      background: rgba(13, 42, 82, 0.7);
      border-radius: 8px;
      margin: 8px 0;
      overflow: hidden;
      max-height: 200px;
      display: flex;
      flex-direction: column;
    }

    .commentary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      background: rgba(30, 136, 229, 0.3);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .commentary-header h4 {
      margin: 0;
      font-size: 0.85rem;
    }

    .commentary-controls button {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.65rem;
      margin-left: 4px;
      cursor: pointer;
    }

    .commentary-box {
      flex: 1;
      overflow-y: auto;
      padding: 6px;
      font-size: 0.8rem;
    }

    .commentary-item {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      animation: fadeIn 0.3s ease-in;
    }

    .commentary-item:last-child {
      border-bottom: none;
    }

    .commentary-item.wicket {
      color: #F44336;
    }

    .commentary-item.boundary {
      color: #FFC107;
    }

    .commentary-item.milestone {
      color: #4CAF50;
    }

    .commentary-time {
      color: #aaa;
      font-size: 0.65rem;
      margin-right: 4px;
    }

    /* Timeline Styles */
    .timeline-container {
      background: rgba(13, 42, 82, 0.7);
      border-radius: 8px;
      margin: 8px 0;
      padding: 6px;
    }

    .timeline-container h4 {
      margin: 0 0 6px 0;
      font-size: 0.85rem;
    }

    .timeline {
      display: flex;
      overflow-x: auto;
      gap: 6px;
      padding-bottom: 4px;
    }

    .timeline-item {
      min-width: 70px;
      padding: 4px;
      border-radius: 4px;
      background: rgba(30, 136, 229, 0.2);
      font-size: 0.7rem;
      text-align: center;
      flex-shrink: 0;
    }

    .timeline-item.wicket {
      background: rgba(244, 67, 54, 0.2);
      border-left: 2px solid #F44336;
    }

    .timeline-item.boundary {
      background: rgba(255, 193, 7, 0.2);
      border-left: 2px solid #FFC107;
    }

    .timeline-item.milestone {
      background: rgba(76, 175, 80, 0.2);
      border-left: 2px solid #4CAF50;
    }

    .timeline-over {
      font-weight: bold;
      margin-bottom: 2px;
    }

    .timeline-event {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Player Comparison Styles - Enhanced */
    .comparison-container {
      background: rgba(13, 42, 82, 0.7);
      border-radius: 8px;
      margin: 8px 0;
      padding: 6px;
    }

    .comparison-container h4 {
      margin: 0 0 6px 0;
      font-size: 0.85rem;
    }

    .comparison-box {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .player-comparison {
      flex: 1;
      padding: 6px;
      border-radius: 6px;
      text-align: center;
    }

    .batter-comparison {
      background: rgba(76, 175, 80, 0.1);
      border-left: 3px solid #4CAF50;
    }

    .bowler-comparison {
      background: rgba(244, 67, 54, 0.1);
      border-left: 3px solid #F44336;
    }

    .comparison-header {
      font-size: 0.65rem;
      text-transform: uppercase;
      color: #aaa;
      margin-bottom: 4px;
    }

    .comparison-name {
      font-weight: bold;
      margin: 4px 0;
      font-size: 0.85rem;
    }

    .comparison-stats {
      font-size: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .comparison-stats div {
      flex: 1;
      min-width: 50%;
      margin: 2px 0;
    }

    .vs-circle {
      width: 30px;
      height: 30px;
      background: #1e88e5;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.65rem;
    }

    /* Stats Graphs */
    .stats-graph {
      margin: 10px 0;
      padding: 10px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 8px;
    }
    
    .graph-title {
      font-size: 0.8rem;
      margin-bottom: 5px;
      color: #aaa;
    }
    
    .graph-bars {
      display: flex;
      height: 100px;
      align-items: flex-end;
      justify-content: space-around;
    }
    
    .graph-bar {
      width: 20px;
      background: #1e88e5;
      position: relative;
      transition: height 0.5s;
    }
    
    .graph-bar-label {
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.6rem;
      white-space: nowrap;
    }
    
    /* Momentum Bars */
    .momentum-container {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
    }
    
    .momentum-bar {
      height: 10px;
      border-radius: 5px;
      background: #333;
      flex: 1;
      margin: 0 5px;
      overflow: hidden;
      position: relative;
    }
    
    .momentum-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #FFC107);
      width: 0%;
      transition: width 0.5s;
    }
    
    .momentum-label {
      font-size: 0.7rem;
      margin-bottom: 3px;
    }
    
    /* DRS System */
    .drs-container {
      margin: 10px 0;
      padding: 10px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 8px;
      text-align: center;
    }
    
    .drs-button {
      background: #9C27B0;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      margin: 5px;
    }
    
    .drs-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .drs-status {
      font-size: 0.7rem;
      margin-top: 5px;
    }
    
    /* Animations */
    @keyframes scoreIncrease {
      0% { transform: scale(1); color: white; }
      50% { transform: scale(1.3); color: #4CAF50; }
      100% { transform: scale(1); color: white; }
    }

    @keyframes wicketFlash {
      0% { background-color: rgba(244, 67, 54, 0); }
      50% { background-color: rgba(244, 67, 54, 0.3); }
      100% { background-color: rgba(244, 67, 54, 0); }
    }

    @keyframes boundary {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); color: #FFC107; }
      100% { transform: scale(1); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    @keyframes ripple {
      0% { transform: scale(0.8); opacity: 1; }
      100% { transform: scale(3); opacity: 0; }
    }
    
    @keyframes explode {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(3); opacity: 0; }
    }

    .score-change {
      animation: scoreIncrease 0.8s ease-in-out;
    }

    .wicket-flash {
      animation: wicketFlash 1.5s ease-in-out;
    }

    .boundary-flash {
      animation: boundary 1s ease-in-out;
    }
    
    .shake {
      animation: shake 0.5s;
    }
    
    .ripple {
      position: relative;
      overflow: hidden;
    }
    
    .ripple::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: ripple 1s;
    }
    
    .explode {
      position: relative;
    }
    
    .explode::after {
      content: 'üí•';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: explode 0.5s;
      z-index: 10;
    }

    /* Card Buttons */
    .card-btns { 
      margin: 10px auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      position: relative;
    }
    
    .card-btns button { 
      width: 50px;
      height: 50px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(145deg, #1e88e5, #1565c0);
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      transition: all 0.2s;
      position: relative;
    }
    
    .card-btns button.six {
      background: linear-gradient(145deg, #FFC107, #FF9800);
      color: #000;
    }
    
    .card-btns button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
    }
    
    .card-btns button:active {
      transform: translateY(1px);
    }
    
    .card-btns button:disabled { 
      background: #607d8b;
      color: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .card-btns button.selected {
      background: #4caf50;
      border: 2px solid #ffeb3b;
      transform: scale(1.05);
    }
    
    /* Status Indicators */
    #statusIndicators {
      margin: 6px 0;
      display: flex;
      justify-content: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .free-hit-indicator,
    .powerplay-indicator,
    .dead-over {
      padding: 3px 6px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      margin: 0 2px;
      display: inline-block;
    }
    
    .free-hit-indicator {
      background: #4CAF50;
      color: white;
    }
    
    .powerplay-indicator {
      background: #ffeb3b;
      color: #000;
    }
    
    .dead-over {
      background: #f44336;
      color: white;
    }
    
    /* Result Display */
    #result {
      font-size: 15px;
      margin: 8px 0;
      padding: 6px;
      min-height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #result.error {
      color: #ff4444;
      background: rgba(255, 0, 0, 0.1);
      padding: 6px;
      border-radius: 4px;
      border-left: 3px solid #ff4444;
    }
    
    /* Connection Status */
    #connectionStatus {
      padding: 6px;
      border-radius: 6px;
      text-align: center;
      margin: 8px auto;
      max-width: 250px;
      font-weight: bold;
      font-size: 13px;
    }
    
    .online { 
      background: #4CAF50;
      color: white;
    }
    
    .offline { 
      background: #F44336;
      color: white;
    }
    
    /* Selection Modal */
    .selection-modal { 
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 350px;
      background: linear-gradient(145deg, #123456, #0a1f3a);
      padding: 10px;
      border-radius: 12px;
      margin-bottom: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 100;
      display: none;
    }
    
    .selection-list { 
      max-height: 50vh;
      overflow-y: auto;
      margin: 6px 0;
      padding-right: 4px;
    }
    
    .player-item, .batter-item {
      padding: 6px;
      margin: 3px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      font-size: 13px;
    }
    
    .player-item:hover, .batter-item:hover {
      background: rgba(30, 136, 229, 0.4);
      transform: translateX(5px);
    }
    
    .player-item.selected, .batter-item.selected {
      background: rgba(13, 71, 161, 0.6);
      border-left: 3px solid #ffeb3b;
    }
    
    /* Top Controls */
    #topControls {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    #topControls button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    #saveBtn { 
      background: #FF9800;
      color: white;
    }
    
    #saveBtn:hover {
      background: #F57C00;
    }
    
    #exitBtn { 
      background: #f44336;
      color: white;
    }
    
    #exitBtn:hover {
      background: #d32f2f;
    }
    
    #resetPlaysBtn { 
      background: #9c27b0;
      color: white;
    }
    
    #resetPlaysBtn:hover {
      background: #7b1fa2;
    }
    
    /* Teams Modal */
    .teams-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .teams-container {
      width: 90%;
      max-width: 320px;
      height: 65vh;
      display: flex;
      overflow: hidden;
      position: relative;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    .team-slide {
      min-width: 100%;
      height: 100%;
      padding: 8px;
      background: rgba(13, 42, 82, 0.9);
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      overflow-y: auto;
      scroll-snap-align: start;
      flex-shrink: 0;
      box-sizing: border-box;
    }

    .team-slide h3 {
      text-align: center;
      margin-bottom: 6px;
      color: #ffeb3b;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 3px;
      font-size: 0.95rem;
      position: sticky;
      top: 0;
      background: rgba(13, 42, 82, 0.9);
      z-index: 1;
    }

    .team-slide ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .team-slide li {
      padding: 6px 8px;
      margin: 3px 0;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 6px;
      border-left: 2px solid #1e88e5;
      transition: all 0.3s;
      font-size: 13px;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .team-slide li:hover {
      background: rgba(30, 136, 229, 0.4);
      transform: translateX(5px);
    }

    .close-teams {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 16px;
      cursor: pointer;
      z-index: 1001;
    }

    .teams-nav {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 12px;
    }

    .team-nav-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      background: #1e88e5;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }

    .team-nav-btn:disabled {
      background: #666;
      cursor: not-allowed;
    }

    .team-nav-indicator {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .team-nav-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #555;
      cursor: pointer;
    }

    .team-nav-dot.active {
      background: #1e88e5;
    }

    .show-teams-btn {
      padding: 8px 16px;
      font-size: 13px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #9c27b0, #7b1fa2);
      color: white;
      cursor: pointer;
      margin: 12px auto;
      display: block;
      transition: all 0.3s;
    }

    .show-teams-btn:hover {
      background: linear-gradient(135deg, #7b1fa2, #6a1b9a);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Team Names Display */
    .team-names-compact {
      margin-bottom: 8px;
      font-size: 13px;
      background: rgba(13, 42, 82, 0.5);
      padding: 6px;
      border-radius: 6px;
      text-align: center;
    }

    .team-name-line {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 4px;
    }

    .team-label {
      color: #aaa;
      font-size: 11px;
    }

    .team-divider {
      color: #666;
      margin: 0 4px;
    }

    /* Over Summary */
    .over-summary-container {
      margin: 8px 0;
      padding: 6px;
      background: rgba(13, 42, 82, 0.5);
      border-radius: 6px;
      max-height: 100px;
      overflow-y: auto;
    }

    .over-summary-item {
      padding: 3px;
      margin: 3px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 12px;
    }

    /* Spectator Mode */
    .spectator-mode {
      background: #9c27b0;
      padding: 3px 6px;
      border-radius: 15px;
      margin-bottom: 6px;
      display: inline-block;
      font-size: 11px;
    }

    /* Milestone Notifications */
    .milestone-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 15px;
      z-index: 1001;
      animation: fadeInOut 3s forwards;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }
    
    .milestone-notification.batting {
      border-left: 4px solid #4CAF50;
    }
    
    .milestone-notification.error {
      border-left: 4px solid #F44336;
    }
    
    .milestone-notification.info {
      border-left: 4px solid #FFC107;
    }
    
    .milestone-notification.winner {
      border-left: 4px solid #9C27B0;
      font-size: 18px;
    }
    
    /* Confetti */
    .confetti {
      position: fixed;
      width: 8px;
      height: 8px;
      background-color: #f00;
      animation: confetti-fall 5s linear forwards;
      z-index: 1000;
    }
    
    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }
    
    /* Loading Spinner */
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #1e88e5;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 12px auto;
      display: none;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Reset Notification */
    .reset-notification {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 1001;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      gap: 6px;
      width: 80%;
      max-width: 280px;
    }
    
    .reset-notification-buttons {
      display: flex;
      justify-content: center;
      gap: 6px;
    }
    
    .reset-notification button {
      padding: 4px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 11px;
    }
    
    .reset-accept {
      background: #4CAF50;
      color: white;
    }
    
    .reset-decline {
      background: #f44336;
      color: white;
    }
    
    /* Innings Summary Popup */
    .summary-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(145deg, #123456, #0a1f3a);
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1001;
      text-align: center;
      color: white;
      max-width: 320px;
      width: 90%;
      display: none;
    }
    
    .summary-popup h3 {
      margin-top: 0;
      color: #ffeb3b;
      font-size: 1.2rem;
      border-bottom: 2px solid #1e88e5;
      padding-bottom: 6px;
      margin-bottom: 12px;
    }
    
    .summary-content {
      text-align: left;
      margin-bottom: 12px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 13px;
    }
    
    .summary-label {
      color: #aaa;
    }
    
    .summary-value {
      font-weight: bold;
    }
    
    .summary-highlight {
      background: rgba(255, 235, 59, 0.2);
      padding: 4px;
      border-radius: 4px;
      margin: 8px 0;
      font-weight: bold;
    }
    
    .summary-countdown {
      font-size: 22px;
      font-weight: bold;
      margin: 8px 0;
      color: #4CAF50;
    }
    
    .summary-popup button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.3s;
    }
    
    .summary-popup button:hover {
      background: #388E3C;
      transform: scale(1.05);
    }
    
    /* Newspaper Style Summary */
    .newspaper-summary {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f5f5f5;
      z-index: 1002;
      display: none;
      overflow-y: auto;
      color: #333;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .newspaper-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #333;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    
    .newspaper-title {
      font-family: 'Times New Roman', Times, serif;
      font-size: 24px;
      font-weight: bold;
    }
    
    .newspaper-date {
      font-size: 14px;
      color: #666;
    }
    
    .newspaper-headline {
      font-size: 32px;
      font-weight: bold;
      margin: 20px 0;
      text-align: center;
      font-family: 'Times New Roman', Times, serif;
    }
    
    .newspaper-subhead {
      font-size: 18px;
      margin-bottom: 20px;
      text-align: center;
      font-style: italic;
    }
    
    .newspaper-content {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .newspaper-column {
      flex: 1;
      min-width: 300px;
    }
    
    .newspaper-section {
      margin-bottom: 20px;
    }
    
    .newspaper-section-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 10px;
      border-bottom: 1px solid #333;
      padding-bottom: 5px;
    }
    
    .scorecard-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .scorecard {
      background: white;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .scorecard-header {
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
      background: #f0f0f0;
      padding: 5px;
      border-radius: 3px;
    }
    
    .scorecard-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .player-of-match {
      background: #ffeb3b;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
      text-align: center;
      font-weight: bold;
    }
    
    .match-result {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin: 20px 0;
      color: #1e88e5;
    }
    
    .newspaper-image {
      width: 100%;
      height: 200px;
      background: #ddd;
      margin: 15px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-style: italic;
    }
    
    .close-newspaper {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #333;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      z-index: 1003;
    }
    
    .share-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }
    
    .share-button {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .share-twitter {
      background: #1DA1F2;
    }
    
    .share-facebook {
      background: #4267B2;
    }
    
    .share-whatsapp {
      background: #25D366;
    }
    
    /* Responsive Styles */
    @media (max-width: 768px) {
      .card-btns button {
        width: 45px;
        height: 45px;
        font-size: 16px;
      }
      
      .selection-modal {
        width: 95%;
        max-height: 60vh;
      }
      
      .teams-container {
        width: 95%;
        max-width: 350px;
        height: 55%;
      }
      
      .team-slide {
        min-width: 100%;
      }
      
      .newspaper-column {
        min-width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 6px;
      }
      
      .container {
        padding: 8px;
      }
      
      h1 {
        font-size: 1.3rem;
        margin: 6px 0 10px;
      }
      
      .card-btns button {
        width: 40px;
        height: 40px;
        font-size: 15px;
      }
      
      .selection-modal {
        padding: 8px;
      }
      
      .player-item, .batter-item {
        padding: 5px;
        font-size: 12px;
      }
      
      #topControls button {
        padding: 5px 8px;
        font-size: 10px;
      }
      
      .team-slide h3 {
        font-size: 0.9rem;
      }
      
      .team-slide li {
        font-size: 11px;
        padding: 5px 6px;
      }
      
      .team-names {
        flex-direction: column;
        gap: 4px;
      }
      
      .teams-container {
        height: 70vh;
        max-width: 300px;
      }

      .score-large {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="pitch"></div>
  <div class="mini-scorecard" id="miniScorecard"></div>
  <div class="score-ticker" id="scoreTicker">
    <div class="ticker-content" id="tickerContent"></div>
  </div>
  
  <div class="container">
    <div class="team-names-compact">
      <div class="team-name-line">
        <span class="team-label">Batting:</span>
        <span id="team1Name">Team A</span>
        <span class="team-divider">|</span>
        <span class="team-label">Bowling:</span>
        <span id="team2Name">Team B</span>
      </div>
    </div>
    
    <!-- Enhanced Scoreboard -->
    <div class="scorebox">
      <div class="scorebox-main">
        <div class="team-score">
          <span id="battingTeamName">Team A</span>
          <span class="score-large"><span id="runs">0</span>/<span id="wickets">0</span></span>
        </div>
        <div class="score-details">
          <div>Overs: <strong id="overs">0.0</strong></div>
          <div>Run Rate: <strong id="runRate">0.00</strong></div>
        </div>
      </div>
    </div>
    
    <!-- Match Info Bar -->
    <div class="match-info-bar">
      <div class="match-format" id="formatDisplay"></div>
      <div class="match-status">
        <span id="inningsNumber">1st Innings</span>
        <span class="divider">|</span>
        <span id="roleText"></span>
      </div>
      <div class="match-time">
        <span id="currentTime">14:30</span>
        <span class="divider">|</span>
        <span id="matchDate">23 Jul 2023</span>
      </div>
    </div>
    
    <!-- Player Spotlight -->
    <div class="player-spotlight" id="playerSpotlight" style="display: none;">
      <div id="spotlightContent"></div>
    </div>
    
    <!-- Over Progress -->
    <div class="over-progress">
      <div class="over-title">Current Over</div>
      <div class="balls-container" id="ballsContainer">
        <!-- Balls will be added dynamically -->
      </div>
      <div class="over-number">Over <span id="currentOverNumber">1</span></div>
    </div>
    
    <!-- Stats Graphs -->
    <div class="stats-graph" id="runRateGraph" style="display: none;">
      <div class="graph-title">Run Rate Comparison</div>
      <div class="graph-bars" id="rrGraphBars"></div>
    </div>
    
    <!-- Momentum Bars -->
    <div class="momentum-container" id="momentumContainer" style="display: none;">
      <div>
        <div class="momentum-label">Batter Momentum</div>
        <div class="momentum-bar">
          <div class="momentum-fill" id="batterMomentum"></div>
        </div>
      </div>
      <div>
        <div class="momentum-label">Bowler Momentum</div>
        <div class="momentum-bar">
          <div class="momentum-fill" id="bowlerMomentum"></div>
        </div>
      </div>
    </div>
    
    <!-- DRS System -->
    <div class="drs-container" id="drsContainer" style="display: none;">
      <button class="drs-button" id="drsButton">Request Review</button>
      <div class="drs-status" id="drsStatus">Reviews remaining: 1</div>
    </div>
    
    <!-- Commentary Box -->
    <div class="commentary-container">
      <div class="commentary-header">
        <h4>Match Commentary</h4>
        <div class="commentary-controls">
          <button id="pauseCommentary">Pause</button>
          <button id="clearCommentary">Clear</button>
        </div>
      </div>
      <div class="commentary-box" id="commentaryBox">
        <!-- Commentary items will be added here -->
      </div>
    </div>
    
    <!-- Match Timeline -->
    <div class="timeline-container">
      <h4>Match Timeline</h4>
      <div class="timeline" id="matchTimeline">
        <!-- Timeline items will be added here -->
      </div>
    </div>
    
    <!-- Enhanced Player Comparison -->
    <div class="comparison-container">
      <h4>Current Battle</h4>
      <div class="comparison-box">
        <div class="player-comparison batter-comparison">
          <div class="comparison-header">Batter</div>
          <div class="comparison-name" id="comparisonBatterName">-</div>
          <div class="comparison-stats">
            <div>Runs: <span id="comparisonBatterRuns">0</span></div>
            <div>Balls: <span id="comparisonBatterBalls">0</span></div>
            <div>SR: <span id="comparisonBatterSR">0.00</span></div>
            <div>4s/6s: <span id="comparisonBatterBoundaries">0/0</span></div>
          </div>
        </div>
        <div class="vs-circle">VS</div>
        <div class="player-comparison bowler-comparison">
          <div class="comparison-header">Bowler</div>
          <div class="comparison-name" id="comparisonBowlerName">-</div>
          <div class="comparison-stats">
            <div>Overs: <span id="comparisonBowlerOvers">0.0</span></div>
            <div>Wkts: <span id="comparisonBowlerWickets">0</span></div>
            <div>ER: <span id="comparisonBowlerER">0.00</span></div>
            <div>Runs: <span id="comparisonBowlerRuns">0</span></div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="statusIndicators">
      <span id="powerplayIndicator" class="powerplay-indicator" style="display: none;">Powerplay</span>
      <span id="deadOverIndicator" class="dead-over" style="display: none;">Dead Over</span>
      <span id="freeHitIndicator" class="free-hit-indicator" style="display: none;">Free Hit</span>
    </div>
    
    <div id="result">Initializing game...</div>
    
    <div class="card-btns" id="cardButtons">
      <button class="btn" data-value="0">0</button>
      <button class="btn" data-value="1">1</button>
      <button class="btn" data-value="2">2</button>
      <button class="btn" data-value="3">3</button>
      <button class="btn" data-value="4">4</button>
      <button class="btn" data-value="5">5</button>
      <button class="btn" data-value="6">6</button>
    </div>

    <div class="over-summary-container">
      <h4>Over Summary</h4>
      <div id="overSummaryList"></div>
    </div>

    <button class="show-teams-btn" id="showTeamsBtn">Show Teams</button>

    <div id="topControls">
      <button id="saveBtn">üíæ Save & Exit</button>
      <button id="exitBtn">üö™ Exit Without Saving</button>
      <button id="resetPlaysBtn">üîÑ Reset Plays</button>
      <button id="viewSummaryBtn">üì∞ Match Summary</button>
    </div>
    <div id="connectionStatus" class="online">
      Opponent: Online
    </div>
    
    <div id="loading-spinner" class="loading-spinner"></div>
  </div>
  
  <div id="selectionModal" class="selection-modal">
    <h3 id="selectionTitle">Select Next Batter</h3>
    <div id="selectionList" class="selection-list"></div>
    <button id="confirmSelection">Confirm Selection</button>
  </div>

  <div id="teamsModal" class="teams-modal">
    <button class="close-teams" id="closeTeamsBtn">√ó</button>
    <div class="teams-container" id="teamsSlider">
      <div class="team-slide" id="team1Slide">
        <h3 id="modalTeam1Name">Team 1</h3>
        <ul id="modalTeam1Players"></ul>
      </div>
      <div class="team-slide" id="team2Slide">
        <h3 id="modalTeam2Name">Team 2</h3>
        <ul id="modalTeam2Players"></ul>
      </div>
    </div>
    <div class="teams-nav">
      <button class="team-nav-btn" id="prevTeamBtn" disabled>Previous</button>
      <button class="team-nav-btn" id="nextTeamBtn">Next</button>
    </div>
    <div class="team-nav-indicator">
      <div class="team-nav-dot active" data-index="0"></div>
      <div class="team-nav-dot" data-index="1"></div>
    </div>
  </div>

  <!-- Modified Innings Summary Popup -->
  <div id="summaryPopup" class="summary-popup">
    <h3 id="summaryTitle">First Innings Summary</h3>
    <div class="summary-content">
      <div class="summary-row">
        <span class="summary-label">Total Runs:</span>
        <span class="summary-value" id="summaryTotalRuns">0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Wickets:</span>
        <span class="summary-value" id="summaryWickets">0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Overs:</span>
        <span class="summary-value" id="summaryOvers">0.0</span>
      </div>
      <div class="summary-row">
        <span class="summary-label">Run Rate:</span>
        <span class="summary-value" id="summaryRunRate">0.00</span>
      </div>
      <div class="summary-highlight" id="summaryHighlight"></div>
      <!-- Add target display for second innings -->
      <div class="summary-row" id="targetDisplay" style="display: none;">
        <span class="summary-label">Target:</span>
        <span class="summary-value" id="targetValue">0</span>
      </div>
    </div>
    <button id="startSecondInningsBtn">üèè Start Second Innings</button>
  </div>

  <!-- Newspaper Style Summary -->
  <div id="newspaperSummary" class="newspaper-summary">
    <button class="close-newspaper" id="closeNewspaperBtn">√ó</button>
    <div class="newspaper-header">
      <div class="newspaper-title">The Times of Cricket</div>
      <div class="newspaper-date" id="newspaperDate"></div>
    </div>
    
    <div class="newspaper-headline" id="newspaperHeadline"></div>
    <div class="newspaper-subhead" id="newspaperSubhead"></div>
    
    <div class="newspaper-image">Match Highlights Image</div>
    
    <div class="newspaper-content">
      <div class="newspaper-column">
        <div class="newspaper-section">
          <div class="newspaper-section-title">Match Report</div>
          <div id="matchReportContent"></div>
        </div>
        
        <div class="newspaper-section">
          <div class="newspaper-section-title">Key Moments</div>
          <div id="keyMomentsContent"></div>
        </div>
      </div>
      
      <div class="newspaper-column">
        <div class="scorecard-grid">
          <div class="scorecard">
            <div class="scorecard-header" id="innings1Header"></div>
            <div id="innings1Scorecard"></div>
          </div>
          
          <div class="scorecard">
            <div class="scorecard-header" id="innings2Header"></div>
            <div id="innings2Scorecard"></div>
          </div>
        </div>
        
        <div class="player-of-match" id="playerOfMatch"></div>
        
        <div class="match-result" id="newspaperResult"></div>
      </div>
    </div>
    
    <div class="share-buttons">
      <button class="share-button share-twitter">Share on Twitter</button>
      <button class="share-button share-facebook">Share on Facebook</button>
      <button class="share-button share-whatsapp">Share on WhatsApp</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, get, update, push, remove, child } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    let app;
    let db;

    try {
  app = initializeApp(firebaseConfig);
  db = getDatabase(app);
  console.log("Firebase initialized successfully");
} catch (error) {
  console.error("Firebase initialization failed:", error);
  document.getElementById("result").innerHTML = `
    Failed to connect to game server.<br>
    Please check your internet connection and refresh.<br>
    <button onclick="location.reload()" style="margin-top:10px; padding: 8px 15px; background: #1e88e5; color: white; border: none; border-radius: 5px; cursor: pointer;">
      Refresh Page
    </button>
  `;
  document.getElementById("result").className = "error";
  throw error; // This will stop further execution
    }

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const room = params.get('room');
    const player = params.get('player');
    
    if (!room || !player) {
  document.getElementById("result").innerHTML = `
    Missing required parameters in URL.<br>
    Please return to the main page and join the game again.<br>
    <button onclick="window.location.href='index.html'" style="margin-top:10px; padding: 8px 15px; background: #1e88e5; color: white; border: none; border-radius: 5px; cursor: pointer;">
      Return to Main Page
    </button>
  `;
  document.getElementById("result").className = "error";
  throw new Error("Missing room or player parameters"); // Stop execution
    }

    const opponent = player === "player1" ? "player2" : "player1";

    // Debug game parameters
    console.log("Game Parameters:", {
      room: room,
      player: player,
      opponent: opponent,
      url: window.location.href
    });

    // Firebase references
    const roomRef = ref(db, `rooms/${room}`);
    const playerRef = ref(db, `rooms/${room}/${player}`);
    const opponentRef = ref(db, `rooms/${room}/${opponent}`);
    const playsRef = ref(db, `rooms/${room}/currentPlays`);
    const batterRef = ref(db, `rooms/${room}/currentBatter`);
    const bowlerRef = ref(db, `rooms/${room}/currentBowler`);
    const teamsRef = ref(db, `rooms/${room}/teams`);
    const spectatorsRef = ref(db, `rooms/${room}/spectators`);
    const reactionsRef = ref(db, `rooms/${room}/reactions`);
    const matchStatsRef = ref(db, `rooms/${room}/matchStats`);
    const liveStateRef = ref(db, `rooms/${room}/liveState`);
    const overSummariesRef = ref(db, `rooms/${room}/overSummaries`);
    const resultRef = ref(db, `rooms/${room}/result`);
    const resetRequestRef = ref(db, `rooms/${room}/resetRequest`);
    const firstInningsRef = ref(db, `rooms/${room}/firstInnings`);
    const firstInningsCompletedRef = ref(db, `rooms/${room}/firstInningsCompleted`);
    const secondInningsStartedRef = ref(db, `rooms/${room}/secondInningsStarted`);
    
    // Format rules
    const formatRules = {
      "5": { 
        name: "5 Overs", 
        totalOvers: 5, 
        totalWickets: 10,
        powerplayOvers: 2, 
        powerplayWicketValue: 0.5,
        regularWicketValue: 1.0,
        deadOvers: []
      },
      "10": { 
        name: "10 Overs", 
        totalOvers: 10, 
        totalWickets: 10,
        powerplayOvers: 3, 
        powerplayWicketValue: 0.5,
        regularWicketValue: 1.0,
        deadOvers: []
      },
      "20": { 
        name: "T20", 
        totalOvers: 20, 
        totalWickets: 10,
        powerplayOvers: 6, 
        powerplayWicketValue: 0.5,
        regularWicketValue: 1.0,
        deadOvers: []
      },
      "50": { 
        name: "ODI", 
        totalOvers: 50, 
        totalWickets: 10,
        powerplayOvers: [1,10, 21,30, 41,42], 
        powerplayWicketValue: 0.25,
        regularWicketValue: 0.5,
        deadOvers: [11,20, 31,40]
      }
    };

    // Game state variables
    let runs = 0, wickets = 0;
    let legalBalls = 0;
    let freeHit = false;
    let freeHitNextBall = false;
    let currentBatter = null;
    let currentBowler = null;
    let battersUsed = [];
    let bowlersUsed = [];
    let bowlerOvers = {};
    let isBatting = false;
    let currentFormat = {};
    let isPowerplay = false;
    let isDeadOver = false;
    let batterWickets = {};
    let zerosThisOver = { player1: 0, player2: 0 };
    let bowlerRuns = {};
    let gameInProgress = true;
    let lastOverRuns = 0;
    let lastOverWickets = 0;
    let lastWicketScore = 0;
    let ballByBall = {};
    let fallOfWickets = [];
    let batterStats = {};
    let bowlerStats = {};
    let tossWinner = null;
    let battingFirst = null;
    const milestoneLevels = [50, 100, 150, 200, 250, 300, 350, 400];
    let batterSelected = false;
    let bowlerSelected = false;
    let team1Players = [];
    let team2Players = [];
    let batterPenalties = {};
    let lastBatterRuns = {};
    let resetRequested = false;
    let resetRequestedBy = null;
    let isResetting = false;
    let resetCount = 0;
    const MAX_RESETS = 999999999999999999;
    let selectedCardValue = null;
    let isProcessingSelection = false;
    let overSummaries = [];
    let isSpectator = false;
    let commentaryPaused = false;
    let firstInningsCompleted = false;
    let firstInningsData = null;
    let target = 0;
    let chasingTeam = null;
    let secondInningsStarted = false;
    
    // New features state
    let batterMomentum = 0;
    let bowlerMomentum = 0;
    let drsAvailable = 1;
    let lastFiveOversRuns = [];
    let lastFiveOversWickets = [];
    let matchHighlights = [];
    let playerReactions = {};
    let strategicTimeoutAvailable = true;

    // DOM elements
    const resultEl = document.getElementById("result");
    const scoreboard = document.querySelector(".scorebox");
    const buttons = document.querySelectorAll(".btn");
    const roleText = document.getElementById("roleText");
    const selectionModal = document.getElementById("selectionModal");
    const selectionTitle = document.getElementById("selectionTitle");
    const selectionList = document.getElementById("selectionList");
    const confirmSelection = document.getElementById("confirmSelection");
    const team1NameEl = document.getElementById("modalTeam1Name");
    const team2NameEl = document.getElementById("modalTeam2Name");
    const team1PlayersEl = document.getElementById("modalTeam1Players");
    const team2PlayersEl = document.getElementById("modalTeam2Players");
    const formatDisplay = document.getElementById("formatDisplay");
    const saveBtn = document.getElementById("saveBtn");
    const exitBtn = document.getElementById("exitBtn");
    const resetPlaysBtn = document.getElementById("resetPlaysBtn");
    const connectionStatus = document.getElementById("connectionStatus");
    const loadingSpinner = document.getElementById("loading-spinner");
    const powerplayIndicator = document.getElementById("powerplayIndicator");
    const deadOverIndicator = document.getElementById("deadOverIndicator");
    const freeHitIndicator = document.getElementById("freeHitIndicator");
    const showTeamsBtn = document.getElementById("showTeamsBtn");
    const teamsModal = document.getElementById("teamsModal");
    const closeTeamsBtn = document.getElementById("closeTeamsBtn");
    const teamsSlider = document.getElementById("teamsSlider");
    const overSummaryList = document.getElementById("overSummaryList");
    const team1NameDisplay = document.getElementById("team1Name");
    const team2NameDisplay = document.getElementById("team2Name");
    const prevTeamBtn = document.getElementById("prevTeamBtn");
    const nextTeamBtn = document.getElementById("nextTeamBtn");
    const battingTeamName = document.getElementById("battingTeamName");
    const commentaryBox = document.getElementById("commentaryBox");
    const pauseCommentaryBtn = document.getElementById("pauseCommentary");
    const clearCommentaryBtn = document.getElementById("clearCommentary");
    const summaryPopup = document.getElementById("summaryPopup");
    const summaryCountdown = document.getElementById("summaryCountdown");
    const startSecondInningsBtn = document.getElementById("startSecondInningsBtn");
    const summaryTotalRuns = document.getElementById("summaryTotalRuns");
    const summaryWickets = document.getElementById("summaryWickets");
    const summaryOvers = document.getElementById("summaryOvers");
    const summaryRunRate = document.getElementById("summaryRunRate");
    const summaryHighlight = document.getElementById("summaryHighlight");
    const targetDisplay = document.getElementById("targetDisplay");
    const targetValue = document.getElementById("targetValue");
    const viewSummaryBtn = document.getElementById("viewSummaryBtn");
    const newspaperSummary = document.getElementById("newspaperSummary");
    const closeNewspaperBtn = document.getElementById("closeNewspaperBtn");
    const newspaperDate = document.getElementById("newspaperDate");
    const newspaperHeadline = document.getElementById("newspaperHeadline");
    const newspaperSubhead = document.getElementById("newspaperSubhead");
    const matchReportContent = document.getElementById("matchReportContent");
    const keyMomentsContent = document.getElementById("keyMomentsContent");
    const innings1Header = document.getElementById("innings1Header");
    const innings1Scorecard = document.getElementById("innings1Scorecard");
    const innings2Header = document.getElementById("innings2Header");
    const innings2Scorecard = document.getElementById("innings2Scorecard");
    const playerOfMatch = document.getElementById("playerOfMatch");
    const newspaperResult = document.getElementById("newspaperResult");
    const playerSpotlight = document.getElementById("playerSpotlight");
    const spotlightContent = document.getElementById("spotlightContent");
    const miniScorecard = document.getElementById("miniScorecard");
    const scoreTicker = document.getElementById("scoreTicker");
    const tickerContent = document.getElementById("tickerContent");
    const runRateGraph = document.getElementById("runRateGraph");
    const rrGraphBars = document.getElementById("rrGraphBars");
    const momentumContainer = document.getElementById("momentumContainer");
    const batterMomentumBar = document.getElementById("batterMomentum");
    const bowlerMomentumBar = document.getElementById("bowlerMomentum");
    const drsContainer = document.getElementById("drsContainer");
    const drsButton = document.getElementById("drsButton");
    const drsStatus = document.getElementById("drsStatus");

    // Helper function with timeout
    async function setWithTimeout(ref, value, timeoutMs, timeoutMsg) {
      return Promise.race([
        set(ref, value),
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error(timeoutMsg)), timeoutMs)
        )
      ]);
    }

    // Helper function with retries
    async function getWithRetries(ref, maxRetries, delayMs) {
      let lastError;
      for (let i = 0; i < maxRetries; i++) {
        try {
          const snap = await get(ref);
          return snap;
        } catch (error) {
          lastError = error;
          console.log(`Attempt ${i+1} failed, retrying...`);
          await new Promise(resolve => setTimeout(resolve, delayMs));
        }
      }
      throw lastError;
    }

    // Enhanced loadPlaying11 function with validation
    async function loadPlaying11() {
      try {
        resultEl.innerText = "Loading teams...";
        
        const roomSnap = await get(roomRef);
        if (!roomSnap.exists()) throw new Error("Room not found");

        const teams = roomSnap.val().teams;
        if (!teams?.player1 || !teams?.player2) {
          throw new Error("Both teams must be submitted before starting");
        }

        // Clear previous data
        team1Players = [];
        team2Players = [];
        team1PlayersEl.innerHTML = '';
        team2PlayersEl.innerHTML = '';

        // Load Team 1
        if (teams.player1?.players) {
          team1NameEl.textContent = teams.player1.name || "Team A";
          team1NameDisplay.textContent = teams.player1.name || "Team A";
          battingTeamName.textContent = teams.player1.name || "Team A";
          team1Players = teams.player1.players;
          team1PlayersEl.innerHTML = team1Players.map(p => `<li>${p}</li>`).join('');
        }

        // Load Team 2
        if (teams.player2?.players) {
          team2NameEl.textContent = teams.player2.name || "Team B";
          team2NameDisplay.textContent = teams.player2.name || "Team B";
          team2Players = teams.player2.players;
          team2PlayersEl.innerHTML = team2Players.map(p => `<li>${p}</li>`).join('');
        }

        // Validate we have players
        if (team1Players.length === 0 || team2Players.length === 0) {
          throw new Error("Both teams must have at least 1 player");
        }

        return true;
      } catch (error) {
        console.error("Error loading teams:", error);
        showNotification(error.message, 'error');
        throw error;
      }
    }

    // Initialize batter stats with penalty tracking
    function initializeBatterStats() {
      team1Players.forEach(player => {
        batterStats[player] = batterStats[player] || { 
          runs: 0, balls: 0, fours: 0, sixes: 0,
          centuryNotified: false, fiftyNotified: false,
          momentum: 0, form: 50
        };
        batterWickets[player] = batterWickets[player] || 0;
        batterPenalties[player] = batterPenalties[player] || 0;
        lastBatterRuns[player] = 0;
      });
      
      team2Players.forEach(player => {
        batterStats[player] = batterStats[player] || { 
          runs: 0, balls: 0, fours: 0, sixes: 0,
          centuryNotified: false, fiftyNotified: false,
          momentum: 0, form: 50
        };
        batterWickets[player] = batterWickets[player] || 0;
        batterPenalties[player] = batterPenalties[player] || 0;
        lastBatterRuns[player] = 0;
      });
    }

    // Initialize bowler stats
    function initializeBowlerStats() {
      team1Players.forEach(player => {
        bowlerStats[player] = bowlerStats[player] || { 
          wickets: 0, runs: 0, overs: 0,
          momentum: 0, form: 50
        };
      });
      
      team2Players.forEach(player => {
        bowlerStats[player] = bowlerStats[player] || { 
          wickets: 0, runs: 0, overs: 0,
          momentum: 0, form: 50
        };
      });
    }

    // Check powerplay status
    function checkPowerplay() {
      const currentOver = Math.floor(legalBalls / 6);
      
      if (Array.isArray(currentFormat.powerplayOvers)) {
        // ODI has specific powerplay overs
        isPowerplay = currentFormat.powerplayOvers.some(pp => {
          if (Array.isArray(pp)) {
            return currentOver >= pp[0] && currentOver <= pp[1];
          }
          return currentOver === pp;
        });
      } else {
        // Other formats have continuous powerplay overs
        isPowerplay = currentOver < currentFormat.powerplayOvers;
      }

      // Update UI
      powerplayIndicator.style.display = isPowerplay ? "inline-block" : "none";
    }

    // Check dead over status
    function checkDeadOver() {
      if (!currentFormat.deadOvers || currentFormat.deadOvers.length === 0) {
        isDeadOver = false;
        deadOverIndicator.style.display = "none";
        return;
      }

      const currentOver = Math.floor(legalBalls / 6);
      isDeadOver = currentFormat.deadOvers.some(dead => {
        if (Array.isArray(dead)) {
          return currentOver >= dead[0] && currentOver <= dead[1];
        }
        return currentOver === dead;
      });

      // Update UI
      deadOverIndicator.style.display = isDeadOver ? "inline-block" : "none";
    }

    // Update free hit display
    function updateFreeHitDisplay() {
      freeHitIndicator.style.display = freeHit ? "inline-block" : "none";
    }

    // Format wickets to max 1.0 per batter
    function formatWickets(value) {
      const maxWickets = currentFormat.totalWickets;
      const formattedValue = Math.min(value, maxWickets)
        .toFixed(2)
        .replace(/\.00$/, '');
      
      // For display purposes, show integer if it's a whole number
      return formattedValue.includes('.') ? formattedValue : parseInt(formattedValue);
    }

    // Get wicket value based on format and powerplay status
    function getWicketValue() {
      const over = Math.floor(legalBalls / 6);
      
      if (currentFormat.name === "ODI") {
        return isPowerplay ? 0.25 : 0.5;
      }
      
      return isPowerplay ? 0.5 : 1.0;
    }

    // Update scoreboard with fractional wickets
    function updateScoreboard() {
      const wicketsDisplay = formatWickets(wickets);
      
      document.getElementById("runs").textContent = runs;
      document.getElementById("wickets").textContent = wicketsDisplay;
      document.getElementById("overs").textContent = 
        `${Math.floor(legalBalls/6)}.${legalBalls%6}`;
    }

    // Update player stats display
    function updatePlayerStats() {
      // Update run rate
      const completedOvers = Math.floor(legalBalls / 6) + (legalBalls % 6) / 10;
      const rr = completedOvers > 0 ? (runs / completedOvers).toFixed(2) : '0.00';
      document.getElementById('runRate').textContent = rr;
      
      // Update mini scorecard
      miniScorecard.innerHTML = `
        <div>${battingTeamName.textContent}: ${runs}/${formatWickets(wickets)}</div>
        <div>Overs: ${Math.floor(legalBalls/6)}.${legalBalls%6} (RR: ${rr})</div>
      `;
      
      // Update score ticker
      const tickerText = `${battingTeamName.textContent} ${runs}/${formatWickets(wickets)} (${Math.floor(legalBalls/6)}.${legalBalls%6}) | RR: ${rr} | `;
      if (secondInningsStarted) {
        tickerText += `Target: ${target} | Need ${target - runs} runs from ${currentFormat.totalOvers * 6 - legalBalls} balls`;
      }
      tickerContent.textContent = tickerText;
    }

    // Update over progress display
    function updateOverProgress() {
      const ballsContainer = document.getElementById('ballsContainer');
      ballsContainer.innerHTML = '';
      
      const ballsThisOver = legalBalls % 6;
      for (let i = 0; i < 6; i++) {
        const ballEl = document.createElement('div');
        ballEl.className = 'ball';
        
        if (i < ballsThisOver) {
          const ballData = ballByBall[legalBalls - ballsThisOver + i];
          if (ballData) {
            if (ballData.wicket) {
              ballEl.className += ' wicket';
              ballEl.textContent = 'W';
            } else if (ballData.runs > 0) {
              ballEl.className += ' run';
              ballEl.textContent = ballData.runs;
              if (ballData.runs === 6) {
                ballEl.classList.add('six');
              }
            } else {
              ballEl.className += ' dot';
              ballEl.textContent = '‚Ä¢';
            }
          }
        } else {
          ballEl.className += ' empty';
        }
        
        ballsContainer.appendChild(ballEl);
      }
      
      document.getElementById('currentOverNumber').textContent = Math.floor(legalBalls / 6) + 1;
    }

    // Update partnership info
    function updatePartnership() {
      let partnershipRuns = runs - lastWicketScore;
      let partnershipBalls = 0;
      
      // Count balls since last wicket
      for (let i = legalBalls - 1; i >= 0; i--) {
        if (ballByBall[i]?.wicket) break;
        partnershipBalls++;
      }
    }

    // Update last 5 overs stats
    function updateLast5Overs() {
      let last5Runs = 0;
      let last5Wickets = 0;
      let last5Balls = 0;
      
      const startBall = Math.max(0, legalBalls - 30); // 5 overs = 30 balls
      for (let i = startBall; i < legalBalls; i++) {
        if (ballByBall[i]) {
          last5Runs += ballByBall[i].runs;
          if (ballByBall[i].wicket) last5Wickets++;
          last5Balls++;
        }
      }
      
      // Store for stats
      lastFiveOversRuns.push(last5Runs);
      if (lastFiveOversRuns.length > 5) lastFiveOversRuns.shift();
      
      lastFiveOversWickets.push(last5Wickets);
      if (lastFiveOversWickets.length > 5) lastFiveOversWickets.shift();
    }

    // Update current time
    function updateCurrentTime() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      document.getElementById('matchDate').textContent = now.toLocaleDateString([], { day: 'numeric', month: 'short', year: 'numeric' });
      newspaperDate.textContent = now.toLocaleDateString([], { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    }

    // Update player comparison with enhanced stats
    function updatePlayerComparison() {
      if (currentBatter) {
        const batter = batterStats[currentBatter] || { runs: 0, balls: 0, fours: 0, sixes: 0 };
        const sr = batter.balls > 0 ? ((batter.runs / batter.balls) * 100).toFixed(2) : '0.00';
        
        document.getElementById('comparisonBatterName').textContent = currentBatter;
        document.getElementById('comparisonBatterRuns').textContent = batter.runs;
        document.getElementById('comparisonBatterBalls').textContent = batter.balls;
        document.getElementById('comparisonBatterSR').textContent = sr;
        document.getElementById('comparisonBatterBoundaries').textContent = `${batter.fours}/${batter.sixes}`;
        
        // Update batter momentum
        batterMomentum = batter.momentum || 0;
        batterMomentumBar.style.width = `${batterMomentum}%`;
        
        // Update spotlight
        spotlightContent.innerHTML = `
          <div style="font-weight:bold;margin-bottom:5px;">${currentBatter}</div>
          <div>Runs: ${batter.runs} (${batter.balls} balls)</div>
          <div>SR: ${sr}</div>
          <div>4s/6s: ${batter.fours}/${batter.sixes}</div>
          <div>Form: ${getFormDescription(batter.form)}</div>
        `;
        playerSpotlight.style.display = 'block';
      }
      
      if (currentBowler) {
        const bowler = bowlerStats[currentBowler] || { wickets: 0, runs: 0, overs: 0 };
        const er = bowler.overs > 0 ? (bowler.runs / bowler.overs).toFixed(2) : '0.00';
        
        document.getElementById('comparisonBowlerName').textContent = currentBowler;
        document.getElementById('comparisonBowlerWickets').textContent = bowler.wickets;
        document.getElementById('comparisonBowlerOvers').textContent = bowler.overs.toFixed(1);
        document.getElementById('comparisonBowlerER').textContent = er;
        document.getElementById('comparisonBowlerRuns').textContent = bowler.runs;
        
        // Update bowler momentum
        bowlerMomentum = bowler.momentum || 0;
        bowlerMomentumBar.style.width = `${bowlerMomentum}%`;
      }
      
      // Show/hide momentum bars
      momentumContainer.style.display = (currentBatter && currentBowler) ? 'flex' : 'none';
    }
    
    // Get form description
    function getFormDescription(form) {
      if (form >= 80) return "Excellent üî•";
      if (form >= 60) return "Good üëç";
      if (form >= 40) return "Average ‚ÜîÔ∏è";
      if (form >= 20) return "Poor üëé";
      return "Terrible üí©";
    }

    // Update run rate graph
    function updateRunRateGraph() {
      rrGraphBars.innerHTML = '';
      const maxOvers = currentFormat.totalOvers;
      const barCount = Math.min(10, Math.floor(legalBalls / 6) + 1);
      
      for (let i = 0; i < barCount; i++) {
        const overStart = i * (maxOvers / barCount);
        const overEnd = (i + 1) * (maxOvers / barCount);
        
        let runsInPeriod = 0;
        let ballsInPeriod = 0;
        
        for (let j = Math.floor(overStart * 6); j < Math.min(legalBalls, Math.floor(overEnd * 6)); j++) {
          if (ballByBall[j]) {
            runsInPeriod += ballByBall[j].runs;
            ballsInPeriod++;
          }
        }
        
        const rr = ballsInPeriod > 0 ? (runsInPeriod / (ballsInPeriod / 6)).toFixed(1) : 0;
        const height = Math.min(100, rr * 10);
        
        const bar = document.createElement('div');
        bar.className = 'graph-bar';
        bar.style.height = `${height}px`;
        bar.innerHTML = `<div class="graph-bar-label">${i+1}</div>`;
        rrGraphBars.appendChild(bar);
      }
      
      runRateGraph.style.display = barCount > 1 ? 'block' : 'none';
    }

    // Update over summary
    function updateOverSummary() {
      const currentOver = Math.floor(legalBalls / 6);
      if (currentOver > 0 && currentOver > overSummaries.length) {
        const runsThisOver = runs - lastOverRuns;
        const wicketsThisOver = wickets - lastOverWickets;
        const summary = `Over ${currentOver}: ${runsThisOver} runs, ${wicketsThisOver} wickets`;
        overSummaries.push(summary);
        
        // Update Firebase for spectators
        set(ref(db, `${overSummariesRef.path}/over${currentOver}`), summary);
        
        // Update UI
        const summaryItem = document.createElement("div");
        summaryItem.className = "over-summary-item";
        summaryItem.textContent = summary;
        overSummaryList.appendChild(summaryItem);
        
        // Scroll to bottom
        overSummaryList.scrollTop = overSummaryList.scrollHeight;
        
        // Update last over stats
        lastOverRuns = runs;
        lastOverWickets = wickets;
      }
    }

    // Commentary functions
    function addCommentary(message, type = '') {
      if (commentaryPaused) return;
      
      const now = new Date();
      const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      const commentaryItem = document.createElement('div');
      commentaryItem.className = `commentary-item ${type}`;
      commentaryItem.innerHTML = `<span class="commentary-time">${timeString}</span>${message}`;
      
      commentaryBox.insertBefore(commentaryItem, commentaryBox.firstChild);
      
      // Limit to 50 commentary items
      if (commentaryBox.children.length > 50) {
        commentaryBox.removeChild(commentaryBox.lastChild);
      }
    }

    // Add to timeline with proper over numbering (0.1 to 0.6, then 1.1 to 1.6, etc.)
    function addToTimeline(event, type = '') {
      const timeline = document.getElementById('matchTimeline');
      const currentOver = Math.floor(legalBalls / 6);
      const currentBall = (legalBalls % 6) + 1; // Show balls as 1-6 instead of 0-5
      
      const timelineItem = document.createElement('div');
      timelineItem.className = `timeline-item ${type}`;
      timelineItem.innerHTML = `
        <div class="timeline-over">${currentOver}.${currentBall}</div>
        <div class="timeline-event">${event}</div>
      `;
      
      timeline.insertBefore(timelineItem, timeline.firstChild);
      
      // Limit timeline to 20 items
      if (timeline.children.length > 20) {
        timeline.removeChild(timeline.lastChild);
      }
    }

    // Process the outcome of a ball with fractional wickets
    async function handleResult() {
      try {
        // Clear selection state
        selectedCardValue = null;
        isProcessingSelection = false;
        
        const playsSnap = await get(playsRef);
        if (!playsSnap.exists()) return;
        
        const plays = playsSnap.val();
        if (!plays || typeof plays.player1 === 'undefined' || typeof plays.player2 === 'undefined') return;

        const card1 = plays.player1;
        const card2 = plays.player2;
        const battingPlayer = battingFirst;
        const batterCard = battingPlayer === "player1" ? card1 : card2;
        const bowlerCard = battingPlayer === "player1" ? card2 : card1;

        let outcome = "";
        let isLegalBall = false;
        let isWicket = false;
        let isPlayerOut = false;
        let runsScored = 0;
        let boundary = false;
        let isSix = false;
        let isFour = false;
        let isDRSReview = false;
        let drsSuccessful = false;

        // Track zeros for both players
        if (batterCard === 0) zerosThisOver[battingPlayer]++;
        if (bowlerCard === 0) zerosThisOver[battingPlayer === "player1" ? "player2" : "player1"]++;

        // Handle free hit for next ball
        if (freeHitNextBall) {
          freeHit = true;
          freeHitNextBall = false;
          updateFreeHitDisplay();
        }

        // Check powerplay and dead over status
        checkPowerplay();
        checkDeadOver();

        // 1. Check for no ball (both 0)
        if (batterCard === 0 && bowlerCard === 0) {
          outcome = "NO BALL! +1 run (Free Hit next ball)";
          runs += 1;
          freeHitNextBall = true;
          isLegalBall = false;
          addCommentary("No ball! Free hit coming up...", 'error');
          addToTimeline("NB", 'error');
          
          // Add reaction
          addReaction(currentBatter, 'üò†');
          addReaction(currentBowler, 'üòÖ');
        } 
        // 2. Handle free hit balls
        else if (freeHit) {
          if (batterCard === bowlerCard && batterCard > 0) {
            outcome = "Wicket on Free Hit (not out)";
            isWicket = false;
            addCommentary(`Wicket on free hit! ${currentBatter} survives`, 'info');
            addToTimeline("W (FH)", 'info');
            
            // Add reaction
            addReaction(currentBatter, 'üòÖ');
            addReaction(currentBowler, 'üò°');
          } else {
            runsScored = batterCard;
            runs += batterCard;
            batterStats[currentBatter].runs += runsScored;
            outcome = `${batterCard} Run(s)! (Free Hit)`;
            if (batterCard === 4 || batterCard === 6) boundary = true;
            if (batterCard === 6) isSix = true;
            if (batterCard === 4) isFour = true;
            addCommentary(`${currentBatter} scores ${batterCard} on free hit`, 'info');
            addToTimeline(`${batterCard} FH`, 'info');
            
            // Add reaction
            if (batterCard >= 4) {
              addReaction(currentBatter, 'üòé');
              addReaction(currentBowler, 'üò§');
            }
          }
          freeHit = false;
          updateFreeHitDisplay();
          isLegalBall = true;
        }
        // 3. Handle wickets (same number > 0)
        else if (batterCard === bowlerCard && batterCard > 0) {
          const wicketValue = getWicketValue();
          const currentWickets = batterWickets[currentBatter] || 0;
          const batterMomentumValue = batterStats[currentBatter]?.momentum || 0;

          if (currentWickets < 1.0) {
            // Check for DRS review
            if (isBatting && batterCard <= 3 && drsAvailable > 0) {
              isDRSReview = true;
              drsSuccessful = Math.random() < 0.5; // 50% chance of success
              
              if (drsSuccessful) {
                outcome = "DRS REVIEW SUCCESSFUL! Wicket overturned +1 run";
                runs += 1;
                addCommentary(`DRS review successful! ${currentBatter} survives`, 'info');
                addToTimeline("DRS ‚úîÔ∏è", 'info');
                
                // Add reaction
                addReaction(currentBatter, 'üòÖ');
                addReaction(currentBowler, 'üò§');
              } else {
                outcome = "DRS REVIEW FAILED! Wicket stands";
                const actualWicketValue = Math.min(wicketValue, 1.0 - currentWickets);
                batterWickets[currentBatter] = currentWickets + actualWicketValue;
                wickets += actualWicketValue;
                isWicket = true;

                if (batterWickets[currentBatter] >= 1.0) {
                  isPlayerOut = true;
                  fallOfWickets.push({
                    score: runs,
                    over: `${Math.floor(legalBalls / 6)}.${(legalBalls % 6) + 1}`,
                    batter: currentBatter
                  });
                  addCommentary(`DRS review failed! ${currentBowler} gets ${currentBatter} out!`, 'wicket');
                  addToTimeline(`W ${currentBatter}`, 'wicket');
                  
                  // Add reaction
                  addReaction(currentBatter, 'üò¢');
                  addReaction(currentBowler, 'üòÉ');
                } else {
                  const remain = (1.0 - batterWickets[currentBatter]).toFixed(2).replace(/\.00$/, '');
                  outcome = `DRS FAILED! WICKET! (${remain} left for this batter)`;
                  addCommentary(`DRS review failed! ${currentBatter} loses ${actualWicketValue} wicket points`, 'wicket');
                  addToTimeline(`W ${actualWicketValue}`, 'wicket');
                  
                  // Add reaction
                  addReaction(currentBatter, 'üòï');
                  addReaction(currentBowler, 'üòä');
                }
              }
              
              // Update DRS status
              drsAvailable--;
              updateDRSStatus();
            } else {
              // No DRS or not eligible
              let actualWicketValue = wicketValue;
              
              // Apply momentum bonus if batter has full momentum
              if (batterMomentumValue >= 100) {
                actualWicketValue = 0; // Full momentum gives free wicket
                addCommentary(`${currentBatter} uses momentum to survive the wicket!`, 'info');
                addToTimeline("Momentum Save", 'info');
                
                // Add reaction
                addReaction(currentBatter, 'üòÖ');
                addReaction(currentBowler, 'üò°');
              } else {
                batterWickets[currentBatter] = currentWickets + actualWicketValue;
                wickets += actualWicketValue;
                isWicket = true;

                if (batterWickets[currentBatter] >= 1.0) {
                  isPlayerOut = true;
                  fallOfWickets.push({
                    score: runs,
                    over: `${Math.floor(legalBalls / 6)}.${(legalBalls % 6) + 1}`,
                    batter: currentBatter
                  });
                  addCommentary(`WICKET! ${currentBowler} gets ${currentBatter} out!`, 'wicket');
                  addToTimeline(`W ${currentBatter}`, 'wicket');
                  
                  // Add reaction
                  addReaction(currentBatter, 'üò¢');
                  addReaction(currentBowler, 'üòÉ');
                } else {
                  const remain = (1.0 - batterWickets[currentBatter]).toFixed(2).replace(/\.00$/, '');
                  outcome = `WICKET! (${remain} left for this batter)`;
                  addCommentary(`Close call! ${currentBatter} loses ${actualWicketValue} wicket points`, 'wicket');
                  addToTimeline(`W ${actualWicketValue}`, 'wicket');
                  
                  // Add reaction
                  addReaction(currentBatter, 'üòï');
                  addReaction(currentBowler, 'üòä');
                }
              }
            }
          } else {
            outcome = "Batter already out!";
            addCommentary(`${currentBatter} is already out!`, 'error');
          }
          
          isLegalBall = true;
        }
        // 4. Handle batter playing 0 with penalty
        else if (batterCard === 0 && bowlerCard > 0) {
          if (zerosThisOver[battingPlayer] > 3) {
            const penaltyRuns = 5;
            runs -= penaltyRuns;
            batterPenalties[currentBatter] = (batterPenalties[currentBatter] || 0) + penaltyRuns;
            outcome = "4th 0 in over! -5 runs";
            addCommentary(`4th dot ball in over! Penalty of 5 runs`, 'error');
            addToTimeline("-5", 'error');
            
            // Add reaction
            addReaction(currentBatter, 'üò°');
            addReaction(currentBowler, 'üòÜ');
            
            checkBatterMilestones(true);
          } else {
            runsScored = bowlerCard;
            runs += bowlerCard;
            batterStats[currentBatter].runs += runsScored;
            outcome = `Batter played 0. Runs = ${bowlerCard}`;
            if (bowlerCard === 4 || bowlerCard === 6) boundary = true;
            if (bowlerCard === 6) isSix = true;
            if (bowlerCard === 4) isFour = true;
            addCommentary(`${currentBatter} plays defensive, ${bowlerCard} runs conceded`, 'info');
            addToTimeline(`${bowlerCard}`, 'info');
            
            // Add reaction
            if (bowlerCard >= 4) {
              addReaction(currentBatter, 'üòä');
              addReaction(currentBowler, 'üò°');
            }
          }
          isLegalBall = true;
        }
        // 5. Handle bowler playing 0
        else if (bowlerCard === 0 && batterCard > 0) {
          if (zerosThisOver[battingPlayer === "player1" ? "player2" : "player1"] > 3) {
            outcome = "4th 0 in over! No ball";
            runs += 1;
            freeHitNextBall = true;
            addCommentary(`4th dot ball from bowler! No ball called`, 'error');
            addToTimeline("NB", 'error');
            
            // Add reaction
            addReaction(currentBatter, 'üòä');
            addReaction(currentBowler, 'üò°');
          } else {
            outcome = "DOT BALL!";
            addCommentary(`${currentBowler} bowls a dot ball to ${currentBatter}`, 'info');
            addToTimeline("‚Ä¢", 'info');
            
            // Add reaction
            addReaction(currentBatter, 'üòï');
            addReaction(currentBowler, 'üòä');
          }
          isLegalBall = true;
        }
        // 6. Normal runs
        else {
          runsScored = batterCard;
          runs += batterCard;
          batterStats[currentBatter].runs += batterCard;
          outcome = `${batterCard} Run(s)!`;
          if (batterCard === 4 || batterCard === 6) boundary = true;
          if (batterCard === 6) isSix = true;
          if (batterCard === 4) isFour = true;
          
          const boundaryType = batterCard === 6 ? 'SIX' : 'FOUR';
          addCommentary(`${boundaryType}! ${currentBatter} hits ${batterCard} runs off ${currentBowler}`, boundary ? 'boundary' : '');
          addToTimeline(`${batterCard}`, boundary ? 'boundary' : '');
          
          // Add reaction
          if (batterCard >= 4) {
            addReaction(currentBatter, 'üòé');
            addReaction(currentBowler, 'üò§');
          } else {
            addReaction(currentBatter, 'üôÇ');
            addReaction(currentBowler, 'üòê');
          }
          isLegalBall = true;
        }

        // Update batter stats
        if (currentBatter && runsScored > 0) {
          batterStats[currentBatter].balls += 1;
          if (batterCard === 4) batterStats[currentBatter].fours += 1;
          if (batterCard === 6) batterStats[currentBatter].sixes += 1;
          
          // Update batter momentum (1-3% per run)
          const momentumGain = runsScored * (1 + Math.random() * 2);
          batterStats[currentBatter].momentum = Math.min(100, (batterStats[currentBatter].momentum || 0) + momentumGain);
          
          // Update batter form (0.5-1.5% per run)
          const formGain = runsScored * (0.5 + Math.random());
          batterStats[currentBatter].form = Math.min(100, (batterStats[currentBatter].form || 50) + formGain);
          
          checkBatterMilestones();
        }
        
        // Update bowler stats
        if (currentBowler) {
          bowlerStats[currentBowler] = bowlerStats[currentBowler] || { wickets: 0, runs: 0, overs: 0 };
          if (isWicket) {
            bowlerStats[currentBowler].wickets += 1;
            
            // Update bowler momentum (5-10% per wicket)
            const momentumGain = 5 + Math.random() * 5;
            bowlerStats[currentBowler].momentum = Math.min(100, (bowlerStats[currentBowler].momentum || 0) + momentumGain);
            
            // Update bowler form (3-7% per wicket)
            const formGain = 3 + Math.random() * 4;
            bowlerStats[currentBowler].form = Math.min(100, (bowlerStats[currentBowler].form || 50) + formGain);
          }
          bowlerStats[currentBowler].runs += runsScored;
          
          // Update bowler form based on runs conceded
          if (runsScored > 0) {
            const formLoss = runsScored * (0.3 + Math.random() * 0.7);
            bowlerStats[currentBowler].form = Math.max(0, (bowlerStats[currentBowler].form || 50) - formLoss);
          }
        }

        // Record ball in ball-by-ball
        ballByBall[legalBalls] = {
          runs: runsScored,
          wicket: isWicket || isPlayerOut,
          batter: currentBatter,
          bowler: currentBowler,
          timestamp: Date.now(),
          outcome: outcome,
          penalty: (batterCard === 0 && bowlerCard > 0 && zerosThisOver[battingPlayer] > 3) ? 5 : 0,
          boundary: boundary,
          isSix: isSix,
          isFour: isFour,
          isDRSReview: isDRSReview,
          drsSuccessful: drsSuccessful
        };

        // Record last wicket score for partnership
        if (isWicket) {
          lastWicketScore = runs;
        }

        // Handle legal balls
        if (isLegalBall) {
          legalBalls++;
          updateOverSummary();
          
          if (currentBowler) {
            bowlerOvers[currentBowler] = (bowlerOvers[currentBowler] || 0) + (1/6);
            if (legalBalls % 6 === 0) {
              bowlerOvers[currentBowler] = Math.round(bowlerOvers[currentBowler] * 10) / 10;
              zerosThisOver = { player1: 0, player2: 0 };
              
              // Reset DRS every 5 overs
              if ((legalBalls / 6) % 5 === 0) {
                drsAvailable = Math.min(2, drsAvailable + 1);
                updateDRSStatus();
                addCommentary("DRS reviews refreshed (1 per 5 overs)", 'info');
              }
            }
          }
        }

        // Update all displays
        updateAllDisplays();
        
        // Update UI animations
        resultEl.innerText = outcome;
        if (boundary) {
          resultEl.classList.add("boundary-animation");
          document.getElementById('runs').classList.add("boundary-flash");
          document.querySelector('.scorebox-main').classList.add("ripple");
          
          if (isSix) {
            // Find the button that was selected and add golden effect
            buttons.forEach(btn => {
              if (parseInt(btn.dataset.value) === 6) {
                btn.classList.add("six");
              }
            });
          }
        }
        if (isWicket) {
          resultEl.classList.add("wicket-animation");
          document.getElementById('wickets').classList.add("score-change");
          document.querySelector('.scorebox-main').classList.add("wicket-flash");
          document.querySelector('.scorebox-main').classList.add("shake");
          document.querySelector('.scorebox-main').classList.add("explode");
        }
        if (runsScored > 0) {
          document.getElementById('runs').classList.add("score-change");
        }
        
        // Remove animation classes after they complete
        setTimeout(() => {
          resultEl.classList.remove("boundary-animation", "wicket-animation");
          document.getElementById('runs').classList.remove("score-change", "boundary-flash");
          document.getElementById('wickets').classList.remove("score-change");
          document.querySelector('.scorebox-main').classList.remove("wicket-flash", "shake", "ripple", "explode");
        }, 2000);

        // Check for innings end conditions
        if (wickets >= currentFormat.totalWickets || legalBalls >= currentFormat.totalOvers * 6) {
          if (secondInningsStarted) {
            await endMatch(false); // Second innings ended without reaching target
          } else {
            endInning(); // First innings ended
          }
          return;
        }

        // Check for second innings win conditions
        if (secondInningsStarted) {
          // Check if chasing team has won
          if (runs >= target) {
            await endMatch(true);
            return;
          }
          
          // Check if chasing team has been bowled out
          if (wickets >= currentFormat.totalWickets) {
            await endMatch(false);
            return;
          }
          
          // Check if overs completed without reaching target
          if (legalBalls >= currentFormat.totalOvers * 6) {
            await endMatch(false);
            return;
          }
        }

        // Prepare for next ball
        setTimeout(async () => {
          try {
            await set(playsRef, {});
            enableButtons();
            clearCardSelection();
            
            if (isPlayerOut && player === battingPlayer) {
              batterSelected = false;
              await showBatterSelection();
            } else if (isLegalBall && legalBalls % 6 === 0) {
              bowlerSelected = false;
              if (player === (battingPlayer === "player1" ? "player2" : "player1")) {
                await showBowlerSelection();
              } else {
                resultEl.innerText = "Waiting for opponent to select bowler...";
              }
            } else {
              updateButtonStates();
            }
          } catch (error) {
            console.error("Error in post-ball processing:", error);
            resultEl.innerText = "Error processing next ball state";
            enableButtons();
            clearCardSelection();
          }
        }, 1500);
      } catch (error) {
        console.error("Error processing ball outcome:", error);
        resultEl.innerText = "Error processing ball outcome";
        enableButtons();
        clearCardSelection();
      }
    }
    
    // Add player reaction
    function addReaction(player, emoji) {
      if (!player) return;
      
      const reaction = document.createElement('div');
      reaction.className = 'player-reaction';
      reaction.textContent = emoji;
      reaction.style.position = 'absolute';
      reaction.style.fontSize = '24px';
      reaction.style.animation = 'fadeInOut 2s forwards';
      
      // Find the player's card and position the reaction
      const playerCards = document.querySelectorAll('.player-comparison');
      for (const card of playerCards) {
        if (card.textContent.includes(player)) {
          card.style.position = 'relative';
          card.appendChild(reaction);
          
          // Random position within the card
          const rect = card.getBoundingClientRect();
          reaction.style.left = `${Math.random() * (rect.width - 30)}px`;
          reaction.style.top = `${Math.random() * (rect.height - 30)}px`;
          
          // Remove after animation
          setTimeout(() => reaction.remove(), 2000);
          break;
        }
      }
    }
    
    // Update DRS status display
    function updateDRSStatus() {
      if (isBatting) {
        drsContainer.style.display = 'block';
        drsStatus.textContent = `Reviews remaining: ${drsAvailable}`;
        drsButton.disabled = drsAvailable <= 0;
      } else {
        drsContainer.style.display = 'none';
      }
    }

    // Accurate batter milestone checking accounting for penalties
    function checkBatterMilestones(isPenalty = false) {
      if (!currentBatter) return;

      const batter = batterStats[currentBatter];
      const netRuns = batter.runs - (batterPenalties[currentBatter] || 0);
      
      // Check milestones in descending order
      const milestones = [50, 100, 150, 200, 250, 300, 350, 400];
      for (let i = milestones.length - 1; i >= 0; i--) {
        const milestone = milestones[i];
        
        // Check if crossed milestone (either direction)
        if ((!isPenalty && netRuns >= milestone && lastBatterRuns[currentBatter] < milestone) ||
            (isPenalty && netRuns < milestone && lastBatterRuns[currentBatter] >= milestone)) {
          
          // Only notify if this is a new achievement
          if (netRuns >= milestone && !batter[`milestone${milestone}Notified`]) {
            showNotification(`${currentBatter} reaches ${milestone} runs! (Net: ${netRuns})`, 'batting');
            addCommentary(`${currentBatter} reaches ${milestone} runs!`, 'milestone');
            addToTimeline(`${milestone}`, 'milestone');
            batter[`milestone${milestone}Notified`] = true;
            
            if (milestone >= 100) {
              createConfetti();
            }
          }
          // Handle losing a milestone due to penalty
          else if (isPenalty && netRuns < milestone && batter[`milestone${milestone}Notified`]) {
            showNotification(`${currentBatter} falls below ${milestone} runs after penalty (Net: ${netRuns})`, 'error');
            addCommentary(`${currentBatter} loses ${milestone} after penalty`, 'error');
            batter[`milestone${milestone}Notified`] = false;
          }
          break;
        }
      }
      
      // Special handling for 50 and 100
      if (netRuns >= 50 && !batter.fiftyNotified) {
        showNotification(`${currentBatter} scores a half-century! (Net: ${netRuns})`, 'batting');
        addCommentary(`${currentBatter} scores a half-century!`, 'milestone');
        addToTimeline("50", 'milestone');
        batter.fiftyNotified = true;
        
        // Add to match highlights
        matchHighlights.push({
          type: 'half-century',
          player: currentBatter,
          runs: netRuns,
          timestamp: Date.now()
        });
      }
      else if (netRuns < 50 && batter.fiftyNotified) {
        showNotification(`${currentBatter} loses half-century after penalty (Net: ${netRuns})`, 'error');
        addCommentary(`${currentBatter} loses half-century after penalty`, 'error');
        batter.fiftyNotified = false;
      }
      
      if (netRuns >= 100 && !batter.centuryNotified) {
        showNotification(`${currentBatter} scores a century! üíØ (Net: ${netRuns})`, 'batting');
        addCommentary(`${currentBatter} scores a century! üíØ`, 'milestone');
        addToTimeline("100", 'milestone');
        batter.centuryNotified = true;
        createConfetti();
        
        // Add to match highlights
        matchHighlights.push({
          type: 'century',
          player: currentBatter,
          runs: netRuns,
          timestamp: Date.now()
        });
      }
      else if (netRuns < 100 && batter.centuryNotified) {
        showNotification(`${currentBatter} loses century after penalty (Net: ${netRuns})`, 'error');
        addCommentary(`${currentBatter} loses century after penalty`, 'error');
        batter.centuryNotified = false;
      }

      // Update last run count
      lastBatterRuns[currentBatter] = netRuns;
    }

    // Show notification with different styles
    function showNotification(message, type = 'info') {
      const notif = document.createElement('div');
      notif.className = `milestone-notification ${type}`;
      notif.textContent = message;
      document.body.appendChild(notif);
      
      setTimeout(() => {
        notif.style.opacity = '0';
        setTimeout(() => notif.remove(), 500);
      }, 2500);
    }

    // Create confetti effect
    function createConfetti() {
      const colors = ['#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff'];
      for (let i = 0; i < 150; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${Math.random() * 100}%`;
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.width = `${Math.random() * 10 + 5}px`;
        confetti.style.height = `${Math.random() * 10 + 5}px`;
        confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
        confetti.style.animationDelay = `${Math.random() * 0.5}s`;
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 5000);
      }
    }

    // Show batter selection modal with fractional wickets
    async function showBatterSelection() {
      disableButtons();
      
      // Reset modal state first
      resetSelectionModal();
      
      try {
          resultEl.innerText = "Loading batters...";
          
          const currentPlayers = player === "player1" ? team1Players : team2Players;
          const availableBatters = currentPlayers.filter(p => {
              const wicketsUsed = Math.min(1.0, batterWickets[p] || 0);
              return wicketsUsed < 1.0;
          });

          if (availableBatters.length === 0) {
              showNotification("All batters are out!", 'error');
              enableButtons();
              return;
          }

          selectionTitle.textContent = "Select Next Batter";
          selectionList.innerHTML = "";
          
          availableBatters.forEach(player => {
              const stats = batterStats[player] || { runs: 0, balls: 0, fours: 0, sixes: 0 };
              const wicketsUsed = Math.min(1.0, batterWickets[player] || 0).toFixed(1);
              
              const batterEl = document.createElement("div");
              batterEl.className = "batter-item";
              batterEl.dataset.name = player;
              batterEl.innerHTML = `
                  <div>${player}</div>
                  <div>${stats.runs} runs (${wicketsUsed} wickets used)</div>
                  <div>Form: ${getFormDescription(stats.form || 50)}</div>
              `;
              
              batterEl.addEventListener("click", function() {
                  document.querySelectorAll(".batter-item").forEach(el => el.classList.remove("selected"));
                  this.classList.add("selected");
              });
              
              selectionList.appendChild(batterEl);
          });

          // Show modal with transition
          selectionModal.style.display = "block";
          resultEl.innerText = "Select your next batter...";
      } catch (error) {
          console.error("Batter selection error:", error);
          showNotification("Error loading batters", 'error');
          enableButtons();
      }
    }

    // Show bowler selection modal
    async function showBowlerSelection() {
      disableButtons();
      
      // Reset modal state first
      resetSelectionModal();

      try {
          resultEl.innerText = "Loading bowlers...";
          
          const currentPlayers = player === "player1" ? team1Players : team2Players;
          
          if (!currentPlayers || currentPlayers.length === 0) {
              showNotification("No bowlers available", 'error');
              enableButtons();
              return;
          }
          
          const maxOversPerBowler = Math.ceil(currentFormat.totalOvers / 5);
          const availableBowlers = currentPlayers.filter(p => (bowlerOvers[p] || 0) < maxOversPerBowler);
          
          if (availableBowlers.length === 0) {
              showNotification("All bowlers have bowled their maximum overs!", 'error');
              enableButtons();
              return;
          }

          selectionTitle.textContent = "Select Next Bowler";
          selectionList.innerHTML = "";
          
          availableBowlers.forEach(player => {
              const oversBowled = bowlerOvers[player] || 0;
              const stats = bowlerStats[player] || { wickets: 0, runs: 0 };
              
              const playerEl = document.createElement("div");
              playerEl.className = "player-item";
              playerEl.dataset.name = player;
              playerEl.innerHTML = `
                  <div>${player}</div>
                  <div>${oversBowled.toFixed(1)} overs, ${stats.wickets} wickets</div>
                  <div>Form: ${getFormDescription(stats.form || 50)}</div>
              `;
              
              playerEl.addEventListener("click", function() {
                  document.querySelectorAll(".player-item").forEach(el => el.classList.remove("selected"));
                  this.classList.add("selected");
              });
              
              selectionList.appendChild(playerEl);
          });

          // Show modal with transition
          selectionModal.style.display = "block";
          resultEl.innerText = "Select your next bowler...";
      } catch (error) {
          console.error("Bowler selection error:", error);
          showNotification("Error loading bowlers", 'error');
          enableButtons();
      }
    }

    // Setup player role (batting/bowling)
    async function setupRole() {
        // Immediately clear all selection states and UI
        batterSelected = false;
        bowlerSelected = false;
        currentBatter = null;
        currentBowler = null;
        resetSelectionModal();

        // Set role definitively
        isBatting = (player === battingFirst);
        roleText.textContent = isBatting ? "You are Batting" : "You are Bowling";
        
        console.log(`Player: ${player}, BattingFirst: ${battingFirst}, isBatting: ${isBatting}`);

        // Atomically clear all Firebase selections
        await Promise.all([
            set(batterRef, null),
            set(bowlerRef, null),
            update(playsRef, { player1: null, player2: null })
        ]);

        // Add slight delay before showing new UI to prevent flicker
        await new Promise(resolve => setTimeout(resolve, 50));
        
        // Show appropriate selection UI
        if (isBatting) {
            await showBatterSelection();
        } else {
            await showBowlerSelection();
        }
    }

    // Function to reset the selection modal
    function resetSelectionModal() {
      selectionModal.style.display = "none";
      selectionList.innerHTML = '';
    }

    // Add click tracking for selection confirmation
    let isConfirmingSelection = false;

    // Modified setupSelectionModal function
    function setupSelectionModal() {
      confirmSelection.addEventListener("click", async () => {
        if (isConfirmingSelection) return; // Prevent double clicks
        isConfirmingSelection = true;
        
        try {
          const selected = document.querySelector(".batter-item.selected, .player-item.selected");
          if (!selected) {
            showNotification("Please select a player", 'error');
            return;
          }

          const playerName = selected.dataset.name;
          resetSelectionModal();

          if (selectionTitle.textContent.includes("Batter")) {
            await set(batterRef, playerName);
            batterSelected = true;
            resultEl.innerText = `${playerName} selected as batter`;
            addCommentary(`${playerName} comes in to bat`, 'info');
          } else {
            await set(bowlerRef, playerName);
            bowlerSelected = true;
            resultEl.innerText = `${playerName} selected as bowler`;
            addCommentary(`${playerName} comes in to bowl`, 'info');
          }

          updateButtonStates();
        } catch (error) {
          console.error("Error confirming selection:", error);
          showNotification("Failed to confirm selection", 'error');
        } finally {
          isConfirmingSelection = false;
        }
      });
    }

    // Enable/disable card buttons based on game state
    function updateButtonStates() {
      const canPlay = (isBatting && batterSelected) || (!isBatting && bowlerSelected);
      buttons.forEach(btn => {
        btn.disabled = !canPlay;
      });
      
      // Update DRS button state
      if (isBatting) {
        drsButton.disabled = drsAvailable <= 0;
      }
    }

    // Disable all card buttons
    function disableButtons() {
      buttons.forEach(btn => {
        btn.disabled = true;
      });
    }

    // Enable all card buttons
    function enableButtons() {
      if (isResetting) return;
      
      const canPlay = (isBatting && batterSelected) || (!isBatting && bowlerSelected);
      buttons.forEach(btn => {
        btn.disabled = !canPlay;
      });
      
      if (canPlay) {
        resultEl.innerText = isBatting ? "Select your shot" : "Select your delivery";
      }
    }

    // End current inning
    async function endInning() {
      disableButtons();

      // Save first innings data
      firstInningsData = {
        totalRuns: runs,
        totalWickets: wickets,
        balls: legalBalls,
        batterStats: batterStats,
        bowlerStats: bowlerStats,
        ballByBall: ballByBall,
        fallOfWickets: fallOfWickets,
        overSummaries: overSummaries,
        team1Name: team1NameDisplay.textContent,
        team2Name: team2NameDisplay.textContent,
        format: currentFormat.name,
        timestamp: Date.now()
      };

      // Set target (runs + 1)
      target = runs + 1;
      chasingTeam = battingFirst === "player1" ? "player2" : "player1";

      // Update UI
      targetDisplay.style.display = 'block';
      targetValue.textContent = target;
      document.getElementById('summaryTitle').textContent = "First Innings Summary";
      document.getElementById('startSecondInningsBtn').textContent = "üèè Start Second Innings";
      
      // Show summary popup
      showSummaryPopup();

      resultEl.innerText = `First innings ended! Target is ${target}`;
      showNotification("First innings completed! Target set.", 'info');
      addCommentary(`First innings ends! Target is ${target} runs`, 'info');
      
      // Mark first innings as completed
      firstInningsCompleted = true;
      await set(firstInningsCompletedRef, true);
      await set(firstInningsRef, firstInningsData); // Save first innings data
    }

    // Show summary popup
    function showSummaryPopup() {
      summaryPopup.style.display = 'block';
      
      // Update summary data
      summaryTotalRuns.textContent = runs;
      summaryWickets.textContent = wickets;
      summaryOvers.textContent = `${Math.floor(legalBalls/6)}.${legalBalls%6}`;
      
      const completedOvers = Math.floor(legalBalls / 6) + (legalBalls % 6) / 10;
      const rr = completedOvers > 0 ? (runs / completedOvers).toFixed(2) : '0.00';
      summaryRunRate.textContent = rr;
      
      // Set highlight based on performance
      if (runs >= 200) {
        summaryHighlight.textContent = "Excellent Batting Performance!";
      } else if (runs >= 150) {
        summaryHighlight.textContent = "Good Total Posted!";
      } else if (runs <= 100) {
        summaryHighlight.textContent = "Bowlers Dominated This Innings";
      } else {
        summaryHighlight.textContent = "Competitive Total";
      }
    }

    // Start second innings
    async function startSecondInnings() {
      try {
        // Reset game state for second innings
        runs = 0;
        wickets = 0;
        legalBalls = 0;
        lastOverRuns = 0;
        lastOverWickets = 0;
        lastWicketScore = 0;
        ballByBall = {};
        fallOfWickets = [];
        overSummaries = [];
        zerosThisOver = { player1: 0, player2: 0 };
        freeHit = false;
        freeHitNextBall = false;
        drsAvailable = 1;
        
        // Reverse roles - chasing team bats second
        battingFirst = chasingTeam;
        isBatting = (player === battingFirst);
        
        // Update UI
        battingTeamName.textContent = battingFirst === "player1" ? team1NameDisplay.textContent : team2NameDisplay.textContent;
        roleText.textContent = isBatting ? "You are Batting" : "You are Bowling";
        document.getElementById('inningsNumber').textContent = "2nd Innings";
        
        // Reset player stats for second innings
        initializeBatterStats();
        initializeBowlerStats();
        
        // Update target display
        targetDisplay.style.display = 'block';
        targetValue.textContent = target;
        
        // Hide summary popup
        summaryPopup.style.display = 'none';
        
        // Mark second innings as started
        secondInningsStarted = true;
        await set(secondInningsStartedRef, true);
        
        // Start the innings
        await setupRole();
        
        showNotification("Second innings started! Target: " + target, 'info');
        addCommentary(`Second innings begins! Target is ${target} runs`, 'info');
      } catch (error) {
        console.error("Error starting second innings:", error);
        showNotification("Failed to start second innings", 'error');
      }
    }

    // Handle match end
    async function endMatch(chasingTeamWon) {
      disableButtons();
      
      // Correct winner determination
      const winner = chasingTeamWon ? chasingTeam : (battingFirst === "player1" ? "player2" : "player1");
      const winnerName = winner === "player1" ? team1NameDisplay.textContent : team2NameDisplay.textContent;
      
      // Update result
      const winningMargin = chasingTeamWon 
        ? `${currentFormat.totalWickets - wickets} wickets` 
        : `${target - runs - 1} runs`;
      
      resultEl.innerHTML = `<strong>${winnerName} won by ${winningMargin}</strong>`;
      
      // Show match summary with both innings data
      document.getElementById('summaryTitle').textContent = "Match Result";
      document.getElementById('summaryHighlight').textContent = `${winnerName} won the match!`;
      document.getElementById('startSecondInningsBtn').style.display = 'none';
      
      // Calculate run rates
      const firstInningsRR = (firstInningsData.totalRuns / (firstInningsData.balls / 6)).toFixed(2);
      const secondInningsRR = (runs / (legalBalls / 6)).toFixed(2);
      
      // Update summary content
      const summaryContent = document.querySelector('.summary-content');
      summaryContent.innerHTML = `
        <div class="summary-row">
          <span class="summary-label">First Innings:</span>
          <span class="summary-value">${firstInningsData.totalRuns}/${firstInningsData.totalWickets} (${Math.floor(firstInningsData.balls/6)}.${firstInningsData.balls%6} overs, RR: ${firstInningsRR})</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Second Innings:</span>
          <span class="summary-value">${runs}/${wickets} (${Math.floor(legalBalls/6)}.${legalBalls%6} overs, RR: ${secondInningsRR})</span>
        </div>
        <div class="summary-highlight">${winnerName} won by ${winningMargin}</div>
      `;
      
      // Show popup
      summaryPopup.style.display = 'block';
      
      // Add to commentary
      addCommentary(`Match over! ${winnerName} won by ${winningMargin}`, 'milestone');
      
      // Create confetti for winner
      createConfetti();
      
      // Save match result
      await set(resultRef, {
        winner: winner,
        winningMargin: winningMargin,
        firstInnings: firstInningsData,
        secondInnings: {
          totalRuns: runs,
          totalWickets: wickets,
          balls: legalBalls
        },
        timestamp: Date.now()
      });
      
      // Generate newspaper summary
      generateNewspaperSummary(winnerName, winningMargin);
    }
    
    // Generate newspaper style summary
    function generateNewspaperSummary(winnerName, winningMargin) {
      // Set headline and subhead
      newspaperHeadline.textContent = `${winnerName.toUpperCase()} WIN THRILLING ENCOUNTER`;
      newspaperSubhead.textContent = `${winningMargin} victory in a closely fought match`;
      
      // Set match report
      const firstInningsRR = (firstInningsData.totalRuns / (firstInningsData.balls / 6)).toFixed(2);
      const secondInningsRR = (runs / (legalBalls / 6)).toFixed(2);
      
      matchReportContent.innerHTML = `
        <p>In a thrilling encounter at the virtual stadium, ${winnerName} emerged victorious by ${winningMargin} in a match that had everything - big hits, wickets, and dramatic moments.</p>
        <p>${firstInningsData.team1Name} set a target of ${firstInningsData.totalRuns} in their first innings, scoring at a run rate of ${firstInningsRR}. The chase by ${firstInningsData.team2Name} fell short by ${target - runs - 1} runs as they finished on ${runs}/${wickets}.</p>
        <p>The match featured several standout performances with both bat and ball.</p>
      `;
      
      // Find player of the match (highest scorer or best bowler)
      let potm = null;
      let maxRuns = 0;
      let maxWickets = 0;
      
      // Check batters
      for (const player in batterStats) {
        if (batterStats[player].runs > maxRuns) {
          maxRuns = batterStats[player].runs;
          potm = { player, runs: batterStats[player].runs, wickets: 0 };
        }
      }
      
      // Check bowlers
      for (const player in bowlerStats) {
        if (bowlerStats[player].wickets > maxWickets) {
          maxWickets = bowlerStats[player].wickets;
          if (maxWickets >= 3) { // Only consider bowlers with 3+ wickets
            potm = { player, runs: 0, wickets: bowlerStats[player].wickets };
          }
        }
      }
      
      // Set player of the match
      if (potm) {
        playerOfMatch.innerHTML = `
          <div>PLAYER OF THE MATCH</div>
          <div style="font-size:18px;margin-top:5px;">${potm.player.toUpperCase()}</div>
          <div style="margin-top:5px;">
            ${potm.runs > 0 ? `${potm.runs} runs` : `${potm.wickets} wickets`}
          </div>
        `;
      }
      
      // Set scorecards
      innings1Header.textContent = `${firstInningsData.team1Name} ${firstInningsData.totalRuns}/${firstInningsData.totalWickets}`;
      innings2Header.textContent = `${firstInningsData.team2Name} ${runs}/${wickets}`;
      
      // Top 3 batters from each innings
      const topBatters1 = Object.entries(batterStats)
        .filter(([name, stats]) => team1Players.includes(name))
        .sort((a, b) => b[1].runs - a[1].runs)
        .slice(0, 3);
      
      const topBatters2 = Object.entries(batterStats)
        .filter(([name, stats]) => team2Players.includes(name))
        .sort((a, b) => b[1].runs - a[1].runs)
        .slice(0, 3);
      
      // Top 3 bowlers from each innings
      const topBowlers1 = Object.entries(bowlerStats)
        .filter(([name, stats]) => team2Players.includes(name))
        .sort((a, b) => b[1].wickets - a[1].wickets || a[1].runs - b[1].runs)
        .slice(0, 3);
      
      const topBowlers2 = Object.entries(bowlerStats)
        .filter(([name, stats]) => team1Players.includes(name))
        .sort((a, b) => b[1].wickets - a[1].wickets || a[1].runs - b[1].runs)
        .slice(0, 3);
      
      // Build scorecards
      innings1Scorecard.innerHTML = '';
      topBatters1.forEach(([name, stats]) => {
        const row = document.createElement('div');
        row.className = 'scorecard-row';
        row.innerHTML = `
          <div>${name}</div>
          <div>${stats.runs} (${stats.balls})</div>
        `;
        innings1Scorecard.appendChild(row);
      });
      
      // Add bowlers to innings 2 scorecard
      topBowlers1.forEach(([name, stats]) => {
        const row = document.createElement('div');
        row.className = 'scorecard-row';
        row.innerHTML = `
          <div>${name}</div>
          <div>${stats.wickets}/${stats.runs} (${stats.overs})</div>
        `;
        innings1Scorecard.appendChild(row);
      });
      
      innings2Scorecard.innerHTML = '';
      topBatters2.forEach(([name, stats]) => {
        const row = document.createElement('div');
        row.className = 'scorecard-row';
        row.innerHTML = `
          <div>${name}</div>
          <div>${stats.runs} (${stats.balls})</div>
        `;
        innings2Scorecard.appendChild(row);
      });
      
      // Add bowlers to innings 2 scorecard
      topBowlers2.forEach(([name, stats]) => {
        const row = document.createElement('div');
        row.className = 'scorecard-row';
        row.innerHTML = `
          <div>${name}</div>
          <div>${stats.wickets}/${stats.runs} (${stats.overs})</div>
        `;
        innings2Scorecard.appendChild(row);
      });
      
      // Set match result
      newspaperResult.textContent = `${winnerName} won by ${winningMargin}`;
      
      // Key moments
      keyMomentsContent.innerHTML = `
        <ul style="padding-left:15px;">
          ${matchHighlights.map(h => {
            if (h.type === 'century') return `<li>üíØ ${h.player} scores a century (${h.runs} runs)</li>`;
            if (h.type === 'half-century') return `<li>50 ${h.player} scores a half-century (${h.runs} runs)</li>`;
            return '';
          }).join('')}
        </ul>
      `;
    }

    // Update spectator data with match details
    function updateSpectatorData() {
      const currentOver = Math.floor(legalBalls / 6);
      
      // Update live state
      set(liveStateRef, {
        runs: runs,
        wickets: Math.floor(wickets),
        legalBalls: legalBalls,
        currentBatter: currentBatter,
        currentBowler: currentBowler,
        isPowerplay: isPowerplay,
        isDeadOver: isDeadOver,
        freeHit: freeHit,
        timestamp: Date.now()
      });
    }

    // Save game state
    async function saveGameState() {
      try {
        resultEl.innerText = "Saving game...";
        disableButtons();
        
        const gameState = {
          room: room,
          player1: player === "player1" ? player : opponent,
          player2: player === "player2" ? player : opponent,
          tossWinner: tossWinner,
          battingFirst: battingFirst,
          team1Score: runs,
          team1Wickets: Math.floor(wickets),
          currentBatter: currentBatter,
          currentBowler: currentBowler,
          batterStats: batterStats,
          bowlerStats: bowlerStats,
          legalBalls: legalBalls,
          timestamp: Date.now()
        };
        
        await set(ref(db, `savedGames/${room}`), gameState);
        resultEl.innerText = "Game saved successfully!";
        setTimeout(() => window.location.href = "index.html", 2000);
      } catch (error) {
        console.error("Error saving game:", error);
        resultEl.innerText = "Error saving game. Please try again.";
        enableButtons();
      }
    }

    // Reset game state
    async function resetGame() {
      try {
        await set(playerRef, false);
        await update(playsRef, {
          player1: null,
          player2: null
        });
        clearCardSelection();
      } catch (error) {
        console.error("Error resetting game:", error);
      }
    }

    // Enhanced resetPlays function with notification system
    async function resetPlays() {
      if (resetCount >= MAX_RESETS) {
        showNotification(`Maximum resets (${MAX_RESETS}) reached for this innings`, 'error');
        return;
      }

      try {
        isResetting = true;
        disableButtons();
        resetCount++;
        
        // Reset both players' selections in Firebase
        await update(ref(db, `rooms/${room}`), {
          'currentPlays/player1': null,
          'currentPlays/player2': null
        });

        // Clear local selections
        clearCardSelection();
        
        // Clear reset request
        await set(resetRequestRef, null);
        
        showNotification("Plays have been reset", 'info');
        addCommentary("Plays have been reset by umpire", 'info');
        
        // Re-enable buttons based on current game state
        if (isBatting) {
          if (!batterSelected) {
            await showBatterSelection();
          } else {
            enableButtons();
          }
        } else {
          if (!bowlerSelected) {
            await showBowlerSelection();
          } else {
            enableButtons();
          }
        }
      } catch (error) {
        console.error("Error resetting plays:", error);
        showNotification("Failed to reset plays", 'error');
        enableButtons();
      } finally {
        isResetting = false;
      }
    }

    // Setup connection monitoring
    function setupConnectionMonitoring() {
      // Monitor opponent connection
      onValue(opponentRef, (snap) => {
        if (snap.exists() && snap.val()) {
          connectionStatus.textContent = "Opponent: Online";
          connectionStatus.className = "online";
          updateButtonStates();
        } else {
          connectionStatus.textContent = "Opponent: Offline";
          connectionStatus.className = "offline";
          resultEl.innerText = "Waiting for opponent to connect...";
          disableButtons();
        }
      });

            // Handle disconnect
      window.addEventListener('beforeunload', () => {
        set(playerRef, false);
      });
    }

    // Setup newspaper-style match summary
    function setupNewspaperSummary() {
      const newspaperContainer = document.createElement('div');
      newspaperContainer.className = 'newspaper-summary';
      newspaperContainer.style.display = 'none';
      newspaperContainer.innerHTML = `
        <div class="newspaper-header">
          <h2>The HandiCricket Times</h2>
          <div class="match-headline"></div>
        </div>
        <div class="newspaper-grid">
          <div class="newspaper-panel scorecard-panel">
            <h3>Scorecard</h3>
            <div class="scorecard-content"></div>
          </div>
          <div class="newspaper-panel batting-panel">
            <h3>Batting Highlights</h3>
            <div class="batting-content"></div>
          </div>
          <div class="newspaper-panel bowling-panel">
            <h3>Bowling Highlights</h3>
            <div class="bowling-content"></div>
          </div>
          <div class="newspaper-panel key-moments-panel">
            <h3>Key Moments</h3>
            <div class="moments-content"></div>
          </div>
        </div>
      `;
      document.body.appendChild(newspaperContainer);

      // Add button to show newspaper summary
      const newspaperBtn = document.createElement('button');
      newspaperBtn.className = 'newspaper-btn';
      newspaperBtn.textContent = 'üì∞ Match Summary';
      newspaperBtn.addEventListener('click', () => {
        updateNewspaperSummary();
        newspaperContainer.style.display = 'block';
      });
      document.querySelector('.container').appendChild(newspaperBtn);

      // Close button
      const closeBtn = document.createElement('button');
      closeBtn.className = 'close-newspaper';
      closeBtn.textContent = '√ó';
      closeBtn.addEventListener('click', () => {
        newspaperContainer.style.display = 'none';
      });
      newspaperContainer.appendChild(closeBtn);
    }

    function updateNewspaperSummary() {
      const newspaper = document.querySelector('.newspaper-summary');
      const headline = newspaper.querySelector('.match-headline');
      const scorecard = newspaper.querySelector('.scorecard-content');
      const batting = newspaper.querySelector('.batting-content');
      const bowling = newspaper.querySelector('.bowling-content');
      const moments = newspaper.querySelector('.moments-content');

      // Set headline based on match state
      if (secondInningsStarted) {
        const chasingTeamName = chasingTeam === 'player1' ? team1NameDisplay.textContent : team2NameDisplay.textContent;
        const targetStatus = runs >= target ? 'reached' : 'chasing';
        headline.textContent = `${chasingTeamName} ${targetStatus} target of ${target}`;
      } else {
        headline.textContent = `${battingTeamName.textContent} post ${runs}/${wickets}`;
      }

      // Scorecard panel
      let scorecardHTML = `
        <div class="team-scorecard">
          <h4>${team1NameDisplay.textContent}</h4>
          <table>
            <tr><th>Batter</th><th>R</th><th>B</th><th>SR</th></tr>
      `;
      
      team1Players.forEach(player => {
        const stats = batterStats[player] || { runs: 0, balls: 0 };
        const sr = stats.balls > 0 ? ((stats.runs / stats.balls) * 100).toFixed(2) : '-';
        const out = (batterWickets[player] || 0) >= 1.0 ? '‚Ä†' : '';
        scorecardHTML += `
          <tr>
            <td>${player}${out}</td>
            <td>${stats.runs}</td>
            <td>${stats.balls}</td>
            <td>${sr}</td>
          </tr>
        `;
      });
      
      scorecardHTML += `
          </table>
        </div>
        <div class="team-scorecard">
          <h4>${team2NameDisplay.textContent}</h4>
          <table>
            <tr><th>Batter</th><th>R</th><th>B</th><th>SR</th></tr>
      `;
      
      team2Players.forEach(player => {
        const stats = batterStats[player] || { runs: 0, balls: 0 };
        const sr = stats.balls > 0 ? ((stats.runs / stats.balls) * 100).toFixed(2) : '-';
        const out = (batterWickets[player] || 0) >= 1.0 ? '‚Ä†' : '';
        scorecardHTML += `
          <tr>
            <td>${player}${out}</td>
            <td>${stats.runs}</td>
            <td>${stats.balls}</td>
            <td>${sr}</td>
          </tr>
        `;
      });
      
      scorecardHTML += `</table></div>`;
      scorecard.innerHTML = scorecardHTML;

      // Batting highlights panel
      let battingHTML = '';
      const topBatters = [...team1Players, ...team2Players]
        .map(p => ({ name: p, ...(batterStats[p] || { runs: 0, balls: 0, fours: 0, sixes: 0 }) }))
        .sort((a, b) => b.runs - a.runs)
        .slice(0, 3);
      
      topBatters.forEach(batter => {
        battingHTML += `
          <div class="highlight-item">
            <div class="highlight-name">${batter.name}</div>
            <div class="highlight-stats">
              ${batter.runs} runs (${batter.balls} balls), ${batter.fours}√ó4, ${batter.sixes}√ó6
            </div>
          </div>
        `;
      });
      batting.innerHTML = battingHTML;

      // Bowling highlights panel
      let bowlingHTML = '';
      const topBowlers = [...team1Players, ...team2Players]
        .map(p => ({ name: p, ...(bowlerStats[p] || { wickets: 0, runs: 0, overs: 0 }) }))
        .sort((a, b) => b.wickets - a.wickets || a.runs - b.runs)
        .slice(0, 3);
      
      topBowlers.forEach(bowler => {
        const economy = bowler.overs > 0 ? (bowler.runs / bowler.overs).toFixed(2) : '-';
        bowlingHTML += `
          <div class="highlight-item">
            <div class="highlight-name">${bowler.name}</div>
            <div class="highlight-stats">
              ${bowler.wickets}/${bowler.runs} in ${bowler.overs.toFixed(1)} overs (ER: ${economy})
            </div>
          </div>
        `;
      });
      bowling.innerHTML = bowlingHTML;

      // Key moments panel
      let momentsHTML = '';
      const keyMoments = [
        ...fallOfWickets.map(w => `${w.batter} fell at ${w.score} (${w.over})`),
        ...Object.values(batterStats)
          .filter(b => b.fiftyNotified || b.centuryNotified)
          .map(b => `${b.name} scored ${b.fiftyNotified ? '50' : '100'}`)
      ].slice(0, 5);
      
      if (keyMoments.length > 0) {
        momentsHTML = '<ul>' + keyMoments.map(m => `<li>${m}</li>`).join('') + '</ul>';
      } else {
        momentsHTML = '<p>No key moments yet</p>';
      }
      moments.innerHTML = momentsHTML;
    }

    // Add stadium visual effects
    function setupStadiumEffects() {
      const stadiumBg = document.createElement('div');
      stadiumBg.className = 'stadium-bg';
      stadiumBg.innerHTML = `
        <div class="crowd-animation"></div>
        <div class="pitch"></div>
        <div class="stadium-lights"></div>
      `;
      document.body.insertBefore(stadiumBg, document.body.firstChild);

      // Day/night toggle
      const dayNightToggle = document.createElement('div');
      dayNightToggle.className = 'day-night-toggle';
      dayNightToggle.innerHTML = `
        <label>
          <input type="checkbox" id="dayNightCheckbox">
          <span class="slider">üåô</span>
        </label>
      `;
      document.querySelector('.container').appendChild(dayNightToggle);

      document.getElementById('dayNightCheckbox').addEventListener('change', function() {
        document.body.classList.toggle('night-mode', this.checked);
      });
    }

    // Add live score ticker
    function setupLiveScoreTicker() {
      const ticker = document.createElement('div');
      ticker.className = 'live-score-ticker';
      ticker.innerHTML = `
        <div class="ticker-content">
          <span class="score">${runs}/${wickets}</span>
          <span class="overs">${Math.floor(legalBalls/6)}.${legalBalls%6} overs</span>
          <span class="rr">RR: ${legalBalls > 0 ? (runs / (legalBalls/6)).toFixed(2) : '0.00'}</span>
          <span class="partnership">Partnership: ${runs - lastWicketScore}</span>
        </div>
      `;
      document.body.appendChild(ticker);

      // Update ticker periodically
      setInterval(() => {
        const tickerContent = ticker.querySelector('.ticker-content');
        tickerContent.innerHTML = `
          <span class="score">${runs}/${wickets}</span>
          <span class="overs">${Math.floor(legalBalls/6)}.${legalBalls%6} overs</span>
          <span class="rr">RR: ${legalBalls > 0 ? (runs / (legalBalls/6)).toFixed(2) : '0.00'}</span>
          <span class="partnership">Partnership: ${runs - lastWicketScore}</span>
        `;
      }, 5000);
    }

    // Add mini scorecard that stays visible when scrolling
    function setupMiniScorecard() {
      const miniScorecard = document.createElement('div');
      miniScorecard.className = 'mini-scorecard';
      miniScorecard.innerHTML = `
        <div class="teams">${team1NameDisplay.textContent} vs ${team2NameDisplay.textContent}</div>
        <div class="score">${runs}/${wickets}</div>
        <div class="overs">${Math.floor(legalBalls/6)}.${legalBalls%6} overs</div>
      `;
      document.body.appendChild(miniScorecard);

      // Update periodically
      setInterval(() => {
        miniScorecard.querySelector('.score').textContent = `${runs}/${wickets}`;
        miniScorecard.querySelector('.overs').textContent = `${Math.floor(legalBalls/6)}.${legalBalls%6} overs`;
      }, 1000);
    }

    // Add player spotlight effect
    function setupPlayerSpotlight() {
      // Will be updated when players change
      function updateSpotlight() {
        const spotlight = document.querySelector('.player-spotlight') || document.createElement('div');
        spotlight.className = 'player-spotlight';
        
        if (currentBatter) {
          spotlight.innerHTML = `
            <div class="spotlight-batter">Batting: <span>${currentBatter}</span></div>
            ${currentBowler ? `<div class="spotlight-bowler">Bowling: <span>${currentBowler}</span></div>` : ''}
          `;
          document.querySelector('.container').appendChild(spotlight);
        }
      }

      // Update when players change
      onValue(batterRef, updateSpotlight);
      onValue(bowlerRef, updateSpotlight);
    }

    // Add umpire signal animations
    function setupUmpireSignals() {
      const signals = document.createElement('div');
      signals.className = 'umpire-signals';
      document.body.appendChild(signals);

      // Will be triggered by game events
      window.showUmpireSignal = function(type) {
        const signal = document.createElement('div');
        signal.className = `umpire-signal ${type}`;
        
        if (type === 'out') {
          signal.innerHTML = 'OUT! <div class="umpire-arm"></div>';
        } else if (type === 'four') {
          signal.innerHTML = 'FOUR <div class="umpire-arm"></div>';
        } else if (type === 'six') {
          signal.innerHTML = 'SIX <div class="umpire-arm"></div>';
        } else if (type === 'wide') {
          signal.innerHTML = 'WIDE <div class="umpire-arm"></div>';
        }
        
        signals.appendChild(signal);
        setTimeout(() => {
          signal.classList.add('show');
          setTimeout(() => {
            signal.classList.remove('show');
            setTimeout(() => signal.remove(), 500);
          }, 2000);
        }, 100);
      };
    }

    // Add DRS system
    function setupDRS() {
      const drsButton = document.createElement('button');
      drsButton.className = 'drs-button';
      drsButton.textContent = 'üì∫ Review (DRS)';
      drsButton.disabled = true;
      document.querySelector('.card-btns').appendChild(drsButton);

      let reviewsAvailable = 1;
      const maxReviews = currentFormat.totalOvers >= 20 ? 2 : 1;

      function updateDRSButton() {
        drsButton.disabled = reviewsAvailable <= 0 || 
                             !isBatting || 
                             !ballByBall[legalBalls-1]?.wicket || 
                             ballByBall[legalBalls-1]?.batter !== currentBatter;
      }

      drsButton.addEventListener('click', async () => {
        if (drsButton.disabled) return;
        
        const lastBall = ballByBall[legalBalls-1];
        if (!lastBall?.wicket) return;

        drsButton.disabled = true;
        reviewsAvailable--;
        
        // Animate DRS process
        showNotification("Reviewing decision...", 'info');
        addCommentary(`${currentBatter} has opted for a review!`, 'info');
        
        // Random chance of success (10-75%)
        const successChance = Math.min(75, Math.max(10, (batterStats[currentBatter]?.runs || 0) / 2);
        const isSuccessful = Math.random() * 100 < successChance;
        
        setTimeout(async () => {
          if (isSuccessful) {
            // Successful review
            showNotification("Decision overturned! Batter survives", 'batting');
            addCommentary(`Review successful! ${currentBatter} gets a reprieve`, 'milestone');
            
            // Reverse wicket
            const wicketValue = getWicketValue();
            batterWickets[currentBatter] = Math.max(0, (batterWickets[currentBatter] || 0) - wicketValue;
            wickets = Math.max(0, wickets - wicketValue);
            
            // Award bonus run
            runs += 1;
            batterStats[currentBatter].runs += 1;
            
            // Update ball record
            ballByBall[legalBalls-1].wicket = false;
            ballByBall[legalBalls-1].outcome = "Review successful - not out";
          } else {
            // Unsuccessful review
            showNotification("Original decision stands", 'error');
            addCommentary(`Review unsuccessful! ${currentBatter} has to go`, 'wicket');
            ballByBall[legalBalls-1].outcome = "Review unsuccessful - out";
          }
          
          updateAllDisplays();
          updateDRSButton();
        }, 3000);
      });

      // Update DRS button state
      onValue(batterRef, updateDRSButton);
      onValue(playsRef, updateDRSButton);
    }

    // Add strategic timeout functionality
    function setupStrategicTimeouts() {
      const timeoutButton = document.createElement('button');
      timeoutButton.className = 'timeout-button';
      timeoutButton.textContent = '‚è± Timeout';
      document.querySelector('.card-btns').appendChild(timeoutButton);

      let timeoutsUsed = 0;
      const maxTimeouts = 2;

      timeoutButton.addEventListener('click', async () => {
        if (timeoutsUsed >= maxTimeouts) {
          showNotification("No timeouts remaining", 'error');
          return;
        }

        timeoutsUsed++;
        timeoutButton.textContent = `‚è± Timeout (${maxTimeouts - timeoutsUsed} left)`;
        disableButtons();
        
        showNotification("Strategic timeout called", 'info');
        addCommentary(`${isBatting ? 'Batting' : 'Bowling'} team takes a strategic timeout`, 'info');
        
        // 2 minute timeout
        let timeLeft = 120;
        const timer = setInterval(() => {
          timeLeft--;
          resultEl.textContent = `Timeout: ${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2, '0')}`;
          
          if (timeLeft <= 0) {
            clearInterval(timer);
            enableButtons();
            resultEl.textContent = "Timeout over";
          }
        }, 1000);
      });
    }

    // Add match momentum indicator
    function setupMomentumIndicator() {
      const momentumBar = document.createElement('div');
      momentumBar.className = 'momentum-bar';
      momentumBar.innerHTML = `
        <div class="team1-momentum" style="width: 50%">${team1NameDisplay.textContent}</div>
        <div class="team2-momentum" style="width: 50%">${team2NameDisplay.textContent}</div>
      `;
      document.querySelector('.container').appendChild(momentumBar);

      function updateMomentum() {
        // Simple momentum calculation based on recent runs/wickets
        let team1Momentum = 50;
        let team2Momentum = 50;
        
        if (secondInningsStarted) {
          // During chase, momentum favors team doing better relative to target
          const requiredRR = (target - runs) / ((currentFormat.totalOvers * 6 - legalBalls) / 6);
          const currentRR = legalBalls > 0 ? runs / (legalBalls / 6) : 0;
          
          if (currentRR > requiredRR) {
            team2Momentum = 60 + Math.min(30, (currentRR - requiredRR) * 5);
            team1Momentum = 100 - team2Momentum;
          } else {
            team1Momentum = 60 + Math.min(30, (requiredRR - currentRR) * 5);
            team2Momentum = 100 - team1Momentum;
          }
        } else {
          // First innings momentum based on run rate
          const avgRR = 6; // Average T20 run rate
          const currentRR = legalBalls > 0 ? runs / (legalBalls / 6) : 0;
          
          if (currentRR > avgRR) {
            team1Momentum = 50 + Math.min(40, (currentRR - avgRR) * 10);
            team2Momentum = 100 - team1Momentum;
          } else {
            team2Momentum = 50 + Math.min(40, (avgRR - currentRR) * 10);
            team1Momentum = 100 - team2Momentum;
          }
        }

        // Adjust for wickets
        const wicketImpact = (wickets / currentFormat.totalWickets) * 30;
        if (battingFirst === 'player1') {
          team1Momentum -= wicketImpact;
        } else {
          team2Momentum -= wicketImpact;
        }

        // Ensure values are within bounds
        team1Momentum = Math.max(5, Math.min(95, team1Momentum));
        team2Momentum = Math.max(5, Math.min(95, team2Momentum));

        // Update display
        document.querySelector('.team1-momentum').style.width = `${team1Momentum}%`;
        document.querySelector('.team2-momentum').style.width = `${team2Momentum}%`;
        
        // Color coding
        document.querySelector('.team1-momentum').style.backgroundColor = 
          team1Momentum > 55 ? '#4CAF50' : team1Momentum < 45 ? '#F44336' : '#FFC107';
        document.querySelector('.team2-momentum').style.backgroundColor = 
          team2Momentum > 55 ? '#4CAF50' : team2Momentum < 45 ? '#F44336' : '#FFC107';
      }

      // Update momentum periodically
      setInterval(updateMomentum, 5000);
      onValue(playsRef, updateMomentum);
    }

    // Add player reactions system
    function setupPlayerReactions() {
      const reactionsContainer = document.createElement('div');
      reactionsContainer.className = 'reactions-container';
      reactionsContainer.innerHTML = `
        <button class="reaction-btn" data-emoji="üëç">üëç</button>
        <button class="reaction-btn" data-emoji="üëé">üëé</button>
        <button class="reaction-btn" data-emoji="üòÆ">üòÆ</button>
        <button class="reaction-btn" data-emoji="üéâ">üéâ</button>
        <button class="reaction-btn" data-emoji="üò¢">üò¢</button>
      `;
      document.querySelector('.container').appendChild(reactionsContainer);

      document.querySelectorAll('.reaction-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const emoji = btn.dataset.emoji;
          push(reactionsRef, {
            player: player,
            emoji: emoji,
            timestamp: Date.now()
          });
        });
      });

      // Display reactions
      onValue(reactionsRef, (snap) => {
        if (!snap.exists()) return;
        
        const reactions = snap.val();
        Object.values(reactions).forEach(reaction => {
          if (reaction.player !== player) {
            const reactionEl = document.createElement('div');
            reactionEl.className = 'reaction-popup';
            reactionEl.textContent = reaction.emoji;
            reactionEl.style.left = `${Math.random() * 80 + 10}%`;
            document.body.appendChild(reactionEl);
            
            setTimeout(() => {
              reactionEl.style.opacity = '0';
              setTimeout(() => reactionEl.remove(), 1000);
            }, 2000);
          }
        });
      });
    }

    // Add player form system
    function setupPlayerFormSystem() {
      // Track player form (0-100 scale)
      const playerForm = {};
      [...team1Players, ...team2Players].forEach(p => {
        playerForm[p] = 50; // Start at average form
      });

      // Update form based on performance
      function updateForm(player, performance) {
        // performance: + for good, - for bad
        playerForm[player] = Math.max(0, Math.min(100, playerForm[player] + performance));
        
        // Visual indicator
        const formIndicator = document.querySelector(`.form-indicator-${player.replace(/\s/g, '-')}`) || 
          createFormIndicator(player);
        formIndicator.style.width = `${playerForm[player]}%`;
        formIndicator.style.backgroundColor = 
          playerForm[player] > 70 ? '#4CAF50' : 
          playerForm[player] < 30 ? '#F44336' : '#FFC107';
      }

      function createFormIndicator(player) {
        const indicator = document.createElement('div');
        indicator.className = `form-indicator form-indicator-${player.replace(/\s/g, '-')}`;
        indicator.innerHTML = `
          <div class="form-label">${player}</div>
          <div class="form-bar">
            <div class="form-fill" style="width: 50%"></div>
          </div>
        `;
        document.querySelector('.player-comparison').appendChild(indicator);
        return indicator.querySelector('.form-fill');
      }

      // Update form based on game events
      onValue(playsRef, (snap) => {
        if (!snap.exists()) return;
        
        const plays = snap.val();
        if (plays.player1 && plays.player2) {
          // Update batter form
          if (currentBatter) {
            const runsScored = isBatting ? plays[player] : plays[opponent];
            updateForm(currentBatter, runsScored * 2); // More runs = better form
          }
          
          // Update bowler form
          if (currentBowler) {
            const runsConceded = isBatting ? plays[opponent] : plays[player];
            updateForm(currentBowler, -runsConceded); // More runs conceded = worse form
          }
        }
      });
    }

    // Add batter momentum system
    function setupBatterMomentum() {
      const momentumBar = document.createElement('div');
      momentumBar.className = 'batter-momentum-container';
      momentumBar.innerHTML = `
        <div class="momentum-label">Batter Momentum</div>
        <div class="momentum-bar">
          <div class="momentum-fill" style="width: 0%"></div>
        </div>
      `;
      document.querySelector('.batter-comparison').appendChild(momentumBar);

      let momentum = 0;
      const momentumFill = momentumBar.querySelector('.momentum-fill');

      function updateMomentum(runs) {
        // Increase momentum based on runs scored
        momentum = Math.min(100, momentum + runs * 15);
        momentumFill.style.width = `${momentum}%`;
        momentumFill.style.backgroundColor = 
          momentum > 80 ? '#4CAF50' : momentum > 50 ? '#8BC34A' : '#FFC107';
      }

      // Reset momentum on wicket
      onValue(batterRef, (snap) => {
        if (!snap.exists() || snap.val() !== currentBatter) {
          momentum = 0;
          momentumFill.style.width = '0%';
        }
      });

      // Update on runs scored
      onValue(playsRef, (snap) => {
        if (!snap.exists() || !currentBatter) return;
        
        const plays = snap.val();
        if (plays.player1 && plays.player2) {
          const runsScored = isBatting ? plays[player] : plays[opponent];
          if (runsScored > 0) {
            updateMomentum(runsScored);
          }
        }
      });
    }

    // Add card history tracker
    function setupCardHistoryTracker() {
      const historyContainer = document.createElement('div');
      historyContainer.className = 'card-history-container';
      historyContainer.innerHTML = `
        <div class="history-title">Last 5 Plays</div>
        <div class="history-cards"></div>
      `;
      document.querySelector('.container').appendChild(historyContainer);

      const historyCards = historyContainer.querySelector('.history-cards');
      const lastPlays = [];

      function updateHistory(batterCard, bowlerCard) {
        lastPlays.push({ batter: batterCard, bowler: bowlerCard });
        if (lastPlays.length > 5) lastPlays.shift();
        
        historyCards.innerHTML = lastPlays.map(play => `
          <div class="history-card">
            <div class="batter-card">${play.batter}</div>
            <div class="vs">vs</div>
            <div class="bowler-card">${play.bowler}</div>
          </div>
        `).join('');
        
        // Detect patterns
        detectPatterns();
      }

      function detectPatterns() {
        if (lastPlays.length < 3) return;
        
        // Check for repeating patterns
        const lastThree = lastPlays.slice(-3);
        if (lastThree[0].batter === lastThree[1].batter && 
            lastThree[1].batter === lastThree[2].batter) {
          showNotification(`${currentBatter} is playing the same card repeatedly!`, 'info');
        }
        
        if (lastThree[0].bowler === lastThree[1].bowler && 
            lastThree[1].bowler === lastThree[2].bowler) {
          showNotification(`${currentBowler} is bowling the same card repeatedly!`, 'info');
        }
      }

      onValue(playsRef, (snap) => {
        if (!snap.exists()) return;
        
        const plays = snap.val();
        if (plays.player1 && plays.player2) {
          const batterCard = isBatting ? plays[player] : plays[opponent];
          const bowlerCard = isBatting ? plays[opponent] : plays[player];
          updateHistory(batterCard, bowlerCard);
        }
      });
    }

    // Add match highlight reel
    function setupHighlightReel() {
      const highlights = {
        biggestSix: { distance: 0, batter: '', bowler: '' },
        bestWicket: { batter: '', bowler: '', score: 0 },
        fastestFifty: { balls: Infinity, batter: '' },
        mostEconomical: { economy: Infinity, bowler: '' }
      };

      function updateHighlights() {
        // Biggest six
        Object.entries(batterStats).forEach(([name, stats]) => {
          if (stats.sixes > 0 && stats.runs > highlights.biggestSix.distance) {
            highlights.biggestSix = { 
              distance: stats.runs, 
              batter: name,
              bowler: '' // Would need to track bowler per six
            };
          }
        });

        // Best wicket (highest scorer dismissed)
        fallOfWickets.forEach(w => {
          if (w.score > highlights.bestWicket.score) {
            highlights.bestWicket = {
              batter: w.batter,
              bowler: '', // Would need to track bowler per wicket
              score: w.score
            };
          }
        });

        // Fastest fifty
        Object.entries(batterStats).forEach(([name, stats]) => {
          if (stats.runs >= 50 && stats.balls < highlights.fastestFifty.balls) {
            highlights.fastestFifty = {
              balls: stats.balls,
              batter: name
            };
          }
        });

        // Most economical bowler (min 1 over)
        Object.entries(bowlerStats).forEach(([name, stats]) => {
          if (stats.overs >= 1) {
            const economy = stats.runs / stats.overs;
            if (economy < highlights.mostEconomical.economy) {
              highlights.mostEconomical = {
                economy: economy,
                bowler: name
              };
            }
          }
        });
      }

      // Show highlights at innings break
      onValue(firstInningsCompletedRef, (snap) => {
        if (snap.exists() && snap.val()) {
          updateHighlights();
          const highlightReel = document.createElement('div');
          highlightReel.className = 'highlight-reel';
          highlightReel.innerHTML = `
            <h3>First Innings Highlights</h3>
            <div class="highlight-item">
              <div class="highlight-title">Biggest Six</div>
              <div>${highlights.biggestSix.batter} (${highlights.biggestSix.distance}m)</div>
            </div>
            <div class="highlight-item">
              <div class="highlight-title">Key Wicket</div>
              <div>${highlights.bestWicket.batter} at ${highlights.bestWicket.score}</div>
            </div>
            <div class="highlight-item">
              <div class="highlight-title">Fastest Fifty</div>
              <div>${highlights.fastestFifty.batter} in ${highlights.fastestFifty.balls} balls</div>
            </div>
            <div class="highlight-item">
              <div class="highlight-title">Best Bowling</div>
              <div>${highlights.mostEconomical.bowler} (ER: ${highlights.mostEconomical.economy.toFixed(2)})</div>
            </div>
          `;
          document.body.appendChild(highlightReel);
          
          setTimeout(() => {
            highlightReel.style.opacity = '1';
            setTimeout(() => {
              highlightReel.style.opacity = '0';
              setTimeout(() => highlightReel.remove(), 1000);
            }, 10000);
          }, 100);
        }
      });
    }

    // Add share highlights functionality
    function setupShareHighlights() {
      const shareBtn = document.createElement('button');
      shareBtn.className = 'share-highlights-btn';
      shareBtn.textContent = 'üì§ Share Highlights';
      document.querySelector('.container').appendChild(shareBtn);

      shareBtn.addEventListener('click', () => {
        // In a real implementation, this would generate a shareable link or image
        showNotification("Highlight sharing feature coming soon!", 'info');
      });
    }

    // Initialize all visual and gameplay features
    function initializeAllFeatures() {
      setupNewspaperSummary();
      setupStadiumEffects();
      setupLiveScoreTicker();
      setupMiniScorecard();
      setupPlayerSpotlight();
      setupUmpireSignals();
      setupDRS();
      setupStrategicTimeouts();
      setupMomentumIndicator();
      setupPlayerReactions();
      setupPlayerFormSystem();
      setupBatterMomentum();
      setupCardHistoryTracker();
      setupHighlightReel();
      setupShareHighlights();

      // Add CSS for new features
      const style = document.createElement('style');
      style.textContent = `
        /* Newspaper summary styles */
        .newspaper-summary {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 90%;
          max-width: 600px;
          max-height: 80vh;
          background: white;
          color: black;
          padding: 20px;
          border-radius: 5px;
          box-shadow: 0 0 20px rgba(0,0,0,0.5);
          z-index: 1000;
          overflow-y: auto;
          font-family: 'Times New Roman', Times, serif;
        }
        
        .newspaper-header {
          border-bottom: 2px solid #000;
          padding-bottom: 10px;
          margin-bottom: 15px;
          text-align: center;
        }
        
        .newspaper-header h2 {
          margin: 0;
          font-size: 24px;
        }
        
        .match-headline {
          font-size: 18px;
          font-weight: bold;
          margin-top: 5px;
        }
        
        .newspaper-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          grid-gap: 15px;
        }
        
        .newspaper-panel {
          border: 1px solid #ddd;
          padding: 10px;
        }
        
        .newspaper-panel h3 {
          margin-top: 0;
          border-bottom: 1px solid #000;
          padding-bottom: 5px;
        }
        
        .team-scorecard {
          margin-bottom: 15px;
        }
        
        .team-scorecard h4 {
          margin-bottom: 5px;
        }
        
        .team-scorecard table {
          width: 100%;
          border-collapse: collapse;
        }
        
        .team-scorecard th, .team-scorecard td {
          padding: 3px 5px;
          text-align: left;
          border-bottom: 1px solid #ddd;
        }
        
        .highlight-item {
          margin-bottom: 10px;
        }
        
        .highlight-name {
          font-weight: bold;
        }
        
        .close-newspaper {
          position: absolute;
          top: 10px;
          right: 10px;
          background: none;
          border: none;
          font-size: 20px;
          cursor: pointer;
        }
        
        .newspaper-btn {
          background: linear-gradient(135deg, #1e88e5, #0d47a1);
          color: white;
          border: none;
          padding: 8px 15px;
          border-radius: 5px;
          margin: 10px auto;
          display: block;
          cursor: pointer;
        }
        
        /* Stadium effects */
        .stadium-bg {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: url('https://example.com/stadium.jpg') no-repeat center center;
          background-size: cover;
          z-index: -1;
          opacity: 0.3;
        }
        
        .crowd-animation {
          position: absolute;
          bottom: 0;
          width: 100%;
          height: 100px;
          background: url('https://example.com/crowd.png') repeat-x;
          animation: crowdMove 10s linear infinite;
        }
        
        .pitch {
          position: absolute;
          bottom: 100px;
          left: 50%;
          transform: translateX(-50%);
          width: 300px;
          height: 500px;
          background: #4CAF50;
          border-radius: 5px;
        }
        
        .day-night-toggle {
          position: absolute;
          top: 10px;
          right: 10px;
          z-index: 100;
        }
        
        body.night-mode {
          background: #000;
        }
        
        body.night-mode .stadium-bg {
          filter: brightness(0.5);
        }
        
        /* Live score ticker */
        .live-score-ticker {
          position: fixed;
          bottom: 0;
          left: 0;
          width: 100%;
          background: rgba(0,0,0,0.8);
          color: white;
          padding: 5px;
          font-size: 14px;
          z-index: 100;
        }
        
        .ticker-content {
          display: flex;
          justify-content: space-around;
          animation: tickerScroll 20s linear infinite;
        }
        
        /* Mini scorecard */
        .mini-scorecard {
          position: fixed;
          top: 10px;
          left: 10px;
          background: rgba(0,0,0,0.7);
          color: white;
          padding: 5px 10px;
          border-radius: 5px;
          font-size: 12px;
          z-index: 100;
        }
        
        /* Player spotlight */
        .player-spotlight {
          background: rgba(0,0,0,0.7);
          color: white;
          padding: 5px 10px;
          border-radius: 5px;
          margin: 10px auto;
          text-align: center;
          border: 2px solid gold;
        }
        
        /* Umpire signals */
        .umpire-signals {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          z-index: 1000;
          pointer-events: none;
        }
        
        .umpire-signal {
          position: absolute;
          background: rgba(0,0,0,0.8);
          color: white;
          padding: 10px 20px;
          border-radius: 5px;
          font-size: 24px;
          font-weight: bold;
          opacity: 0;
          transition: opacity 0.3s;
        }
        
        .umpire-signal.show {
          opacity: 1;
        }
        
        .umpire-arm {
          display: inline-block;
          animation: umpireSignal 1s;
        }
        
        /* DRS button */
        .drs-button {
          background: #9C27B0;
          color: white;
        }
        
        /* Timeout button */
        .timeout-button {
          background: #FF9800;
          color: black;
        }
        
        /* Momentum indicator */
        .momentum-bar {
          display: flex;
          height: 20px;
          margin: 10px 0;
          border-radius: 10px;
          overflow: hidden;
        }
        
        .team1-momentum, .team2-momentum {
          transition: width 0.5s;
        }
        
        /* Player reactions */
        .reactions-container {
          display: flex;
          justify-content: center;
          gap: 5px;
          margin: 10px 0;
        }
        
        .reaction-btn {
          background: none;
          border: none;
          font-size: 20px;
          cursor: pointer;
        }
        
        .reaction-popup {
          position: fixed;
          font-size: 30px;
          animation: reactionFloat 2s ease-out;
          z-index: 1000;
        }
        
        /* Form indicators */
        .form-indicator {
          margin: 5px 0;
        }
        
        .form-bar {
          height: 5px;
          background: #ddd;
          border-radius: 5px;
          overflow: hidden;
        }
        
        .form-fill {
          height: 100%;
          transition: width 0.5s;
        }
        
        /* Card history */
        .card-history-container {
          background: rgba(13, 42, 82, 0.7);
          border-radius: 8px;
          padding: 10px;
          margin: 10px 0;
        }
        
        .history-title {
          font-size: 12px;
          color: #aaa;
          margin-bottom: 5px;
        }
        
        .history-cards {
          display: flex;
          gap: 5px;
        }
        
        .history-card {
          background: rgba(255,255,255,0.1);
          padding: 5px;
          border-radius: 5px;
          text-align: center;
          font-size: 12px;
        }
        
        /* Highlight reel */
        .highlight-reel {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0,0,0,0.9);
          color: white;
          padding: 20px;
          border-radius: 10px;
          z-index: 1000;
          opacity: 0;
          transition: opacity 0.5s;
        }
        
        .highlight-item {
          margin: 10px 0;
        }
        
        .highlight-title {
          font-weight: bold;
          color: #ffeb3b;
        }
        
        /* Share button */
        .share-highlights-btn {
          background: #4CAF50;
          color: white;
        }
        
        /* Animations */
        @keyframes crowdMove {
          0% { background-position: 0 0; }
          100% { background-position: -1000px 0; }
        }
        
        @keyframes umpireSignal {
          0% { transform: rotate(0deg); }
          50% { transform: rotate(45deg); }
          100% { transform: rotate(0deg); }
        }
        
        @keyframes reactionFloat {
          0% { transform: translateY(0); opacity: 1; }
          100% { transform: translateY(-100px); opacity: 0; }
        }
        
        @keyframes tickerScroll {
          0% { transform: translateX(100%); }
          100% { transform: translateX(-100%); }
        }
      `;
      document.head.appendChild(style);
    }

    // Initialize the game
    async function initGame() {
  try {
    console.log("Starting game initialization...");
    resultEl.innerText = "Initializing game...";
    loadingSpinner.style.display = "block";

    // Remove the pitch element if it exists
    const pitchElement = document.querySelector('.pitch');
    if (pitchElement) {
      pitchElement.remove();
      console.log("Pitch element removed successfully");
    }

    // 1. Verify URL parameters first
    console.log("Checking URL parameters...");
    if (!room || !player) {
      throw new Error("Missing room or player parameters in URL");
    }

    // Check if spectator mode
    isSpectator = player === "spectator";
    if (isSpectator) {
      setupSpectatorMode();
      return;
    }

    // 2. Set player online status with timeout
    console.log("Setting player online status...");
    await setWithTimeout(playerRef, true, 5000, "Setting online status timed out");

    // 3. Load room data with retries
    console.log("Loading room data...");
    const roomSnap = await getWithRetries(roomRef, 3, 1000);
    
    if (!roomSnap.exists()) {
      throw new Error(`Room ${room} not found in database`);
    }

    const roomData = roomSnap.val();
    console.log("Room data loaded:", roomData);

    // 4. Verify game setup is complete
    console.log("Verifying game setup...");
    if (!roomData.toss?.winner && !roomData.tossWinner) {
      throw new Error("Toss not completed");
    }
    
    if (!roomData.teams?.player1 || !roomData.teams?.player2) {
      throw new Error("Teams not set up");
    }

    // Get toss and batting first info
    tossWinner = roomData.toss?.winner || roomData.tossWinner;
    battingFirst = roomData.toss?.battingFirst || roomData.battingFirst;
    
    // Update team names display
    team1NameDisplay.textContent = roomData.teams.player1.name || "Team 1";
    team2NameDisplay.textContent = roomData.teams.player2.name || "Team 2";
    battingTeamName.textContent = roomData.teams.player1.name || "Team 1";

    // Mark game as started if not already
    if (!roomData.gameStarted) {
      await update(roomRef, {
        gameStarted: true
      });
    }

    // Load teams with retry logic
    console.log("Loading teams...");
    let retries = 0;
    const maxRetries = 3;
    
    while (retries < maxRetries) {
      try {
        const teamsLoaded = await loadPlaying11();
        if (teamsLoaded) break;
      } catch (error) {
        console.error(`Team load attempt ${retries + 1} failed:`, error);
        retries++;
        if (retries >= maxRetries) {
          throw new Error("Failed to load teams after multiple attempts");
        }
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }

    // Set game format
    const format = roomData.player1?.format || "5";
    currentFormat = formatRules[format];
    
    formatDisplay.innerText = `${currentFormat.name}`;
    
    // Initialize stats
    initializeBatterStats();
    initializeBowlerStats();

    // Set up game components
    setupConnectionMonitoring();
    await setupRole();
    setupSelectionModal();
    setupCardButtons();
    setupFirebaseListeners();
    setupTeamsModal();
    
    // Set up control buttons
    saveBtn.addEventListener("click", saveGameState);
    exitBtn.addEventListener("click", async () => {
      if (confirm("Exit without saving?")) {
        await resetGame();
        window.location.href = "index.html";
      }
    });
    
    resetPlaysBtn.addEventListener("click", async () => {
      if (confirm("Request to reset the current plays? This will notify your opponent.")) {
        await requestReset();
      }
    });

    // Setup commentary controls
    pauseCommentaryBtn.addEventListener('click', function() {
      commentaryPaused = !commentaryPaused;
      this.textContent = commentaryPaused ? 'Resume' : 'Pause';
    });

    clearCommentaryBtn.addEventListener('click', function() {
      commentaryBox.innerHTML = '';
    });

    // Setup second innings button
    startSecondInningsBtn.addEventListener('click', startSecondInnings);

    // Initialize all additional features
    initializeAllFeatures();

    // Initial UI update
    updateAllDisplays();
    resultEl.innerText = "Game ready!";
    loadingSpinner.style.display = "none";
  } catch (error) {
    console.error("Initialization failed:", error);
    resultEl.innerHTML = `Initialization failed: ${error.message}<br>
                       <button onclick="initGame()" style="margin-top:10px; padding: 8px 15px; background: #1e88e5; color: white; border: none; border-radius: 5px; cursor: pointer;">
                         Retry Initialization
                       </button>`;
    resultEl.className = "error";
    loadingSpinner.style.display = "none";
    
    // Additional error logging for debugging
    console.error("Full error stack:", error.stack);
    if (error.details) {
      console.error("Error details:", error.details);
    }
  }
    }

    // Start the game
    initGame().catch(error => {
      console.error("Uncaught initialization error:", error);
      document.getElementById("result").innerHTML = `
        Fatal error: ${error.message}<br>
        Please refresh or check console for details.
      `;
      document.getElementById("result").className = "error";
    });
  </script>
</body>
</html>
