<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HandiCricket - Match</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-blue: #061e3e;
      --secondary-blue: #1e3d8b;
      --accent-yellow: #ffeb3b;
      --red: #e53935;
      --green: #4caf50;
      --orange: #ff9800;
      --purple: #9c27b0;
      --white: #ffffff;
      --black: #000000;
      --gray: #cccccc;
      --dark-gray: #333333;
      --primary: #1e88e5;
      --secondary: #1565c0;
      --success: #4CAF50;
      --danger: #f44336;
      --warning: #FF9800;
      --info: #2196F3;
      --dark: #061e3e;
      --light: #f8f9fa;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: var(--primary-blue);
      color: var(--white);
      font-family: 'Roboto', sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    
    /* Stadium Background */
    .stadium-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), 
                  url('https://images.unsplash.com/photo-1540747913346-19e32dc3e97e') no-repeat center center;
      background-size: cover;
      z-index: -1;
      opacity: 0.8;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 15px;
      position: relative;
    }
    
    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 15px;
    }
    
    .match-title {
      font-size: 1.5rem;
      color: var(--accent-yellow);
      text-shadow: 0 0 8px rgba(255, 235, 59, 0.5);
    }
    
    .room-info {
      background: rgba(0,0,0,0.3);
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.9rem;
    }
    
    .room-code {
      font-weight: bold;
      color: var(--accent-yellow);
    }
    
    /* Scoreboard */
    .scoreboard {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      border: 1px solid var(--secondary-blue);
    }
    
    .scoreboard-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .score {
      font-size: 2rem;
      font-weight: bold;
    }
    
    .wickets {
      color: var(--danger);
      font-weight: bold;
    }
    
    .overs {
      font-size: 1.2rem;
    }
    
    .run-rate {
      font-size: 1rem;
      color: var(--gray);
    }
    
    .scoreboard-details {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: var(--gray);
    }
    
    /* Game controls */
    .game-controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .control-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      background: rgba(30, 136, 229, 0.2);
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .control-btn i {
      margin-right: 5px;
    }
    
    .control-btn:hover {
      background: rgba(30, 136, 229, 0.4);
    }
    
    .save-btn { 
      background: var(--orange);
    }
    
    .exit-btn { 
      background: var(--red);
    }
    
    .reset-btn { 
      background: var(--purple);
    }
    
    .summary-btn { 
      background: var(--green);
    }
    
    /* Player cards */
    .player-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    @media (max-width: 768px) {
      .player-cards {
        grid-template-columns: 1fr;
      }
    }
    
    .player-card {
      background: rgba(13, 42, 82, 0.5);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      border: 1px solid var(--secondary-blue);
    }
    
    .player-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .player-name {
      font-weight: bold;
      font-size: 1.1rem;
    }
    
    .player-role {
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    .player-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-size: 0.9rem;
    }
    
    .stat-item {
      display: flex;
      justify-content: space-between;
    }
    
    .stat-label {
      color: var(--gray);
    }
    
    .stat-value {
      font-weight: bold;
    }
    
    /* Card selection */
    .card-selection {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid var(--secondary-blue);
    }
    
    .card-selection-header {
      text-align: center;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }
    
    .cards {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px; /* Reduced gap */
    }
    
    .card {
      aspect-ratio: 1/1;
      width: 40px; /* Fixed width */
      height: 40px; /* Fixed height */
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(30, 136, 229, 0.2);
      border-radius: 8px;
      font-size: 1.2rem; /* Smaller font */
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      margin: 0 auto; /* Center cards */
    }
    
    @media (max-width: 768px) {
      .cards {
        grid-template-columns: repeat(4, 1fr);
      }
      .card {
        width: 35px;
        height: 35px;
        font-size: 1rem;
      }
    }
    
    .card:hover {
      background: rgba(30, 136, 229, 0.4);
      transform: translateY(-3px);
    }
    
    .card.selected {
      background: var(--primary);
      box-shadow: 0 0 10px rgba(30, 136, 229, 0.7);
    }
    
    /* Match info */
    .match-info {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid var(--secondary-blue);
    }
    
    .info-tabs {
      display: flex;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 10px;
    }
    
    .info-tab {
      padding: 8px 15px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    
    .info-tab.active {
      border-bottom: 2px solid var(--primary);
      font-weight: bold;
    }
    
    .info-content {
      display: none;
    }
    
    .info-content.active {
      display: block;
    }
    
    /* Fall of wickets */
    .fow-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .fow-item {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
    }
    
    /* Over summary */
    .over-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    
    .ball {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .ball.dot {
      background: rgba(255,255,255,0.1);
    }
    
    .ball.run {
      background: rgba(76, 175, 80, 0.3);
    }
    
    .ball.four {
      background: rgba(76, 175, 80, 0.6);
    }
    
    .ball.six {
      background: rgba(76, 175, 80, 0.9);
    }
    
    .ball.wicket {
      background: rgba(244, 67, 54, 0.7);
    }
    
    .ball.wide {
      background: rgba(255, 152, 0, 0.7);
    }
    
    .ball.noball {
      background: rgba(33, 150, 243, 0.7);
    }
    
    /* Player selection modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background: var(--dark);
      border-radius: 10px;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid var(--secondary-blue);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .modal-title {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--accent-yellow);
    }
    
    .close-modal {
      background: var(--red);
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .player-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .player-list-item {
      padding: 10px;
      margin: 5px 0;
      background: rgba(30, 136, 229, 0.1);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }
    
    .player-list-item:hover {
      background: rgba(30, 136, 229, 0.3);
    }
    
    .player-list-item.selected {
      background: rgba(13, 71, 161, 0.6);
      border-left: 3px solid var(--accent-yellow);
    }
    
    .player-name {
      font-weight: 500;
    }
    
    .player-stats {
      font-size: 0.8rem;
      color: var(--gray);
    }
    
    .confirm-btn {
      width: 100%;
      padding: 10px;
      margin-top: 15px;
      background: var(--green);
      color: var(--white);
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .confirm-btn:hover {
      background: #388E3C;
    }
    
    /* Match summary modal */
    .match-summary {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--primary-blue);
      z-index: 1002;
      overflow-y: auto;
      padding: 20px;
      display: none;
    }
    
    .match-summary-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--secondary-blue);
    }
    
    .match-summary-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent-yellow);
      margin-bottom: 5px;
    }
    
    .match-summary-subtitle {
      font-size: 1rem;
      color: var(--gray);
    }
    
    .match-summary-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    @media (min-width: 600px) {
      .match-summary-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    .match-summary-panel {
      background: rgba(0,0,0,0.5);
      border-radius: 8px;
      padding: 15px;
      border: 1px solid var(--secondary-blue);
    }
    
    .match-summary-panel-title {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--accent-yellow);
      border-bottom: 1px solid var(--secondary-blue);
      padding-bottom: 5px;
    }
    
    .player-of-match {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .player-of-match-name {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .player-of-match-stats {
      font-size: 1rem;
      color: var(--gray);
    }
    
    .scorecard {
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    .scorecard-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    .scorecard-player {
      flex: 2;
      text-align: left;
    }
    
    .scorecard-stats {
      flex: 1;
      text-align: right;
    }
    
    .scorecard-wicket {
      color: var(--red);
      font-style: italic;
    }
    
    .match-result {
      text-align: center;
      font-weight: bold;
      font-size: 1.3rem;
      margin: 20px 0;
      color: var(--accent-yellow);
    }
    
    .close-summary-btn {
      width: 100%;
      padding: 10px;
      background: var(--red);
      color: var(--white);
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    /* Status Indicators */
    .status-indicators {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    
    .status-indicator {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    .free-hit {
      background: var(--green);
      color: var(--white);
    }
    
    .powerplay {
      background: var(--accent-yellow);
      color: var(--black);
    }
    
    .dead-over {
      background: var(--red);
      color: var(--white);
    }
    
    /* Connection Status */
    .connection-status {
      padding: 8px;
      border-radius: 6px;
      text-align: center;
      margin: 10px auto;
      max-width: 250px;
      font-weight: bold;
      font-size: 0.8rem;
    }
    
    .online { 
      background: var(--green);
      color: var(--white);
    }
    
    .offline { 
      background: var(--red);
      color: var(--white);
    }
    
    /* Mini Floating Scorecard */
    .mini-scorecard {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      border-radius: 8px;
      padding: 8px 15px;
      border: 1px solid var(--secondary-blue);
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      z-index: 50;
      display: flex;
      gap: 15px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .mini-scorecard.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .mini-scorecard-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .mini-scorecard-runs {
      font-weight: bold;
      color: var(--accent-yellow);
    }
    
    .mini-scorecard-overs {
      color: var(--gray);
      font-size: 0.8rem;
    }
    
    /* Timeout Button */
    .timeout-btn {
      width: 100%;
      padding: 10px;
      background: var(--orange);
      color: var(--white);
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      margin: 10px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    .timeout-btn:disabled {
      background: var(--dark-gray);
      cursor: not-allowed;
    }
    
    /* Commentary */
    .commentary-container {
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
      margin: 10px 0;
      border: 1px solid var(--secondary-blue);
    }
    
    .commentary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: rgba(30, 136, 229, 0.3);
      border-bottom: 1px solid var(--secondary-blue);
    }
    
    .commentary-title {
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .commentary-controls {
      display: flex;
      gap: 5px;
    }
    
    .commentary-btn {
      padding: 3px 8px;
      background: rgba(255,255,255,0.1);
      border: none;
      color: var(--white);
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
    }
    
    .commentary-box {
      max-height: 150px;
      overflow-y: auto;
      padding: 8px;
      font-size: 0.85rem;
    }
    
    .commentary-item {
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      text-align: left;
      animation: fadeIn 0.3s ease-in;
    }
    
    .commentary-time {
      color: var(--gray);
      font-size: 0.7rem;
      margin-right: 5px;
    }
    
    .commentary-item.wicket {
      color: var(--red);
    }
    
    .commentary-item.boundary {
      color: var(--accent-yellow);
    }
    
    .commentary-item.milestone {
      color: var(--green);
    }
    
    /* Timeline */
    .timeline-container {
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid var(--secondary-blue);
    }
    
    .timeline-title {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 8px;
      text-align: left;
    }
    
    .timeline {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding-bottom: 5px;
    }
    
    .timeline-item {
      min-width: 80px;
      padding: 6px;
      border-radius: 4px;
      background: rgba(30, 136, 229, 0.2);
      font-size: 0.75rem;
      text-align: center;
      flex-shrink: 0;
    }
    
    .timeline-over {
      font-weight: bold;
      margin-bottom: 3px;
    }
    
    .timeline-event {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .timeline-item.wicket {
      background: rgba(244, 67, 54, 0.2);
      border-left: 2px solid var(--red);
    }
    
    .timeline-item.boundary {
      background: rgba(255, 193, 7, 0.2);
      border-left: 2px solid var(--accent-yellow);
    }
    
    .timeline-item.milestone {
      background: rgba(76, 175, 80, 0.2);
      border-left: 2px solid var(--green);
    }
    
    /* Player Comparison */
    .comparison-container {
      background: rgba(0,0,0,0.7);
      border-radius: 8px;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid var(--secondary-blue);
    }
    
    .comparison-title {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 8px;
      text-align: left;
    }
    
    .comparison-box {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    
    .player-comparison {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      text-align: center;
    }
    
    .batter-comparison {
      background: rgba(76, 175, 80, 0.1);
      border-left: 3px solid var(--green);
    }
    
    .bowler-comparison {
      background: rgba(244, 67, 54, 0.1);
      border-left: 3px solid var(--red);
    }
    
    .comparison-header {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--gray);
      margin-bottom: 5px;
    }
    
    .comparison-name {
      font-weight: bold;
      margin: 5px 0;
      font-size: 0.9rem;
    }
    
    .comparison-stats {
      font-size: 0.8rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    
    .comparison-stats div {
      flex: 1;
      min-width: 50%;
      margin: 3px 0;
    }
    
    .vs-circle {
      width: 35px;
      height: 35px;
      background: var(--secondary-blue);
      color: var(--white);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.8rem;
    }
    
    /* Over Progress */
    .over-progress {
      background: rgba(0,0,0,0.5);
      padding: 8px;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .over-title {
      font-size: 0.8rem;
      color: var(--gray);
      margin-bottom: 5px;
      text-align: left;
    }
    
    .balls-container {
      display: flex;
      gap: 5px;
      justify-content: center;
    }
    
    /* Loading Spinner */
    .loading-spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid var(--secondary-blue);
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none;
    }
    
    /* Animations */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes scoreIncrease {
      0% { transform: scale(1); color: var(--white); }
      50% { transform: scale(1.3); color: var(--green); }
      100% { transform: scale(1); color: var(--white); }
    }
    
    @keyframes wicketFlash {
      0% { background-color: rgba(244, 67, 54, 0); }
      50% { background-color: rgba(244, 67, 54, 0.3); }
      100% { background-color: rgba(244, 67, 54, 0); }
    }
    
    @keyframes boundary {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); color: var(--accent-yellow); }
      100% { transform: scale(1); }
    }
    
    .score-change {
      animation: scoreIncrease 0.8s ease-in-out;
    }
    
    .wicket-flash {
      animation: wicketFlash 1.5s ease-in-out;
    }
    
    .boundary-flash {
      animation: boundary 1s ease-in-out;
    }
    
    /* Notification */
    .notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      color: var(--white);
      padding: 15px 25px;
      border-radius: 8px;
      z-index: 1001;
      font-size: 1rem;
      text-align: center;
      animation: fadeInOut 3s forwards;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }
    
    .notification.batting {
      border-left: 4px solid var(--green);
    }
    
    .notification.error {
      border-left: 4px solid var(--red);
    }
    
    .notification.info {
      border-left: 4px solid var(--accent-yellow);
    }
    
    /* Responsive */
    @media (max-width: 480px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .game-controls {
        flex-wrap: wrap;
        gap: 5px;
      }
      
      .control-btn {
        flex: 1;
        min-width: 120px;
      }
      
      .cards {
        grid-template-columns: repeat(4, 1fr);
      }
      
      .mini-scorecard {
        padding: 6px 10px;
        font-size: 0.8rem;
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- Stadium Background -->
  <div class="stadium-background"></div>
  
  <!-- Mini Floating Scorecard -->
  <div class="mini-scorecard" id="miniScorecard">
    <div class="mini-scorecard-item">
      <span id="miniScoreRuns">0</span>/<span id="miniScoreWickets" class="wickets">0</span>
    </div>
    <div class="mini-scorecard-item">
      <span class="mini-scorecard-overs" id="miniScoreOvers">(0.0)</span>
    </div>
    <div class="mini-scorecard-item">
      <span class="mini-scorecard-runs" id="miniScoreRR">RR: 0.00</span>
    </div>
  </div>
  
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="match-title">HandiCricket</div>
      <div class="room-info">
        Room: <span class="room-code" id="roomCode"></span> | 
        <span id="connectionStatus">Connected</span>
      </div>
    </div>
    
    <!-- Timeout Button -->
    <button id="timeoutBtn" class="timeout-btn" disabled>
      <i class="fas fa-clock"></i> Timeout (1 left)
    </button>
    
    <!-- Scoreboard -->
    <div class="scoreboard">
      <div class="scoreboard-main">
        <div class="score">
          <span id="teamRuns">0</span>/<span id="teamWickets" class="wickets">0</span>
        </div>
        <div class="overs">
          <span id="currentOver">0.0</span> ov
        </div>
      </div>
      <div class="scoreboard-details">
        <div id="battingTeamName">Team A</div>
        <div class="run-rate">RR: <span id="runRate">0.00</span></div>
      </div>
    </div>
    
    <!-- Status Indicators -->
    <div class="status-indicators">
      <span id="powerplayIndicator" class="status-indicator powerplay" style="display: none;">Powerplay</span>
      <span id="deadOverIndicator" class="status-indicator dead-over" style="display: none;">Dead Over</span>
      <span id="freeHitIndicator" class="status-indicator free-hit" style="display: none;">Free Hit</span>
      <span id="roleText" class="status-indicator" style="background: var(--secondary-blue);">You are Batting</span>
    </div>
    
    <!-- Game controls -->
    <div class="game-controls">
      <button class="control-btn save-btn" id="saveExitBtn"><i class="fas fa-save"></i> Save & Exit</button>
      <button class="control-btn exit-btn" id="exitBtn"><i class="fas fa-times"></i> Exit</button>
      <button class="control-btn reset-btn" id="resetBtn"><i class="fas fa-undo"></i> Reset Plays</button>
      <button class="control-btn summary-btn" id="summaryBtn"><i class="fas fa-chart-bar"></i> Summary</button>
    </div>
    
    <!-- Player cards -->
    <div class="player-cards">
      <div class="player-card">
        <div class="player-card-header">
          <div>
            <div class="player-name" id="batterName">Batter</div>
            <div class="player-role">Batting</div>
          </div>
          <div class="player-momentum">
            <div class="momentum-bar">
              <div class="momentum-fill" style="width: 50%; background: var(--success); height: 5px; border-radius: 3px;"></div>
            </div>
          </div>
        </div>
        <div class="player-stats">
          <div class="stat-item">
            <span class="stat-label">Runs:</span>
            <span class="stat-value" id="batterRuns">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Balls:</span>
            <span class="stat-value" id="batterBalls">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">4s/6s:</span>
            <span class="stat-value" id="batterBoundaries">0/0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">SR:</span>
            <span class="stat-value" id="batterStrikeRate">0.00</span>
          </div>
        </div>
      </div>
      
      <div class="player-card">
        <div class="player-card-header">
          <div>
            <div class="player-name" id="bowlerName">Bowler</div>
            <div class="player-role">Bowling</div>
          </div>
          <div class="player-momentum">
            <div class="momentum-bar">
              <div class="momentum-fill" style="width: 50%; background: var(--danger); height: 5px; border-radius: 3px;"></div>
            </div>
          </div>
        </div>
        <div class="player-stats">
          <div class="stat-item">
            <span class="stat-label">Overs:</span>
            <span class="stat-value" id="bowlerOvers">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Wickets:</span>
            <span class="stat-value" id="bowlerWickets">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Runs:</span>
            <span class="stat-value" id="bowlerRuns">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Econ:</span>
            <span class="stat-value" id="bowlerEconomy">0.00</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Over Progress -->
    <div class="over-progress">
      <div class="over-title">Current Over</div>
      <div class="balls-container" id="ballsContainer">
        <!-- Balls will be added dynamically -->
      </div>
    </div>
    
    <!-- Card selection -->
    <div class="card-selection">
      <div class="card-selection-header" id="selectionPrompt">Select your card (0-6)</div>
      <div class="cards">
        <div class="card" data-value="0">0</div>
        <div class="card" data-value="1">1</div>
        <div class="card" data-value="2">2</div>
        <div class="card" data-value="3">3</div>
        <div class="card" data-value="4">4</div>
        <div class="card" data-value="5">5</div>
        <div class="card" data-value="6">6</div>
      </div>
    </div>
    
    <!-- Player Comparison -->
    <div class="comparison-container">
      <div class="comparison-title">Current Battle</div>
      <div class="comparison-box">
        <div class="player-comparison batter-comparison">
          <div class="comparison-header">Batter</div>
          <div class="comparison-name" id="comparisonBatterName">-</div>
          <div class="comparison-stats">
            <div>Runs: <span id="comparisonBatterRuns">0</span></div>
            <div>Balls: <span id="comparisonBatterBalls">0</span></div>
            <div>SR: <span id="comparisonBatterSR">0.00</span></div>
            <div>4s/6s: <span id="comparisonBatterBoundaries">0/0</span></div>
          </div>
        </div>
        <div class="vs-circle">VS</div>
        <div class="player-comparison bowler-comparison">
          <div class="comparison-header">Bowler</div>
          <div class="comparison-name" id="comparisonBowlerName">-</div>
          <div class="comparison-stats">
            <div>Overs: <span id="comparisonBowlerOvers">0.0</span></div>
            <div>Wkts: <span id="comparisonBowlerWickets">0</span></div>
            <div>ER: <span id="comparisonBowlerER">0.00</span></div>
            <div>Runs: <span id="comparisonBowlerRuns">0</span></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Commentary -->
    <div class="commentary-container">
      <div class="commentary-header">
        <div class="commentary-title">Match Commentary</div>
        <div class="commentary-controls">
          <button id="pauseCommentary" class="commentary-btn">Pause</button>
          <button id="clearCommentary" class="commentary-btn">Clear</button>
        </div>
      </div>
      <div class="commentary-box" id="commentaryBox">
        <!-- Commentary will be added here -->
      </div>
    </div>
    
    <!-- Match info -->
    <div class="match-info">
      <div class="info-tabs">
        <div class="info-tab active" data-tab="fow">Fall of Wickets</div>
        <div class="info-tab" data-tab="overs">Over Summary</div>
        <div class="info-tab" data-tab="timeline">Timeline</div>
      </div>
      
      <div class="info-content active" id="fow-content">
        <ul class="fow-list" id="fowList">
          <li class="fow-item">No wickets yet</li>
        </ul>
      </div>
      
      <div class="info-content" id="overs-content">
        <div class="over-summary" id="overSummary">
          No balls bowled yet
        </div>
      </div>
      
      <div class="info-content" id="timeline-content">
        <div class="timeline" id="timeline">
          <!-- Timeline items will be added here -->
        </div>
      </div>
    </div>
    
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status online">
      Opponent: Online
    </div>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner"></div>
  </div>
  
  <!-- Player selection modal -->
  <div class="modal" id="playerModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Select Player</div>
        <button class="close-modal" id="closeModal">&times;</button>
      </div>
      <ul class="player-list" id="modalPlayerList">
        <!-- Players will be added here dynamically -->
      </ul>
      <button class="confirm-btn" id="confirmSelection">Confirm</button>
    </div>
  </div>
  
  <!-- Match summary modal -->
  <div class="modal" id="summaryModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Match Summary</div>
        <button class="close-modal" id="closeSummaryModal">&times;</button>
      </div>
      <div id="summaryContent">
        <!-- Summary content will be added here dynamically -->
      </div>
    </div>
  </div>

  <!-- Match Summary Screen -->
  <div id="matchSummary" class="match-summary">
    <div class="match-summary-header">
      <div class="match-summary-title">MATCH SUMMARY</div>
      <div class="match-summary-subtitle">HandiCricket</div>
    </div>
    
    <div class="player-of-match">
      <div class="player-of-match-name" id="potmName">-</div>
      <div class="player-of-match-stats" id="potmStats">-</div>
    </div>
    
    <div class="match-summary-grid">
      <div class="match-summary-panel">
        <div class="match-summary-panel-title">BATTING CARD</div>
        <div class="scorecard" id="battingCard"></div>
      </div>
      <div class="match-summary-panel">
        <div class="match-summary-panel-title">BOWLING CARD</div>
        <div class="scorecard" id="bowlingCard"></div>
      </div>
    </div>
    
    <div class="match-result" id="matchResult"></div>
    
    <button class="close-summary-btn" id="closeMatchSummary">Close</button>
  </div>

  <!-- Audio Elements -->
  <audio id="boundarySound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3"></audio>
  <audio id="wicketSound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-retro-game-over-213.mp3"></audio>
  <audio id="crowdSound" src="https://assets.mixkit.co/sfx/preview/mixkit-crowd-cheering-loop-2293.mp3" loop></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, get, push, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCN6aZMwlsZe7JJaovU0WA3UQygWr4jYmA",
      authDomain: "handicricket-85a06.firebaseapp.com",
      projectId: "handicricket-85a06",
      storageBucket: "handicricket-85a06.appspot.com",
      messagingSenderId: "599182538558",
      appId: "1:599182538558:web:3e965753ab05f8f1e3de6f",
      measurementId: "G-HSV9H4LEJQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room');
    const playerRole = params.get('player'); // player1, player2, or spectator
    const teamName = decodeURIComponent(params.get('team') || 'Your Team');
    
    if (!roomId || !playerRole) {
      alert('Invalid room or player role');
      window.location.href = 'index.html';
    }

    // DOM elements
    const roomCodeEl = document.getElementById('roomCode');
    const connectionStatusEl = document.getElementById('connectionStatus');
    const teamRunsEl = document.getElementById('teamRuns');
    const teamWicketsEl = document.getElementById('teamWickets');
    const currentOverEl = document.getElementById('currentOver');
    const battingTeamNameEl = document.getElementById('battingTeamName');
    const runRateEl = document.getElementById('runRate');
    
    const batterNameEl = document.getElementById('batterName');
    const batterRunsEl = document.getElementById('batterRuns');
    const batterBallsEl = document.getElementById('batterBalls');
    const batterBoundariesEl = document.getElementById('batterBoundaries');
    const batterStrikeRateEl = document.getElementById('batterStrikeRate');
    
    const bowlerNameEl = document.getElementById('bowlerName');
    const bowlerOversEl = document.getElementById('bowlerOvers');
    const bowlerWicketsEl = document.getElementById('bowlerWickets');
    const bowlerRunsEl = document.getElementById('bowlerRuns');
    const bowlerEconomyEl = document.getElementById('bowlerEconomy');
    
    const selectionPromptEl = document.getElementById('selectionPrompt');
    const cards = document.querySelectorAll('.card');
    const fowListEl = document.getElementById('fowList');
    const overSummaryEl = document.getElementById('overSummary');
    const timelineEl = document.getElementById('timeline');
    
    const playerModal = document.getElementById('playerModal');
    const modalTitleEl = document.getElementById('modalTitle');
    const modalPlayerListEl = document.getElementById('modalPlayerList');
    const closeModalBtn = document.getElementById('closeModal');
    const confirmSelectionBtn = document.getElementById('confirmSelection');
    
    const summaryModal = document.getElementById('summaryModal');
    const summaryContentEl = document.getElementById('summaryContent');
    const closeSummaryModalBtn = document.getElementById('closeSummaryModal');
    
    const saveExitBtn = document.getElementById('saveExitBtn');
    const exitBtn = document.getElementById('exitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const summaryBtn = document.getElementById('summaryBtn');
    
    const miniScoreRuns = document.getElementById('miniScoreRuns');
    const miniScoreWickets = document.getElementById('miniScoreWickets');
    const miniScoreOvers = document.getElementById('miniScoreOvers');
    const miniScoreRR = document.getElementById('miniScoreRR');
    const miniScorecard = document.getElementById('miniScorecard');
    
    const timeoutBtn = document.getElementById('timeoutBtn');
    const powerplayIndicator = document.getElementById('powerplayIndicator');
    const deadOverIndicator = document.getElementById('deadOverIndicator');
    const freeHitIndicator = document.getElementById('freeHitIndicator');
    const roleText = document.getElementById('roleText');
    const ballsContainer = document.getElementById('ballsContainer');
    
    const comparisonBatterName = document.getElementById('comparisonBatterName');
    const comparisonBatterRuns = document.getElementById('comparisonBatterRuns');
    const comparisonBatterBalls = document.getElementById('comparisonBatterBalls');
    const comparisonBatterSR = document.getElementById('comparisonBatterSR');
    const comparisonBatterBoundaries = document.getElementById('comparisonBatterBoundaries');
    const comparisonBowlerName = document.getElementById('comparisonBowlerName');
    const comparisonBowlerOvers = document.getElementById('comparisonBowlerOvers');
    const comparisonBowlerWickets = document.getElementById('comparisonBowlerWickets');
    const comparisonBowlerER = document.getElementById('comparisonBowlerER');
    const comparisonBowlerRuns = document.getElementById('comparisonBowlerRuns');
    
    const commentaryBox = document.getElementById('commentaryBox');
    const pauseCommentaryBtn = document.getElementById('pauseCommentary');
    const clearCommentaryBtn = document.getElementById('clearCommentary');
    
    const matchSummary = document.getElementById('matchSummary');
    const potmName = document.getElementById('potmName');
    const potmStats = document.getElementById('potmStats');
    const battingCard = document.getElementById('battingCard');
    const bowlingCard = document.getElementById('bowlingCard');
    const matchResult = document.getElementById('matchResult');
    const closeMatchSummary = document.getElementById('closeMatchSummary');
    
    const boundarySound = document.getElementById('boundarySound');
    const wicketSound = document.getElementById('wicketSound');
    const crowdSound = document.getElementById('crowdSound');
    const loadingSpinner = document.getElementById('loadingSpinner');

    // Game state
    let gameState = {
      matchFormat: '5', // Default to T5
      battingTeam: 'player1',
      bowlingTeam: 'player2',
      currentInnings: 1,
      totalOvers: 5,
      powerplayOvers: 2,
      powerplayWicketValue: 0.5,
      regularWicketValue: 1.0,
      deadOvers: [],
      runs: 0,
      wickets: 0,
      balls: 0,
      overs: 0,
      currentBatter: null,
      currentBowler: null,
      players: {
        player1: [],
        player2: []
      },
      stats: {
        player1: {},
        player2: {}
      },
      fallOfWickets: [],
      overHistory: [],
      currentOver: [],
      selectedCard: null,
      opponentSelectedCard: null,
      gameStarted: false,
      tossCompleted: false,
      isPowerplay: true,
      freeHit: false,
      drsAvailable: true,
      team1Name: 'Team A',
      team2Name: 'Team B',
      timeoutAvailable: true,
      timeoutActive: false,
      commentaryPaused: false
    };

    // Firebase references
    const roomRef = ref(db, `rooms/${roomId}`);
    const gameRef = ref(db, `games/${roomId}`);
    const playerRef = ref(db, `rooms/${roomId}/${playerRole}`);
    const opponentRef = ref(db, `rooms/${roomId}/${playerRole === 'player1' ? 'player2' : 'player1'}`);
    const playsRef = ref(db, `games/${roomId}/plays`);
    const selectionRef = ref(db, `games/${roomId}/selection`);
    const timeoutRef = ref(db, `games/${roomId}/timeout`);

    // Initialize UI
    roomCodeEl.textContent = roomId;
    
    // Set player online status
    set(playerRef, {
      name: teamName,
      connected: true,
      lastActive: Date.now()
    }).catch(error => {
      console.error('Error setting player status:', error);
    });

    // Handle opponent disconnect
    onValue(opponentRef, (snap) => {
      if (!snap.exists() || !snap.val().connected) {
        connectionStatusEl.textContent = 'Opponent disconnected';
        connectionStatusEl.style.color = 'var(--danger)';
      } else {
        connectionStatusEl.textContent = 'Connected';
        connectionStatusEl.style.color = 'var(--success)';
      }
    });

    // Load game data
    onValue(gameRef, (snap) => {
      if (snap.exists()) {
        const data = snap.val();
        
        // Update game state
        gameState.matchFormat = data.matchFormat || '5';
        gameState.battingTeam = data.battingTeam || 'player1';
        gameState.bowlingTeam = data.bowlingTeam || 'player2';
        gameState.currentInnings = data.currentInnings || 1;
        gameState.runs = data.runs || 0;
        gameState.wickets = data.wickets || 0;
        gameState.balls = data.balls || 0;
        gameState.overs = data.overs || 0;
        gameState.currentBatter = data.currentBatter || null;
        gameState.currentBowler = data.currentBowler || null;
        gameState.players = data.players || { player1: [], player2: [] };
        gameState.stats = data.stats || { player1: {}, player2: {} };
        gameState.fallOfWickets = data.fallOfWickets || [];
        gameState.overHistory = data.overHistory || [];
        gameState.currentOver = data.currentOver || [];
        gameState.gameStarted = data.gameStarted || false;
        gameState.tossCompleted = data.tossCompleted || false;
        gameState.isPowerplay = data.isPowerplay || true;
        gameState.freeHit = data.freeHit || false;
        gameState.drsAvailable = data.drsAvailable !== false;
        gameState.team1Name = data.team1Name || 'Team A';
        gameState.team2Name = data.team2Name || 'Team B';
        gameState.timeoutAvailable = data.timeoutAvailable !== false;
        gameState.timeoutActive = data.timeoutActive || false;
        
        // Set format-specific values
        setFormatValues(gameState.matchFormat);
        
        // Update UI
        updateUI();
      } else {
        // Initialize new game
        initializeGame();
      }
    });

    // Listen for plays
    onValue(playsRef, (snap) => {
      if (snap.exists()) {
        const plays = snap.val();
        const lastPlayKey = Object.keys(plays).pop();
        const lastPlay = plays[lastPlayKey];
        
        if (lastPlay.player !== playerRole) {
          handlePlayResult(lastPlay);
        }
      }
    });

    // Listen for player selections
    onValue(selectionRef, (snap) => {
      if (snap.exists()) {
        const selection = snap.val();
        
        if (selection.player !== playerRole) {
          if (selection.type === 'batter' && playerRole === gameState.battingTeam) {
            showPlayerSelectionModal('batter', 'Select new batter');
          } else if (selection.type === 'bowler' && playerRole === gameState.bowlingTeam) {
            showPlayerSelectionModal('bowler', 'Select new bowler');
          }
        }
      }
    });

    // Listen for timeout
    onValue(timeoutRef, (snap) => {
      if (snap.exists()) {
        const timeout = snap.val();
        if (timeout.player !== playerRole) {
          gameState.timeoutActive = timeout.active;
          updateTimeoutButton();
          
          if (timeout.active) {
            addCommentary(`🚨 Timeout taken by ${timeout.player === 'player1' ? gameState.team1Name : gameState.team2Name}`, 'milestone');
          }
        }
      }
    });

    // Set format-specific values
    function setFormatValues(format) {
      switch(format) {
        case '5': // T5
          gameState.totalOvers = 5;
          gameState.powerplayOvers = 2;
          gameState.powerplayWicketValue = 0.5;
          gameState.regularWicketValue = 1.0;
          gameState.deadOvers = [];
          break;
        case '10': // T10
          gameState.totalOvers = 10;
          gameState.powerplayOvers = 3;
          gameState.powerplayWicketValue = 0.5;
          gameState.regularWicketValue = 1.0;
          gameState.deadOvers = [];
          break;
        case '20': // T20
          gameState.totalOvers = 20;
          gameState.powerplayOvers = 6;
          gameState.powerplayWicketValue = 0.5;
          gameState.regularWicketValue = 1.0;
          gameState.deadOvers = [];
          break;
        case '50': // ODI
          gameState.totalOvers = 50;
          gameState.powerplayOvers = 10;
          gameState.powerplayWicketValue = 0.25;
          gameState.regularWicketValue = 0.5;
          gameState.deadOvers = [40, 45, 48];
          break;
        default:
          gameState.totalOvers = 5;
          gameState.powerplayOvers = 2;
          gameState.powerplayWicketValue = 0.5;
          gameState.regularWicketValue = 1.0;
          gameState.deadOvers = [];
      }
      
      // Check if we're in powerplay
      gameState.isPowerplay = gameState.overs < gameState.powerplayOvers;
    }

    // Initialize new game
    function initializeGame() {
      // Get match format from room data
      get(roomRef).then((snap) => {
        if (snap.exists()) {
          const roomData = snap.val();
          
          // Set format from room data
          gameState.matchFormat = roomData.player1?.format || '5';
          setFormatValues(gameState.matchFormat);
          
          // Set team names
          gameState.players.player1 = roomData.teams?.player1?.players || [];
          gameState.players.player2 = roomData.teams?.player2?.players || [];
          gameState.team1Name = roomData.teams?.player1?.name || 'Team A';
          gameState.team2Name = roomData.teams?.player2?.name || 'Team B';
          
          // Check if both players are connected
          const player1Connected = roomData.player1?.connected;
          const player2Connected = roomData.player2?.connected;
          
          if (player1Connected && player2Connected) {
            // Set toss result
            if (roomData.toss) {
              gameState.battingTeam = roomData.toss.battingFirst;
              gameState.bowlingTeam = roomData.toss.battingFirst === 'player1' ? 'player2' : 'player1';
              gameState.tossCompleted = true;
              
              // Set initial batter and bowler
              if (gameState.players[gameState.battingTeam]?.length > 0) {
                gameState.currentBatter = gameState.players[gameState.battingTeam][0];
              }
              
              if (gameState.players[gameState.bowlingTeam]?.length > 0) {
                gameState.currentBowler = gameState.players[gameState.bowlingTeam][0];
              }
              
              // Initialize stats
              initializePlayerStats();
              
              // Start game
              gameState.gameStarted = true;
              updateGameState();
              
              // Show selection prompts if needed
              if (playerRole === gameState.battingTeam && !gameState.currentBatter) {
                showPlayerSelectionModal('batter', 'Select opening batter');
              } else if (playerRole === gameState.bowlingTeam && !gameState.currentBowler) {
                showPlayerSelectionModal('bowler', 'Select opening bowler');
              }
            }
          } else {
            // If not both players connected, wait and check again
            setTimeout(initializeGame, 1000);
          }
        }
      }).catch(error => {
        console.error('Error initializing game:', error);
      });
    }

    // Initialize player stats
    function initializePlayerStats() {
      gameState.players.player1.forEach(player => {
        if (!gameState.stats.player1[player]) {
          gameState.stats.player1[player] = {
            runs: 0,
            balls: 0,
            fours: 0,
            sixes: 0,
            wickets: 0,
            overs: 0,
            maidens: 0,
            conceded: 0,
            out: false
          };
        }
      });
      
      gameState.players.player2.forEach(player => {
        if (!gameState.stats.player2[player]) {
          gameState.stats.player2[player] = {
            runs: 0,
            balls: 0,
            fours: 0,
            sixes: 0,
            wickets: 0,
            overs: 0,
            maidens: 0,
            conceded: 0,
            out: false
          };
        }
      });
    }

    // Update UI based on game state
    function updateUI() {
      // Update scoreboard
      teamRunsEl.textContent = gameState.runs;
      teamWicketsEl.textContent = gameState.wickets;
      miniScoreRuns.textContent = gameState.runs;
      miniScoreWickets.textContent = `/${gameState.wickets}`;
      
      const over = Math.floor(gameState.balls / 6);
      const ball = gameState.balls % 6;
      currentOverEl.textContent = `${over}.${ball}`;
      miniScoreOvers.textContent = `(${over}.${ball})`;
      
      const runRate = gameState.overs > 0 ? (gameState.runs / gameState.overs).toFixed(2) : '0.00';
      runRateEl.textContent = runRate;
      miniScoreRR.textContent = `RR: ${runRate}`;
      
      // Update batting team name
      battingTeamNameEl.textContent = gameState.battingTeam === 'player1' ? gameState.team1Name : gameState.team2Name;
      
      // Update batter stats
      if (gameState.currentBatter) {
        batterNameEl.textContent = gameState.currentBatter;
        comparisonBatterName.textContent = gameState.currentBatter;
        
        const batterStats = gameState.battingTeam === 'player1' ? 
          gameState.stats.player1[gameState.currentBatter] : 
          gameState.stats.player2[gameState.currentBatter];
        
        if (batterStats) {
          batterRunsEl.textContent = batterStats.runs;
          batterBallsEl.textContent = batterStats.balls;
          batterBoundariesEl.textContent = `${batterStats.fours}/${batterStats.sixes}`;
          comparisonBatterRuns.textContent = batterStats.runs;
          comparisonBatterBalls.textContent = batterStats.balls;
          comparisonBatterBoundaries.textContent = `${batterStats.fours}/${batterStats.sixes}`;
          
          const strikeRate = batterStats.balls > 0 ? 
            ((batterStats.runs / batterStats.balls) * 100).toFixed(2) : '0.00';
          batterStrikeRateEl.textContent = strikeRate;
          comparisonBatterSR.textContent = strikeRate;
        }
      }
      
      // Update bowler stats
      if (gameState.currentBowler) {
        bowlerNameEl.textContent = gameState.currentBowler;
        comparisonBowlerName.textContent = gameState.currentBowler;
        
        const bowlerStats = gameState.bowlingTeam === 'player1' ? 
          gameState.stats.player1[gameState.currentBowler] : 
          gameState.stats.player2[gameState.currentBowler];
        
        if (bowlerStats) {
          const overs = Math.floor(bowlerStats.balls / 6);
          const balls = bowlerStats.balls % 6;
          bowlerOversEl.textContent = balls > 0 ? `${overs}.${balls}` : overs;
          comparisonBowlerOvers.textContent = balls > 0 ? `${overs}.${balls}` : overs;
          
          bowlerWicketsEl.textContent = bowlerStats.wickets;
          bowlerRunsEl.textContent = bowlerStats.conceded;
          comparisonBowlerWickets.textContent = bowlerStats.wickets;
          comparisonBowlerRuns.textContent = bowlerStats.conceded;
          
          const economy = bowlerStats.balls > 0 ? 
            ((bowlerStats.conceded / bowlerStats.balls) * 6).toFixed(2) : '0.00';
          bowlerEconomyEl.textContent = economy;
          comparisonBowlerER.textContent = economy;
        }
      }
      
      // Update fall of wickets
      updateFallOfWickets();
      
      // Update over summary
      updateOverSummary();
      
      // Update selection prompt
      updateSelectionPrompt();
      
      // Update over progress
      updateOverProgress();
      
      // Update status indicators
      updateStatusIndicators();
      
      // Update role text
      roleText.textContent = playerRole === gameState.battingTeam ? "You are Batting" : "You are Bowling";
      
      // Enable/disable card selection based on game state
      updateCardSelectionState();
      
      // Update timeout button
      updateTimeoutButton();
    }

    // Update fall of wickets display
    function updateFallOfWickets() {
      fowListEl.innerHTML = '';
      
      if (gameState.fallOfWickets.length === 0) {
        fowListEl.innerHTML = '<li class="fow-item">No wickets yet</li>';
        return;
      }
      
      gameState.fallOfWickets.forEach((wicket, index) => {
        const li = document.createElement('li');
        li.className = 'fow-item';
        
        const over = Math.floor(wicket.ball / 6);
        const ball = wicket.ball % 6;
        
        li.innerHTML = `
          <span>${index + 1}. ${wicket.batter} ${wicket.runs} (${wicket.balls})</span>
          <span>${over}.${ball} ov</span>
        `;
        
        fowListEl.appendChild(li);
      });
    }

    // Update over summary display
    function updateOverSummary() {
      overSummaryEl.innerHTML = '';
      ballsContainer.innerHTML = '';
      
      if (gameState.overHistory.length === 0 && gameState.currentOver.length === 0) {
        overSummaryEl.innerHTML = 'No balls bowled yet';
        return;
      }
      
      // Add completed overs
      gameState.overHistory.forEach((over, overIndex) => {
        const overDiv = document.createElement('div');
        overDiv.style.marginBottom = '10px';
        
        const overTitle = document.createElement('div');
        overTitle.textContent = `Over ${overIndex + 1}:`;
        overTitle.style.fontWeight = 'bold';
        overTitle.style.marginBottom = '5px';
        
        const ballsDiv = document.createElement('div');
        ballsDiv.className = 'over-summary';
        
        over.balls.forEach(ball => {
          const ballDiv = document.createElement('div');
          ballDiv.className = 'ball';
          
          if (ball.result === 'wicket') {
            ballDiv.classList.add('wicket');
            ballDiv.textContent = 'W';
          } else if (ball.result === 'wide') {
            ballDiv.classList.add('wide');
            ballDiv.textContent = 'Wd';
          } else if (ball.result === 'noball') {
            ballDiv.classList.add('noball');
            ballDiv.textContent = 'Nb';
          } else if (ball.runs === 0) {
            ballDiv.classList.add('dot');
            ballDiv.textContent = '•';
          } else if (ball.runs === 4) {
            ballDiv.classList.add('four');
            ballDiv.textContent = '4';
          } else if (ball.runs === 6) {
            ballDiv.classList.add('six');
            ballDiv.textContent = '6';
          } else {
            ballDiv.classList.add('run');
            ballDiv.textContent = ball.runs;
          }
          
          ballsDiv.appendChild(ballDiv);
        });
        
        overDiv.appendChild(overTitle);
        overDiv.appendChild(ballsDiv);
        overSummaryEl.appendChild(overDiv);
      });
      
      // Add current over if not empty
      if (gameState.currentOver.length > 0) {
        const currentOverDiv = document.createElement('div');
        currentOverDiv.style.marginBottom = '10px';
        
        const currentOverTitle = document.createElement('div');
        currentOverTitle.textContent = `Current Over:`;
        currentOverTitle.style.fontWeight = 'bold';
        currentOverTitle.style.marginBottom = '5px';
        
        const currentBallsDiv = document.createElement('div');
        currentBallsDiv.className = 'over-summary';
        
        gameState.currentOver.forEach(ball => {
          const ballDiv = document.createElement('div');
          ballDiv.className = 'ball';
          
          if (ball.result === 'wicket') {
            ballDiv.classList.add('wicket');
            ballDiv.textContent = 'W';
          } else if (ball.result === 'wide') {
            ballDiv.classList.add('wide');
            ballDiv.textContent = 'Wd';
          } else if (ball.result === 'noball') {
            ballDiv.classList.add('noball');
            ballDiv.textContent = 'Nb';
          } else if (ball.runs === 0) {
            ballDiv.classList.add('dot');
            ballDiv.textContent = '•';
          } else if (ball.runs === 4) {
            ballDiv.classList.add('four');
            ballDiv.textContent = '4';
          } else if (ball.runs === 6) {
            ballDiv.classList.add('six');
            ballDiv.textContent = '6';
          } else {
            ballDiv.classList.add('run');
            ballDiv.textContent = ball.runs;
          }
          
          currentBallsDiv.appendChild(ballDiv);
        });
        
        currentOverDiv.appendChild(currentOverTitle);
        currentOverDiv.appendChild(currentBallsDiv);
        overSummaryEl.appendChild(currentOverDiv);
      }
      
      // Update balls in current over
      const ballsThisOver = gameState.balls % 6;
      for (let i = 0; i < 6; i++) {
        const ballEl = document.createElement('div');
        ballEl.className = 'ball';
        
        if (i < ballsThisOver) {
          const ballData = gameState.currentOver[i];
          if (ballData) {
            if (ballData.result === 'wicket') {
              ballEl.className += ' wicket';
              ballEl.textContent = 'W';
            } else if (ballData.result === 'wide') {
              ballEl.className += ' wide';
              ballEl.textContent = 'Wd';
            } else if (ballData.result === 'noball') {
              ballEl.className += ' noball';
              ballEl.textContent = 'Nb';
            } else if (ballData.runs === 0) {
              ballEl.className += ' dot';
              ballEl.textContent = '•';
            } else if (ballData.runs === 4) {
              ballEl.className += ' four';
              ballEl.textContent = '4';
            } else if (ballData.runs === 6) {
              ballEl.className += ' six';
              ballEl.textContent = '6';
            } else {
              ballEl.className += ' run';
              ballEl.textContent = ballData.runs;
            }
          }
        } else {
          ballEl.className += ' empty';
        }
        
        ballsContainer.appendChild(ballEl);
      }
    }

    // Update status indicators
    function updateStatusIndicators() {
      // Powerplay indicator
      powerplayIndicator.style.display = gameState.isPowerplay ? 'inline-block' : 'none';
      
      // Dead over indicator
      const currentOver = Math.floor(gameState.balls / 6);
      const isDeadOver = gameState.deadOvers.includes(currentOver);
      deadOverIndicator.style.display = isDeadOver ? 'inline-block' : 'none';
      
      // Free hit indicator
      freeHitIndicator.style.display = gameState.freeHit ? 'inline-block' : 'none';
    }

    // Update selection prompt based on game state
    function updateSelectionPrompt() {
      if (!gameState.gameStarted) {
        selectionPromptEl.textContent = 'Waiting for game to start...';
        return;
      }
      
      if (playerRole === 'spectator') {
        selectionPromptEl.textContent = 'Spectator mode - watching the game';
        return;
      }
      
      if (playerRole === gameState.battingTeam) {
        selectionPromptEl.textContent = 'Select your batting card (0-6)';
      } else if (playerRole === gameState.bowlingTeam) {
        selectionPromptEl.textContent = 'Select your bowling card (0-6)';
      }
    }

    // Update card selection state
    function updateCardSelectionState() {
      const canSelect = gameState.gameStarted && 
                       (playerRole === gameState.battingTeam || playerRole === gameState.bowlingTeam) &&
                       playerRole !== 'spectator';
      
      cards.forEach(card => {
        if (canSelect) {
          card.style.cursor = 'pointer';
          card.style.opacity = '1';
        } else {
          card.style.cursor = 'not-allowed';
          card.style.opacity = '0.5';
        }
      });
    }

    // Update timeout button
    function updateTimeoutButton() {
      timeoutBtn.disabled = !gameState.timeoutAvailable || gameState.timeoutActive || 
                           (playerRole !== gameState.battingTeam && playerRole !== gameState.bowlingTeam);
      
      timeoutBtn.innerHTML = gameState.timeoutActive ? 
        '<i class="fas fa-clock"></i> Timeout Active' : 
        '<i class="fas fa-clock"></i> Timeout (1 left)';
    }

    // Handle card selection
    cards.forEach(card => {
      card.addEventListener('click', () => {
        if (!gameState.gameStarted || playerRole === 'spectator') return;
        
        // Check if we're batting or bowling
        const isBatting = playerRole === gameState.battingTeam;
        
        // Check if we've already selected a card
        if (gameState.selectedCard !== null) return;
        
        // Select the card
        const value = parseInt(card.dataset.value);
        gameState.selectedCard = value;
        
        // Highlight selected card
        cards.forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        
        // Save selection to Firebase
        const playRef = push(playsRef);
        set(playRef, {
          player: playerRole,
          card: value,
          isBatting: isBatting,
          timestamp: Date.now()
        }).then(() => {
          selectionPromptEl.textContent = isBatting ? 
            'Waiting for bowler to select...' : 
            'Waiting for batter to select...';
        });
      });
    });

    // Handle play result
    function handlePlayResult(play) {
      if (play.player === playerRole) return;
      
      // Store opponent's selection
      if (play.isBatting && playerRole === gameState.bowlingTeam) {
        gameState.opponentSelectedCard = play.card;
      } else if (!play.isBatting && playerRole === gameState.battingTeam) {
        gameState.opponentSelectedCard = play.card;
      }
      
      // If both have selected, determine outcome
      if (gameState.selectedCard !== null && gameState.opponentSelectedCard !== null) {
        determineOutcome();
      }
    }

    // Determine outcome of the ball
    function determineOutcome() {
      const batterCard = playerRole === gameState.battingTeam ? gameState.selectedCard : gameState.opponentSelectedCard;
      const bowlerCard = playerRole === gameState.bowlingTeam ? gameState.selectedCard : gameState.opponentSelectedCard;
      
      let runs = 0;
      let result = 'normal';
      let isWicket = false;
      let isExtra = false;
      
      // Special case: both selected 0
      if (batterCard === 0 && bowlerCard === 0) {
        result = 'noball';
        isExtra = true;
        runs = 1; // No ball + free hit
        gameState.freeHit = true;
        addCommentary('No ball! Free hit awarded', 'milestone');
        playSound(boundarySound);
      } 
      // Batter selected 0, bowler selected 1-6
      else if (batterCard === 0 && bowlerCard > 0) {
        result = 'dot';
        runs = 0;
        addCommentary('Dot ball', 'normal');
      } 
      // Bowler selected 0, batter selected 1-6
      else if (bowlerCard === 0 && batterCard > 0) {
        result = 'normal';
        runs = batterCard;
        addCommentary(`${runs} run${runs === 1 ? '' : 's'} scored`, runs >= 4 ? 'boundary' : 'normal');
        if (runs >= 4) playSound(boundarySound);
      } 
      // Both selected same number (1-6)
      else if (batterCard === bowlerCard) {
        if (gameState.freeHit) {
          result = 'normal';
          runs = batterCard;
          gameState.freeHit = false;
          addCommentary(`${runs} run${runs === 1 ? '' : 's'} scored on free hit`, runs >= 4 ? 'boundary' : 'normal');
          if (runs >= 4) playSound(boundarySound);
        } else {
          result = 'wicket';
          isWicket = true;
          runs = 0;
          addCommentary('Wicket!', 'wicket');
          playSound(wicketSound);
        }
      } 
      // Different numbers
      else {
        result = 'normal';
        runs = batterCard;
        addCommentary(`${runs} run${runs === 1 ? '' : 's'} scored`, runs >= 4 ? 'boundary' : 'normal');
        if (runs >= 4) playSound(boundarySound);
      }
      
      // Update game state
      updateGameAfterBall(runs, result, isWicket, isExtra);
      
      // Reset selections for next ball
      gameState.selectedCard = null;
      gameState.opponentSelectedCard = null;
      cards.forEach(c => c.classList.remove('selected'));
      
      // Update UI
      updateUI();
    }

    // Update game state after a ball is bowled
    function updateGameAfterBall(runs, result, isWicket, isExtra) {
      // Increment ball count (unless it's an extra)
      if (!isExtra) {
        gameState.balls++;
        
        // Update batter stats
        const batterStats = gameState.battingTeam === 'player1' ? 
          gameState.stats.player1[gameState.currentBatter] : 
          gameState.stats.player2[gameState.currentBatter];
        
        if (batterStats) {
          batterStats.balls++;
          if (runs > 0) {
            batterStats.runs += runs;
            if (runs === 4) batterStats.fours++;
            if (runs === 6) batterStats.sixes++;
          }
        }
      }
      
      // Update bowler stats
      const bowlerStats = gameState.bowlingTeam === 'player1' ? 
        gameState.stats.player1[gameState.currentBowler] : 
        gameState.stats.player2[gameState.currentBowler];
      
      if (bowlerStats) {
        if (!isExtra) bowlerStats.balls++;
        bowlerStats.conceded += runs;
        
        if (isWicket) {
          bowlerStats.wickets++;
        }
      }
      
      // Add runs to total
      gameState.runs += runs;
      
      // Handle wicket
      if (isWicket) {
        gameState.wickets++;
        
        // Add to fall of wickets
        const batterStats = gameState.battingTeam === 'player1' ? 
          gameState.stats.player1[gameState.currentBatter] : 
          gameState.stats.player2[gameState.currentBatter];
        
        gameState.fallOfWickets.push({
          batter: gameState.currentBatter,
          runs: batterStats.runs,
          balls: batterStats.balls,
          ball: gameState.balls
        });
        
        // Mark batter as out
        batterStats.out = true;
        
        // Check if innings is over (all out)
        if (gameState.wickets >= gameState.players[gameState.battingTeam].length - 1) {
          endInnings();
          return;
        }
        
        // Prompt for new batter
        showPlayerSelectionModal('batter', 'Select new batter');
      }
      
      // Add to current over
      gameState.currentOver.push({
        runs: runs,
        result: result,
        batter: gameState.currentBatter,
        bowler: gameState.currentBowler
      });
      
      // Check if over is complete (6 balls, excluding extras)
      const validBalls = gameState.currentOver.filter(ball => ball.result !== 'wide' && ball.result !== 'noball').length;
      if (validBalls >= 6) {
        completeOver();
      }
      
      // Check if innings is over (all overs bowled)
      if (gameState.overs >= gameState.totalOvers) {
        endInnings();
        return;
      }
      
      // Check if powerplay has ended
      if (gameState.isPowerplay && gameState.overs >= gameState.powerplayOvers) {
        gameState.isPowerplay = false;
        addCommentary('Powerplay has ended', 'milestone');
      }
      
      // Save game state
      updateGameState();
    }

    // Complete the current over
    function completeOver() {
      // Add current over to history
      gameState.overHistory.push({
        bowler: gameState.currentBowler,
        balls: [...gameState.currentOver]
      });
      
      // Reset current over
      gameState.currentOver = [];
      
      // Increment over count
      gameState.overs++;
      
      addCommentary(`Over completed by ${gameState.currentBowler}`, 'milestone');
      
      // Prompt for new bowler
      showPlayerSelectionModal('bowler', 'Select new bowler');
      
      // Save game state
      updateGameState();
    }

    // End the current innings
    function endInnings() {
      // Complete current over if not empty
      if (gameState.currentOver.length > 0) {
        gameState.overHistory.push({
          bowler: gameState.currentBowler,
          balls: [...gameState.currentOver]
        });
        gameState.currentOver = [];
      }
      
      // Determine next innings
      if (gameState.currentInnings === 1) {
        // Switch to second innings
        gameState.currentInnings = 2;
        gameState.battingTeam = gameState.battingTeam === 'player1' ? 'player2' : 'player1';
        gameState.bowlingTeam = gameState.bowlingTeam === 'player1' ? 'player2' : 'player1';
        gameState.runs = 0;
        gameState.wickets = 0;
        gameState.balls = 0;
        gameState.overs = 0;
        gameState.isPowerplay = true;
        gameState.freeHit = false;
        
        // Reset player stats for new innings
        initializePlayerStats();
        
        addCommentary(`First innings completed. ${gameState.battingTeam === 'player1' ? gameState.team1Name : gameState.team2Name} needs ${gameState.runs + 1} runs to win`, 'milestone');
        
        // Show summary of first innings
        showInningsSummary();
        
        // Prompt for new batter and bowler
        showPlayerSelectionModal('batter', 'Select opening batter');
        showPlayerSelectionModal('bowler', 'Select opening bowler');
      } else {
        // Game over - show summary
        showMatchSummary();
      }
      
      // Save game state
      updateGameState();
    }

    // Show innings summary
    function showInningsSummary() {
      summaryModal.classList.add('active');
      
      // Generate summary content
      let summaryHTML = `
        <h2 style="text-align: center; margin-bottom: 20px;">First Innings Summary</h2>
        <div style="margin-bottom: 30px;">
          <h3 style="border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px;">Score</h3>
          <p style="text-align: center; font-size: 1.2rem;">
            ${gameState.battingTeam === 'player1' ? gameState.team1Name : gameState.team2Name}
          </p>
          <p style="text-align: center; font-size: 1.5rem; font-weight: bold; color: var(--accent-yellow);">
            ${gameState.runs}/${gameState.wickets} in ${gameState.overs}.${gameState.balls % 6} overs
          </p>
        </div>
      `;
      
      // Add top performers
      summaryHTML += `
        <div style="margin-bottom: 30px;">
          <h3 style="border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px;">Top Performers</h3>
          <p>Top Scorer: ${getTopScorer()}</p>
          <p>Best Bowler: ${getBestBowler()}</p>
        </div>
      `;
      
      // Add target for second innings
      summaryHTML += `
        <div style="text-align: center; margin-top: 30px;">
          <h3 style="color: var(--accent-yellow);">Target</h3>
          <p style="font-size: 1.2rem; font-weight: bold;">${gameState.runs + 1} runs</p>
        </div>
      `;
      
      summaryContentEl.innerHTML = summaryHTML;
    }

    // Show match summary
    function showMatchSummary() {
      matchSummary.style.display = 'block';
      
      // Set player of the match
      const allPlayers = [...gameState.players.player1, ...gameState.players.player2];
      const potm = allPlayers.reduce((best, player) => {
        const batRuns = gameState.battingTeam === 'player1' ? 
          (gameState.stats.player1[player]?.runs || 0) + (gameState.stats.player2[player]?.runs || 0) :
          (gameState.stats.player2[player]?.runs || 0) + (gameState.stats.player1[player]?.runs || 0);
        
        const bowlWkts = gameState.bowlingTeam === 'player1' ? 
          (gameState.stats.player1[player]?.wickets || 0) + (gameState.stats.player2[player]?.wickets || 0) :
          (gameState.stats.player2[player]?.wickets || 0) + (gameState.stats.player1[player]?.wickets || 0);
        
        const score = batRuns + (bowlWkts * 25);
        return score > best.score ? { player, score } : best;
      }, { player: null, score: 0 });
      
      if (potm.player) {
        potmName.textContent = potm.player;
        
        const stats = [];
        const batRuns = gameState.battingTeam === 'player1' ? 
          (gameState.stats.player1[potm.player]?.runs || 0) + (gameState.stats.player2[potm.player]?.runs || 0) :
          (gameState.stats.player2[potm.player]?.runs || 0) + (gameState.stats.player1[potm.player]?.runs || 0);
        
        const bowlWkts = gameState.bowlingTeam === 'player1' ? 
          (gameState.stats.player1[potm.player]?.wickets || 0) + (gameState.stats.player2[potm.player]?.wickets || 0) :
          (gameState.stats.player2[potm.player]?.wickets || 0) + (gameState.stats.player1[potm.player]?.wickets || 0);
        
        if (batRuns > 0) stats.push(`${batRuns} runs`);
        if (bowlWkts > 0) stats.push(`${bowlWkts} wickets`);
        
        potmStats.textContent = stats.join(', ');
      }
      
      // Set batting card
      let battingHTML = '';
      const battingTeam = gameState.battingTeam === 'player1' ? gameState.players.player1 : gameState.players.player2;
      battingTeam.forEach(player => {
        const stats = gameState.battingTeam === 'player1' ? 
          gameState.stats.player1[player] : 
          gameState.stats.player2[player];
        
        const outText = stats?.out ? 'out' : 'not out';
        battingHTML += `
          <div class="scorecard-row">
            <div class="scorecard-player">${player}</div>
            <div class="scorecard-stats">${stats?.runs || 0} (${stats?.balls || 0}) ${outText}</div>
          </div>
        `;
      });
      battingCard.innerHTML = battingHTML;
      
      // Set bowling card
      let bowlingHTML = '';
      const bowlingTeam = gameState.bowlingTeam === 'player1' ? gameState.players.player1 : gameState.players.player2;
      bowlingTeam.forEach(player => {
        const stats = gameState.bowlingTeam === 'player1' ? 
          gameState.stats.player1[player] : 
          gameState.stats.player2[player];
        
        bowlingHTML += `
          <div class="scorecard-row">
            <div class="scorecard-player">${player}</div>
            <div class="scorecard-stats">${stats?.wickets || 0}/${stats?.conceded || 0} (${stats?.balls ? (Math.floor(stats.balls / 6) + (stats.balls % 6) / 10).toFixed(1) : '0.0'})</div>
          </div>
        `;
      });
      bowlingCard.innerHTML = bowlingHTML;
      
      // Set match result
      const winner = gameState.runs >= (gameState.runs + 1) ? gameState.battingTeam : gameState.bowlingTeam;
      const winnerName = winner === 'player1' ? gameState.team1Name : gameState.team2Name;
      const margin = gameState.runs >= (gameState.runs + 1) ? 
        `${gameState.players[gameState.battingTeam].length - gameState.wickets} wickets` : 
        `${(gameState.runs + 1) - gameState.runs} runs`;
      
      matchResult.textContent = `${winnerName} WON BY ${margin.toUpperCase()}`;
    }

    // Helper function to get top scorer
    function getTopScorer() {
      const stats = gameState.battingTeam === 'player1' ? gameState.stats.player1 : gameState.stats.player2;
      let topScorer = null;
      let maxRuns = -1;
      
      for (const player in stats) {
        if (stats[player].runs > maxRuns) {
          maxRuns = stats[player].runs;
          topScorer = player;
        }
      }
      
      return topScorer ? `${topScorer} (${maxRuns} runs)` : 'None';
    }

    // Helper function to get best bowler
    function getBestBowler() {
      const stats = gameState.bowlingTeam === 'player1' ? gameState.stats.player1 : gameState.stats.player2;
      let bestBowler = null;
      let bestWickets = -1;
      let bestEconomy = Infinity;
      
      for (const player in stats) {
        if (stats[player].wickets > bestWickets || 
            (stats[player].wickets === bestWickets && 
             (stats[player].conceded / stats[player].balls * 6) < bestEconomy)) {
          bestWickets = stats[player].wickets;
          bestEconomy = stats[player].conceded / stats[player].balls * 6;
          bestBowler = player;
        }
      }
      
      return bestBowler ? `${bestBowler} (${bestWickets} wickets)` : 'None';
    }

    // Show player selection modal
    function showPlayerSelectionModal(type, title) {
      modalTitleEl.textContent = title;
      modalPlayerListEl.innerHTML = '';
      
      // Get available players
      const team = type === 'batter' ? gameState.battingTeam : gameState.bowlingTeam;
      const players = gameState.players[team];
      const stats = gameState.stats[team];
      
      players.forEach(player => {
        // For batter selection, skip players who are already out
        if (type === 'batter' && stats[player]?.out) return;
        
        // For bowler selection, skip the current bowler if they've just finished an over
        if (type === 'bowler' && player === gameState.currentBowler && gameState.currentOver.length === 0) return;
        
        const li = document.createElement('li');
        li.className = 'player-list-item';
        
        if (type === 'batter') {
          const playerStats = stats[player] || { runs: 0, balls: 0 };
          li.innerHTML = `
            <div class="player-name">${player}</div>
            <div class="player-stats">${playerStats.runs} runs (${playerStats.balls} balls)</div>
          `;
        } else {
          const playerStats = stats[player] || { wickets: 0, conceded: 0, balls: 0 };
          const overs = Math.floor(playerStats.balls / 6) + (playerStats.balls % 6) / 10;
          li.innerHTML = `
            <div class="player-name">${player}</div>
            <div class="player-stats">${playerStats.wickets} wickets (${overs.toFixed(1)} overs)</div>
          `;
        }
        
        li.addEventListener('click', () => {
          document.querySelectorAll('.player-list-item').forEach(item => {
            item.classList.remove('selected');
          });
          li.classList.add('selected');
        });
        
        modalPlayerListEl.appendChild(li);
      });
      
      playerModal.classList.add('active');
    }

    // Select a player (batter or bowler)
    function selectPlayer(type, player) {
      if (type === 'batter') {
        gameState.currentBatter = player;
        addCommentary(`${player} comes to bat`, 'milestone');
      } else if (type === 'bowler') {
        gameState.currentBowler = player;
        addCommentary(`${player} comes to bowl`, 'milestone');
      }
      
      // Save selection to Firebase
      update(selectionRef, {
        player: playerRole,
        type: type,
        selectedPlayer: player,
        timestamp: Date.now()
      }).then(() => {
        updateGameState();
        updateUI();
      });
    }

    // Update game state in Firebase
    function updateGameState() {
      update(gameRef, {
        matchFormat: gameState.matchFormat,
        battingTeam: gameState.battingTeam,
        bowlingTeam: gameState.bowlingTeam,
        currentInnings: gameState.currentInnings,
        runs: gameState.runs,
        wickets: gameState.wickets,
        balls: gameState.balls,
        overs: gameState.overs,
        currentBatter: gameState.currentBatter,
        currentBowler: gameState.currentBowler,
        players: gameState.players,
        stats: gameState.stats,
        fallOfWickets: gameState.fallOfWickets,
        overHistory: gameState.overHistory,
        currentOver: gameState.currentOver,
        gameStarted: gameState.gameStarted,
        tossCompleted: gameState.tossCompleted,
        isPowerplay: gameState.isPowerplay,
        freeHit: gameState.freeHit,
        drsAvailable: gameState.drsAvailable,
        team1Name: gameState.team1Name,
        team2Name: gameState.team2Name,
        timeoutAvailable: gameState.timeoutAvailable,
        timeoutActive: gameState.timeoutActive
      }).catch(error => {
        console.error('Error updating game state:', error);
      });
    }

    // Handle timeout
    function handleTimeout() {
      if (!gameState.timeoutAvailable || gameState.timeoutActive) return;
      
      gameState.timeoutActive = true;
      gameState.timeoutAvailable = false;
      
      update(timeoutRef, {
        player: playerRole,
        active: true,
        timestamp: Date.now()
      }).then(() => {
        updateGameState();
        updateUI();
        addCommentary(`Timeout taken by ${playerRole === 'player1' ? gameState.team1Name : gameState.team2Name}`, 'milestone');
      });
      
      // End timeout after 2 minutes
      setTimeout(() => {
        gameState.timeoutActive = false;
        update(timeoutRef, {
          player: playerRole,
          active: false,
          timestamp: Date.now()
        }).then(() => {
          updateGameState();
          updateUI();
        });
      }, 120000);
    }

    // Add commentary
    function addCommentary(message, type = '') {
      if (gameState.commentaryPaused) return;
      
      const now = new Date();
      const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      const commentaryItem = document.createElement('div');
      commentaryItem.className = `commentary-item ${type}`;
      commentaryItem.innerHTML = `<span class="commentary-time">${timeString}</span>${message}`;
      
      commentaryBox.insertBefore(commentaryItem, commentaryBox.firstChild);
      
      if (commentaryBox.children.length > 50) {
        commentaryBox.removeChild(commentaryBox.lastChild);
      }
    }

    // Play sound
    function playSound(sound) {
      try {
        sound.currentTime = 0;
        sound.play();
      } catch (e) {
        console.log("Audio error:", e);
      }
    }

    // Show notification
    function showNotification(message, type = 'info') {
      const notif = document.createElement('div');
      notif.className = `notification ${type}`;
      notif.textContent = message;
      document.body.appendChild(notif);
      
      setTimeout(() => {
        notif.style.opacity = '0';
        setTimeout(() => notif.remove(), 500);
      }, 2500);
    }

    // Event listeners
    confirmSelectionBtn.addEventListener('click', () => {
      const selectedItem = document.querySelector('.player-list-item.selected');
      if (!selectedItem) {
        showNotification('Please select a player', 'error');
        return;
      }
      
      const playerName = selectedItem.querySelector('.player-name').textContent;
      const type = modalTitleEl.textContent.includes('batter') ? 'batter' : 'bowler';
      
      selectPlayer(type, playerName);
      playerModal.classList.remove('active');
    });
    
    closeModalBtn.addEventListener('click', () => {
      playerModal.classList.remove('active');
    });
    
    closeSummaryModalBtn.addEventListener('click', () => {
      summaryModal.classList.remove('active');
    });
    
    closeMatchSummary.addEventListener('click', () => {
      matchSummary.style.display = 'none';
    });
    
    saveExitBtn.addEventListener('click', () => {
      updateGameState();
      window.location.href = 'index.html';
    });
    
    exitBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });
    
    resetBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to reset all plays in this over?')) {
        gameState.currentOver = [];
        updateGameState();
        updateUI();
        addCommentary('Current over plays reset', 'milestone');
      }
    });
    
    summaryBtn.addEventListener('click', () => {
      if (gameState.currentInnings === 1) {
        showInningsSummary();
      } else {
        showMatchSummary();
      }
    });
    
    timeoutBtn.addEventListener('click', handleTimeout);
    
    pauseCommentaryBtn.addEventListener('click', () => {
      gameState.commentaryPaused = !gameState.commentaryPaused;
      pauseCommentaryBtn.textContent = gameState.commentaryPaused ? 'Resume' : 'Pause';
    });
    
    clearCommentaryBtn.addEventListener('click', () => {
      commentaryBox.innerHTML = '';
    });
    
    // Handle beforeunload
    window.addEventListener('beforeunload', () => {
      set(playerRef, {
        name: teamName,
        connected: false,
        lastActive: Date.now()
      });
    });
    
    // Initialize UI
    updateUI();
    
    // Start ambient crowd noise
    crowdSound.volume = 0.3;
    playSound(crowdSound);
  </script>
</body>
</html>